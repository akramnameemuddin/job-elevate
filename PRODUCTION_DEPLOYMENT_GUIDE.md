# Production Deployment Guide - JobElevate

## üö® Critical Issues Fixed

### 1. Email Sending Timeout (RESOLVED)
**Problem:** Gunicorn worker timeout causing signup failures on Render  
**Root Cause:** Render blocks SMTP ports (25, 465, 587) preventing Gmail SMTP  
**Solution:** Dual email configuration with SendGrid for production

### 2. Environment Variable Security (RESOLVED)
**Problem:** `.env` file with credentials was not in `.gitignore`  
**Root Cause:** Sensitive data could be committed to git  
**Solution:** Added `.env` patterns to `.gitignore`

---

## üìã Pre-Deployment Checklist

### ‚úÖ Security
- [x] `.env` file added to `.gitignore`
- [x] `.env.example` created with placeholders
- [ ] Remove `.env` from git history if previously committed
- [ ] Verify no credentials in public repository

### ‚úÖ Email Configuration
- [x] Updated `settings.py` with conditional email backend
- [x] Added timeout handling in `accounts/utils.py`
- [x] Added SendGrid to `requirements.txt`
- [ ] Sign up for SendGrid account
- [ ] Get SendGrid API key
- [ ] Add API key to Render environment variables

### ‚úÖ Server Configuration
- [x] Updated Procfile with increased Gunicorn timeout
- [x] Added worker count (2 workers)
- [ ] Deploy to Render
- [ ] Test signup flow

---

## üîß Configuration Changes Made

### 1. `.gitignore` Updates
Added the following patterns to protect sensitive files:
```gitignore
# Environment variables
.env
.env.*
*.env
backend/backend/.env
```

### 2. Email Configuration (`settings.py`)
```python
# Email configuration with conditional backend
if DEBUG:
    # Local development - use Gmail SMTP
    EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
    EMAIL_HOST = 'smtp.gmail.com'
    EMAIL_PORT = 587
    EMAIL_USE_TLS = True
    EMAIL_HOST_USER = env('EMAIL_HOST_USER')
    EMAIL_HOST_PASSWORD = env('EMAIL_HOST_PASSWORD')
    DEFAULT_FROM_EMAIL = env('EMAIL_HOST_USER')
else:
    # Production - use SendGrid (or console as fallback)
    if env('SENDGRID_API_KEY', default=''):
        EMAIL_BACKEND = 'sendgrid_backend.SendgridBackend'
        SENDGRID_API_KEY = env('SENDGRID_API_KEY')
        DEFAULT_FROM_EMAIL = env('EMAIL_HOST_USER')
    else:
        # Fallback to console if no SendGrid key (for testing)
        EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'
        DEFAULT_FROM_EMAIL = 'noreply@jobelevate.com'

# Prevent email hanging
EMAIL_TIMEOUT = 10
```

### 3. Error Handling (`accounts/utils.py`)
Updated `send_email_otp` function:
- Added 10-second timeout
- Added TimeoutError exception handling
- Added console backend detection
- Returns boolean instead of raising exceptions

### 4. Gunicorn Configuration (`Procfile`)
```
web: gunicorn backend.backend.wsgi --timeout 120 --workers 2
```
- Increased timeout from 30s to 120s
- Added 2 workers for better concurrency

---

## üöÄ SendGrid Setup Instructions

### Step 1: Create SendGrid Account
1. Go to https://sendgrid.com/
2. Click "Start for Free"
3. Sign up with your email
4. **Free Tier:** 100 emails/day (sufficient for testing)

### Step 2: Get API Key
1. Log in to SendGrid dashboard
2. Navigate to **Settings** ‚Üí **API Keys**
3. Click **Create API Key**
4. Name: `JobElevate-Production`
5. Permissions: **Full Access** (or **Restricted** with Mail Send permission)
6. Click **Create & View**
7. **IMPORTANT:** Copy the API key immediately (you won't see it again!)

### Step 3: Verify Sender Email
1. Go to **Settings** ‚Üí **Sender Authentication**
2. Click **Verify a Single Sender**
3. Enter your details:
   - From Name: `JobElevate`
   - From Email: Your verified email (use same as `EMAIL_HOST_USER`)
   - Reply To: Same as From Email
4. Check your email and verify the sender

### Step 4: Add to Render Environment Variables
1. Go to Render dashboard
2. Select your JobElevate web service
3. Navigate to **Environment** tab
4. Click **Add Environment Variable**
5. Add the following:
   ```
   Key: SENDGRID_API_KEY
   Value: [paste your API key]
   ```
6. Ensure these variables exist:
   ```
   DEBUG=False
   EMAIL_HOST_USER=your_verified_sender@gmail.com
   SECRET_KEY=[your secret key]
   DATABASE_URL=[auto-generated by Render]
   ```

---

## üìù Environment Variables Reference

### Required Variables for Local Development (`.env`)
```env
SECRET_KEY=your-django-secret-key
DEBUG=True
DATABASE_URL=sqlite:///db.sqlite3
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password
SENDGRID_API_KEY=  # Leave empty for local
```

### Required Variables for Production (Render)
```env
SECRET_KEY=your-production-secret-key
DEBUG=False
DATABASE_URL=postgresql://... (auto-generated)
EMAIL_HOST_USER=your-verified-sender@gmail.com
EMAIL_HOST_PASSWORD=  # Not used in production
SENDGRID_API_KEY=SG.xxxxxxxxxxxxx
```

---

## üß™ Testing Plan

### Local Testing (with Gmail)
```bash
cd c:\job-elevate\backend
python manage.py runserver
```
1. Visit http://localhost:8000/signup/
2. Complete signup form
3. Check console/email for OTP
4. Verify email sending works

### Production Testing (with SendGrid)
1. Deploy to Render with SendGrid API key
2. Visit https://jobelevates.akramnaeemuddin.me/signup/
3. Complete signup form
4. Check SendGrid dashboard for email activity
5. Check email inbox for OTP
6. Verify complete signup flow

---

## üîç Debugging Guide

### Check Email Logs in Production
```bash
# View Render logs
# Go to Render Dashboard ‚Üí JobElevate ‚Üí Logs tab
# Look for:
[EMAIL] Successfully sent OTP to user@example.com
[EMAIL] Timeout sending to user@example.com
[EMAIL] Failed to send OTP to user@example.com: [error message]
```

### Test Email Locally
```bash
cd c:\job-elevate\backend
python manage.py shell
```
```python
from django.core.mail import send_mail
from django.conf import settings

send_mail(
    'Test Email',
    'This is a test email from JobElevate',
    settings.DEFAULT_FROM_EMAIL,
    ['your-email@example.com'],
    fail_silently=False,
)
```

### Verify SendGrid Integration
1. Send a test email through signup
2. Check SendGrid Dashboard ‚Üí Activity
3. Look for email delivery status
4. Check for bounces or errors

---

## üö® Common Issues & Solutions

### Issue 1: "WORKER TIMEOUT" errors persist
**Cause:** Email still hanging despite timeout  
**Solution:** 
- Verify SendGrid API key is correct in Render
- Check SendGrid sender email is verified
- Ensure `DEBUG=False` in Render environment

### Issue 2: No emails received
**Cause:** SendGrid sender not verified  
**Solution:** 
- Go to SendGrid ‚Üí Sender Authentication
- Verify the sender email address
- Check spam folder

### Issue 3: "Authentication failed" from SendGrid
**Cause:** Invalid or expired API key  
**Solution:** 
- Generate new API key in SendGrid
- Update `SENDGRID_API_KEY` in Render
- Redeploy application

### Issue 4: Local development not sending emails
**Cause:** Gmail app password incorrect  
**Solution:** 
- Go to Google Account ‚Üí Security ‚Üí 2-Step Verification
- Generate new App Password
- Update `EMAIL_HOST_PASSWORD` in `.env`

---

## üì¶ Deployment Steps

### Step 1: Commit Changes
```bash
cd c:\job-elevate
git add .
git commit -m "Fix production email with SendGrid + increase Gunicorn timeout"
git push origin main
```

### Step 2: Install Dependencies (if deploying manually)
```bash
cd backend
pip install -r ../requirements.txt
```

### Step 3: Configure Render
1. Automatic deployment should trigger on push
2. Or manually deploy: Dashboard ‚Üí JobElevate ‚Üí Manual Deploy ‚Üí Deploy Latest Commit

### Step 4: Monitor Deployment
1. Watch build logs in Render
2. Verify no errors during `pip install`
3. Check migrations run successfully
4. Wait for "Build successful" message

### Step 5: Test Production
1. Visit https://jobelevates.akramnaeemuddin.me/signup/
2. Complete signup form with real email
3. Check email for OTP
4. Complete verification
5. Verify user created in database

---

## üìä Files Modified

| File | Changes Made | Purpose |
|------|--------------|---------|
| `.gitignore` | Added `.env` patterns | Security: Prevent credential leaks |
| `settings.py` | Conditional email backend | Use Gmail locally, SendGrid in production |
| `accounts/utils.py` | Timeout + error handling | Prevent worker crashes on email failure |
| `requirements.txt` | Added `sendgrid==6.11.0` | Enable SendGrid integration |
| `backend/Procfile` | Updated Gunicorn command | Increase timeout, add workers |
| `.env.example` | Created template | Documentation for environment setup |

---

## ‚úÖ Success Criteria

- [x] Code changes committed
- [ ] SendGrid account created
- [ ] API key added to Render
- [ ] Sender email verified in SendGrid
- [ ] Application deployed to Render
- [ ] Signup flow tested successfully
- [ ] Email OTP received and working
- [ ] No WORKER TIMEOUT errors in logs
- [ ] User can complete registration

---

## üÜò Support

If you encounter issues:

1. **Check Render Logs:** Dashboard ‚Üí JobElevate ‚Üí Logs
2. **SendGrid Activity:** SendGrid Dashboard ‚Üí Activity Feed
3. **Local Testing:** Run `python manage.py runserver` and test locally
4. **Environment Variables:** Verify all required vars set in Render

---

## üìö Additional Resources

- [SendGrid Documentation](https://docs.sendgrid.com/)
- [Django Email Documentation](https://docs.djangoproject.com/en/5.0/topics/email/)
- [Render Deploy Guides](https://render.com/docs)
- [Gunicorn Configuration](https://docs.gunicorn.org/en/stable/settings.html)

---

**Last Updated:** 2024  
**Status:** Ready for Production Deployment  
**Next Step:** Sign up for SendGrid and add API key to Render
