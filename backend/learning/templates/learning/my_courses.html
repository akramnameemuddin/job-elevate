{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}My Courses{% endblock %}

{% block content %}
<style>
/* ══════════════════════════════════════════════
   My Courses Page  (mc- namespace)
   ══════════════════════════════════════════════ */
.mc-stats {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    gap: 1rem; margin-bottom: 1.5rem;
}
.mc-stat {
    background: var(--card-bg); border: 1px solid var(--border-color);
    border-radius: 12px; padding: 1rem 1.25rem;
    display: flex; align-items: center; gap: .85rem;
    transition: transform .15s;
}
.mc-stat:hover { transform: translateY(-2px); }
.mc-stat-icon {
    width: 44px; height: 44px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.35rem; flex-shrink: 0;
}
.mc-stat-icon.active   { background: rgba(59,130,246,.12); color: #3b82f6; }
.mc-stat-icon.done     { background: rgba(34,197,94,.12); color: #22c55e; }
.mc-stat-icon.hours    { background: rgba(245,158,11,.12); color: #f59e0b; }
.mc-stat-icon.certs    { background: rgba(139,92,246,.12); color: #8b5cf6; }
.mc-stat h4 { font-size: .72rem; color: var(--text-muted); margin: 0 0 .1rem; text-transform: uppercase; letter-spacing: .4px; }
.mc-stat .val { font-size: 1.35rem; font-weight: 700; color: var(--heading-color); }

/* ── Filter tabs ── */
.mc-tabs {
    display: flex; gap: .5rem; margin-bottom: 1.25rem;
    border-bottom: 2px solid var(--border-color); padding-bottom: 0;
}
.mc-tab {
    padding: .55rem 1rem; font-size: .85rem; font-weight: 600;
    color: var(--text-muted); background: none; border: none;
    border-bottom: 2px solid transparent; margin-bottom: -2px;
    cursor: pointer; transition: all .15s; white-space: nowrap;
}
.mc-tab:hover { color: var(--heading-color); }
.mc-tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }

/* ── Course cards ── */
.mc-list { display: flex; flex-direction: column; gap: 1rem; }

.mc-card {
    background: var(--card-bg); border: 1px solid var(--border-color);
    border-radius: 14px; padding: 1.25rem 1.5rem;
    transition: all .2s; display: flex; flex-direction: column; gap: .85rem;
}
.mc-card:hover { border-color: var(--primary-color); box-shadow: 0 4px 16px rgba(0,0,0,.06); }

.mc-card-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
.mc-card-info { flex: 1; min-width: 0; }
.mc-card-info h3 {
    font-size: 1.05rem; font-weight: 600; color: var(--heading-color); margin: 0 0 .35rem;
}
.mc-card-meta { display: flex; flex-wrap: wrap; gap: .4rem; }
.mc-badge {
    font-size: .7rem; font-weight: 600; padding: .15rem .5rem;
    border-radius: 6px; white-space: nowrap;
}
.mc-badge.platform { background: rgba(79,70,229,.1); color: var(--primary-color); }
.mc-badge.skill    { background: var(--hover-bg); color: var(--text-color); }
.mc-badge.beginner      { background: rgba(34,197,94,.1); color: #16a34a; }
.mc-badge.intermediate  { background: rgba(245,158,11,.1); color: #d97706; }
.mc-badge.advanced      { background: rgba(239,68,68,.1); color: #dc2626; }

.mc-status-badge {
    font-size: .72rem; font-weight: 600; padding: .25rem .65rem;
    border-radius: 20px; display: flex; align-items: center; gap: .25rem;
    white-space: nowrap; flex-shrink: 0;
}
.mc-status-badge.completed { background: rgba(34,197,94,.1); color: #16a34a; }
.mc-status-badge.progress  { background: rgba(59,130,246,.1); color: #3b82f6; }

.mc-desc { font-size: .85rem; color: var(--text-muted); line-height: 1.5; }

/* Progress bar */
.mc-progress-wrap { display: flex; flex-direction: column; gap: .3rem; }
.mc-progress-head { display: flex; justify-content: space-between; align-items: center; }
.mc-progress-head span { font-size: .78rem; color: var(--text-muted); }
.mc-progress-pct { font-weight: 700; color: var(--primary-color); }
.mc-progress-bar {
    height: 8px; border-radius: 4px; background: var(--hover-bg); overflow: hidden;
}
.mc-progress-fill {
    height: 100%; border-radius: 4px;
    background: linear-gradient(90deg, var(--primary-color), #22c55e);
    transition: width .6s ease;
}

/* Stat row */
.mc-stat-row { display: flex; gap: 1.5rem; font-size: .8rem; color: var(--text-muted); }
.mc-stat-row span { display: flex; align-items: center; gap: .3rem; }

/* Card footer */
.mc-card-footer {
    display: flex; gap: .5rem; flex-wrap: wrap; padding-top: .65rem;
    border-top: 1px solid var(--border-color); margin-top: auto;
}
.mc-link-btn {
    width: 34px; height: 34px; border-radius: 8px;
    border: 1px solid var(--border-color); background: var(--card-bg);
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    font-size: 1rem; color: var(--text-muted); text-decoration: none;
    transition: all .15s;
}
.mc-link-btn:hover { border-color: var(--primary-color); color: var(--primary-color); }

/* ── Empty state ── */
.mc-empty {
    text-align: center; padding: 4rem 2rem;
    background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 14px;
}
.mc-empty i { font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem; display: block; }
.mc-empty h3 { font-size: 1.15rem; color: var(--heading-color); margin-bottom: .4rem; }
.mc-empty p { color: var(--text-muted); font-size: .9rem; margin-bottom: 1.25rem; }

/* ── Modal ── */
.mc-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,.45);
    z-index: 1040; align-items: center; justify-content: center;
}
.mc-overlay.open { display: flex; }
.mc-modal {
    background: var(--card-bg); border-radius: 14px; width: 90%; max-width: 420px;
    box-shadow: 0 16px 48px rgba(0,0,0,.15);
}
.mc-modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 1.15rem 1.5rem; border-bottom: 1px solid var(--border-color);
}
.mc-modal-header h3 { font-size: 1rem; font-weight: 600; color: var(--heading-color); margin: 0; }
.mc-modal-close {
    background: none; border: none; font-size: 1.3rem; cursor: pointer;
    color: var(--text-muted); transition: color .15s;
}
.mc-modal-close:hover { color: var(--heading-color); }
.mc-modal-body { padding: 1.5rem; }
.mc-modal-body p { font-size: .88rem; color: var(--text-muted); margin-bottom: 1rem; }
.mc-slider-val {
    text-align: center; font-size: 2rem; font-weight: 700;
    color: var(--primary-color); margin: .75rem 0 1rem;
}
.mc-modal-body input[type="range"] {
    width: 100%; accent-color: var(--primary-color);
}
.mc-modal-body label { display: flex; align-items: center; gap: .5rem; font-size: .85rem; cursor: pointer; color: var(--text-color); }
.mc-modal-footer {
    display: flex; justify-content: flex-end; gap: .5rem;
    padding: 1rem 1.5rem; border-top: 1px solid var(--border-color);
}
</style>

<!-- Breadcrumb -->
<div class="breadcrumb">
    <div class="breadcrumb-item">
        <a href="{% url 'dashboard:home' %}" class="breadcrumb-link">Home</a>
        <i class='bx bx-chevron-right'></i>
    </div>
    <div class="breadcrumb-item">
        <a href="{% url 'learning:learning_dashboard' %}" class="breadcrumb-link">Learning</a>
        <i class='bx bx-chevron-right'></i>
    </div>
    <div class="breadcrumb-item"><span>My Courses</span></div>
</div>

<!-- Page Header -->
<div class="page-content-header">
    <div>
        <h1 class="page-title"><i class='bx bx-book-bookmark' style="color:var(--primary-color)"></i> My Courses</h1>
        <p class="page-subtitle">Track your learning progress and continue where you left off</p>
    </div>
    <a href="{% url 'learning:course_catalog' %}" class="btn btn-primary btn-sm">
        <i class='bx bx-plus'></i> Browse Courses
    </a>
</div>

<!-- Stats -->
<div class="mc-stats">
    <div class="mc-stat">
        <div class="mc-stat-icon active"><i class='bx bx-book'></i></div>
        <div><h4>Active</h4><div class="val">{{ active_courses }}</div></div>
    </div>
    <div class="mc-stat">
        <div class="mc-stat-icon done"><i class='bx bx-check-circle'></i></div>
        <div><h4>Completed</h4><div class="val">{{ completed_courses }}</div></div>
    </div>
    <div class="mc-stat">
        <div class="mc-stat-icon hours"><i class='bx bx-time'></i></div>
        <div><h4>Hours Learned</h4><div class="val">{{ total_hours }}</div></div>
    </div>
    <div class="mc-stat">
        <div class="mc-stat-icon certs"><i class='bx bx-medal'></i></div>
        <div><h4>Certificates</h4><div class="val">{{ certificates_earned }}</div></div>
    </div>
</div>

<!-- Tabs -->
<div class="mc-tabs">
    <button class="mc-tab active" data-filter="all" onclick="mcFilter('all', this)">All ({{ progress_list.count }})</button>
    <button class="mc-tab" data-filter="in-progress" onclick="mcFilter('in-progress', this)">In Progress ({{ active_courses }})</button>
    <button class="mc-tab" data-filter="completed" onclick="mcFilter('completed', this)">Completed ({{ completed_courses }})</button>
</div>

<!-- Course List -->
<div class="mc-list" id="mcList">
    {% for progress in progress_list %}
    <div class="mc-card" data-status="{% if progress.status == 'completed' %}completed{% else %}in-progress{% endif %}">
        <div class="mc-card-top">
            <div class="mc-card-info">
                <h3>{{ progress.course.title }}</h3>
                <div class="mc-card-meta">
                    <span class="mc-badge platform">{{ progress.course.platform }}</span>
                    <span class="mc-badge skill">{{ progress.course.skill.name }}</span>
                    <span class="mc-badge {{ progress.course.difficulty_level }}">
                        {{ progress.course.get_difficulty_level_display }}
                    </span>
                </div>
            </div>
            {% if progress.status == 'completed' %}
            <span class="mc-status-badge completed"><i class='bx bx-check-circle'></i> Completed</span>
            {% else %}
            <span class="mc-status-badge progress"><i class='bx bx-time'></i> In Progress</span>
            {% endif %}
        </div>

        {% if progress.course.description %}
        <p class="mc-desc">{{ progress.course.description|truncatewords:30 }}</p>
        {% endif %}

        <div class="mc-progress-wrap">
            <div class="mc-progress-head">
                <span>Progress</span>
                <span class="mc-progress-pct">{{ progress.progress_percentage|floatformat:0 }}%</span>
            </div>
            <div class="mc-progress-bar">
                <div class="mc-progress-fill" style="width: {{ progress.progress_percentage|floatformat:0 }}%;"></div>
            </div>
        </div>

        <div class="mc-stat-row">
            <span><i class='bx bx-time'></i> {{ progress.time_spent_hours }}h of {{ progress.course.duration_hours }}h</span>
            {% if progress.last_accessed_at %}
            <span><i class='bx bx-calendar'></i> {{ progress.last_accessed_at|timesince }} ago</span>
            {% endif %}
        </div>

        <div class="mc-card-footer">
            {% if progress.status == 'completed' %}
                {% if progress.certificate_url %}
                <a href="{{ progress.certificate_url }}" target="_blank" class="btn btn-success btn-sm" style="font-size:.78rem;">
                    <i class='bx bx-medal'></i> Certificate
                </a>
                {% endif %}
                <button class="btn btn-outline-secondary btn-sm" style="font-size:.78rem;"
                        onclick="mcUpdateProgress({{ progress.id }}, 0)">
                    <i class='bx bx-revision'></i> Review Again
                </button>
            {% else %}
                <button class="btn btn-primary btn-sm" style="font-size:.78rem;"
                        onclick="mcContinue('{{ progress.course.url }}', {{ progress.id }})">
                    <i class='bx bx-play'></i> Continue
                </button>
                <button class="btn btn-outline-secondary btn-sm" style="font-size:.78rem;"
                        onclick="mcShowModal({{ progress.id }}, {{ progress.progress_percentage|floatformat:0 }})">
                    <i class='bx bx-edit'></i> Update
                </button>
            {% endif %}
            {% if progress.course.url %}
            <a href="{{ progress.course.url }}" target="_blank" class="mc-link-btn" title="Open on {{ progress.course.platform }}">
                <i class='bx bx-link-external'></i>
            </a>
            {% endif %}
        </div>
    </div>
    {% empty %}
    <div class="mc-empty">
        <i class='bx bx-book-open'></i>
        <h3>No Enrolled Courses</h3>
        <p>Start your learning journey by enrolling in courses from our catalog</p>
        <a href="{% url 'learning:course_catalog' %}" class="btn btn-primary">
            <i class='bx bx-search'></i> Browse Courses
        </a>
    </div>
    {% endfor %}
</div>

<!-- Progress Modal -->
<div class="mc-overlay" id="mcOverlay">
    <div class="mc-modal">
        <div class="mc-modal-header">
            <h3>Update Progress</h3>
            <button class="mc-modal-close" onclick="mcCloseModal()"><i class='bx bx-x'></i></button>
        </div>
        <div class="mc-modal-body">
            <p>How much of the course have you completed?</p>
            <input type="range" id="mcSlider" min="0" max="100" value="0" oninput="document.getElementById('mcSliderVal').textContent=this.value">
            <div class="mc-slider-val"><span id="mcSliderVal">0</span>%</div>
            <label>
                <input type="checkbox" id="mcComplete">
                Mark as completed
            </label>
        </div>
        <div class="mc-modal-footer">
            <button class="btn btn-outline-secondary btn-sm" onclick="mcCloseModal()">Cancel</button>
            <button class="btn btn-primary btn-sm" onclick="mcSave()">Save</button>
        </div>
    </div>
</div>

<script>
const MC_CSRF = '{{ csrf_token }}';
let mcProgressId = null;

function mcFilter(f, btn) {
    document.querySelectorAll('.mc-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.mc-card').forEach(c => {
        c.style.display = (f === 'all' || c.dataset.status === f) ? '' : 'none';
    });
}

function mcContinue(url, pid) {
    if (url) {
        fetch("{% url 'learning:update_course_progress' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': MC_CSRF, 'Content-Type': 'application/json' },
            body: JSON.stringify({ progress_id: pid, update_access: true })
        });
        window.open(url, '_blank');
    }
}

function mcShowModal(pid, cur) {
    mcProgressId = pid;
    document.getElementById('mcSlider').value = cur;
    document.getElementById('mcSliderVal').textContent = cur;
    document.getElementById('mcComplete').checked = cur >= 100;
    document.getElementById('mcOverlay').classList.add('open');
}
function mcCloseModal() {
    document.getElementById('mcOverlay').classList.remove('open');
    mcProgressId = null;
}

function mcSave() {
    const pct = document.getElementById('mcSlider').value;
    const done = document.getElementById('mcComplete').checked;
    mcUpdateProgress(mcProgressId, pct, done);
    mcCloseModal();
}

function mcUpdateProgress(pid, pct, done) {
    fetch("{% url 'learning:update_course_progress' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': MC_CSRF, 'Content-Type': 'application/json' },
        body: JSON.stringify({
            progress_id: pid,
            progress_percentage: pct,
            completed: done !== undefined ? done : pct >= 100
        })
    })
    .then(r => r.json())
    .then(d => { if (d.success) location.reload(); else alert('Error: ' + d.error); });
}
</script>
{% endblock %}
