{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Course Catalog{% endblock %}

{% block content %}
<style>
/* ══════════════════════════════════════════════
   Course Catalog Page  (cc- namespace)
   ══════════════════════════════════════════════ */
.cc-layout {
    display: grid; grid-template-columns: 260px 1fr; gap: 1.25rem;
}
@media(max-width: 960px) { .cc-layout { grid-template-columns: 1fr; } }

/* ── Filter sidebar ── */
.cc-sidebar {
    background: var(--card-bg); border: 1px solid var(--border-color);
    border-radius: 14px; padding: 1.15rem; height: fit-content;
    position: sticky; top: 1rem;
}
.cc-sidebar-head {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 1rem; padding-bottom: .75rem; border-bottom: 1px solid var(--border-color);
}
.cc-sidebar-head h3 { font-size: .95rem; font-weight: 600; color: var(--heading-color); margin: 0; }
.cc-clear-btn {
    font-size: .75rem; color: var(--primary-color); background: none; border: none;
    cursor: pointer; font-weight: 500;
}
.cc-clear-btn:hover { text-decoration: underline; }

.cc-filter-group { margin-bottom: 1.25rem; }
.cc-filter-group h4 {
    font-size: .82rem; font-weight: 600; color: var(--heading-color);
    display: flex; align-items: center; gap: .35rem;
    margin-bottom: .6rem;
}
.cc-filter-group h4 i { font-size: 1rem; color: var(--primary-color); }
.cc-filter-opts { display: flex; flex-direction: column; gap: .45rem; }
.cc-check {
    display: flex; align-items: center; gap: .45rem;
    font-size: .82rem; color: var(--text-color); cursor: pointer;
}
.cc-check input { accent-color: var(--primary-color); cursor: pointer; }

/* ── Main content area ── */
.cc-main { min-height: 400px; }
.cc-topbar {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 1rem;
}
.cc-results { font-size: .88rem; font-weight: 600; color: var(--heading-color); }
.cc-sort {
    padding: .4rem .7rem; font-size: .82rem; border: 1px solid var(--border-color);
    border-radius: 8px; background: var(--card-bg); color: var(--text-color); cursor: pointer;
}

/* ── Course cards grid ── */
.cc-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;
}

.cc-card {
    background: var(--card-bg); border: 1px solid var(--border-color);
    border-radius: 14px; padding: 1.25rem;
    display: flex; flex-direction: column; gap: .65rem;
    transition: all .2s;
}
.cc-card:hover { border-color: var(--primary-color); box-shadow: 0 4px 16px rgba(0,0,0,.06); transform: translateY(-2px); }

.cc-card-top {
    display: flex; justify-content: space-between; align-items: center;
}
.cc-platform {
    font-size: .7rem; font-weight: 600; padding: .15rem .5rem;
    border-radius: 6px; background: rgba(79,70,229,.1); color: var(--primary-color);
}
.cc-enrolled-badge {
    font-size: .7rem; font-weight: 600; color: #16a34a;
    display: flex; align-items: center; gap: .2rem;
}

.cc-card h3 {
    font-size: 1rem; font-weight: 600; color: var(--heading-color); margin: 0;
    line-height: 1.35;
}

.cc-card-meta { display: flex; flex-wrap: wrap; gap: .35rem; }
.cc-badge {
    font-size: .7rem; font-weight: 600; padding: .15rem .5rem; border-radius: 6px;
}
.cc-badge.skill { background: var(--hover-bg); color: var(--text-color); }
.cc-badge.beginner      { background: rgba(34,197,94,.1); color: #16a34a; }
.cc-badge.intermediate  { background: rgba(245,158,11,.1); color: #d97706; }
.cc-badge.advanced      { background: rgba(239,68,68,.1); color: #dc2626; }

.cc-desc {
    font-size: .84rem; color: var(--text-muted); line-height: 1.5;
    flex: 1;
}

.cc-card-stats {
    display: flex; gap: 1.25rem; padding: .6rem 0;
    border-top: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
    font-size: .8rem; color: var(--text-muted);
}
.cc-card-stats span { display: flex; align-items: center; gap: .3rem; }

.cc-card-footer { display: flex; gap: .5rem; margin-top: auto; }
.cc-card-footer .btn { flex: 1; font-size: .78rem; }
.cc-ext-link {
    width: 34px; height: 34px; border-radius: 8px;
    border: 1px solid var(--border-color); background: var(--card-bg);
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem; color: var(--text-muted); text-decoration: none;
    transition: all .15s; flex-shrink: 0;
}
.cc-ext-link:hover { border-color: var(--primary-color); color: var(--primary-color); }

/* ── Empty state ── */
.cc-empty {
    text-align: center; padding: 4rem 2rem; grid-column: 1 / -1;
    background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 14px;
}
.cc-empty i { font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem; display: block; }
.cc-empty h3 { font-size: 1.15rem; color: var(--heading-color); margin-bottom: .4rem; }
.cc-empty p { color: var(--text-muted); font-size: .88rem; }
</style>

<!-- Breadcrumb -->
<div class="breadcrumb">
    <div class="breadcrumb-item">
        <a href="{% url 'dashboard:home' %}" class="breadcrumb-link">Home</a>
        <i class='bx bx-chevron-right'></i>
    </div>
    <div class="breadcrumb-item">
        <a href="{% url 'learning:learning_dashboard' %}" class="breadcrumb-link">Learning</a>
        <i class='bx bx-chevron-right'></i>
    </div>
    <div class="breadcrumb-item"><span>Course Catalog</span></div>
</div>

<!-- Page Header -->
<div class="page-content-header">
    <div>
        <h1 class="page-title"><i class='bx bx-book-open' style="color:var(--primary-color)"></i> Course Catalog</h1>
        <p class="page-subtitle">Browse and enroll in courses to develop your skills</p>
    </div>
    <a href="{% url 'learning:my_courses' %}" class="btn btn-outline-secondary btn-sm">
        <i class='bx bx-book-bookmark'></i> My Courses
    </a>
</div>

<div class="cc-layout">
    <!-- ── Filter Sidebar ── -->
    <div class="cc-sidebar">
        <div class="cc-sidebar-head">
            <h3><i class='bx bx-filter-alt' style="font-size:1.1rem;"></i> Filters</h3>
            <button class="cc-clear-btn" onclick="ccClear()">Clear All</button>
        </div>

        <div class="cc-filter-group">
            <h4><i class='bx bx-category'></i> Skill</h4>
            <div class="cc-filter-opts">
                {% for skill in all_skills %}
                <label class="cc-check">
                    <input type="checkbox" name="cc_skill" value="{{ skill.id }}" onchange="ccApply()">
                    {{ skill.name }}
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="cc-filter-group">
            <h4><i class='bx bx-bar-chart'></i> Difficulty</h4>
            <div class="cc-filter-opts">
                <label class="cc-check"><input type="checkbox" name="cc_diff" value="beginner" onchange="ccApply()"> Beginner</label>
                <label class="cc-check"><input type="checkbox" name="cc_diff" value="intermediate" onchange="ccApply()"> Intermediate</label>
                <label class="cc-check"><input type="checkbox" name="cc_diff" value="advanced" onchange="ccApply()"> Advanced</label>
            </div>
        </div>

        <div class="cc-filter-group">
            <h4><i class='bx bx-world'></i> Platform</h4>
            <div class="cc-filter-opts">
                {% for platform in platforms %}
                <label class="cc-check">
                    <input type="checkbox" name="cc_platform" value="{{ platform }}" onchange="ccApply()">
                    {{ platform }}
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="cc-filter-group">
            <h4><i class='bx bx-filter'></i> Status</h4>
            <div class="cc-filter-opts">
                <label class="cc-check"><input type="checkbox" name="cc_status" value="enrolled" onchange="ccApply()"> My Courses</label>
                <label class="cc-check"><input type="checkbox" name="cc_status" value="available" onchange="ccApply()"> Available</label>
            </div>
        </div>
    </div>

    <!-- ── Courses Grid ── -->
    <div class="cc-main">
        <div class="cc-topbar">
            <span class="cc-results">Showing <span id="ccCount">{{ courses|length }}</span> courses</span>
            <select class="cc-sort" id="ccSort" onchange="ccSortCourses()">
                <option value="title">Title (A-Z)</option>
                <option value="newest">Newest First</option>
                <option value="difficulty">Difficulty</option>
            </select>
        </div>

        <div class="cc-grid" id="ccGrid">
            {% for course in courses %}
            <div class="cc-card"
                 data-skill="{{ course.skill.id }}"
                 data-difficulty="{{ course.difficulty_level }}"
                 data-platform="{{ course.platform }}"
                 data-enrolled="{% if course.id in enrolled_course_ids %}1{% else %}0{% endif %}"
                 data-title="{{ course.title|lower }}">

                <div class="cc-card-top">
                    <span class="cc-platform">{{ course.platform }}</span>
                    {% if course.id in enrolled_course_ids %}
                    <span class="cc-enrolled-badge"><i class='bx bx-check-circle'></i> Enrolled</span>
                    {% endif %}
                </div>

                <h3>{{ course.title }}</h3>

                <div class="cc-card-meta">
                    <span class="cc-badge skill">{{ course.skill.name }}</span>
                    <span class="cc-badge {{ course.difficulty_level }}">
                        {{ course.get_difficulty_level_display }}
                    </span>
                </div>

                <p class="cc-desc">{{ course.description|truncatewords:20 }}</p>

                <div class="cc-card-stats">
                    <span><i class='bx bx-time'></i> {{ course.duration_hours }}h</span>
                    <span><i class='bx bx-target-lock'></i> Level {{ course.target_proficiency_level }}/10</span>
                </div>

                <div class="cc-card-footer">
                    {% if course.id in enrolled_course_ids %}
                    <a href="{% url 'learning:my_courses' %}" class="btn btn-outline-secondary btn-sm">
                        <i class='bx bx-check-circle'></i> View Progress
                    </a>
                    {% else %}
                    <button class="btn btn-primary btn-sm" onclick="ccEnroll({{ course.id }})">
                        <i class='bx bx-plus'></i> Enroll
                    </button>
                    {% endif %}
                    {% if course.url %}
                    <a href="{{ course.url }}" target="_blank" class="cc-ext-link" title="View on {{ course.platform }}">
                        <i class='bx bx-link-external'></i>
                    </a>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="cc-empty">
                <i class='bx bx-book-open'></i>
                <h3>No Courses Found</h3>
                <p>Try adjusting your filters or check back later for new courses</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
const CC_CSRF = '{{ csrf_token }}';

function ccApply() {
    const sk = Array.from(document.querySelectorAll('input[name="cc_skill"]:checked')).map(e => e.value);
    const df = Array.from(document.querySelectorAll('input[name="cc_diff"]:checked')).map(e => e.value);
    const pl = Array.from(document.querySelectorAll('input[name="cc_platform"]:checked')).map(e => e.value);
    const st = Array.from(document.querySelectorAll('input[name="cc_status"]:checked')).map(e => e.value);

    let visible = 0;
    document.querySelectorAll('.cc-card').forEach(c => {
        let show = true;
        if (sk.length && !sk.includes(c.dataset.skill)) show = false;
        if (df.length && !df.includes(c.dataset.difficulty)) show = false;
        if (pl.length && !pl.includes(c.dataset.platform)) show = false;
        if (st.length) {
            const enrolled = c.dataset.enrolled === '1';
            if (st.includes('enrolled') && !enrolled) show = false;
            if (st.includes('available') && enrolled) show = false;
        }
        c.style.display = show ? '' : 'none';
        if (show) visible++;
    });
    document.getElementById('ccCount').textContent = visible;
}

function ccClear() {
    document.querySelectorAll('.cc-sidebar input[type="checkbox"]').forEach(cb => cb.checked = false);
    ccApply();
}

function ccSortCourses() {
    const sort = document.getElementById('ccSort').value;
    const grid = document.getElementById('ccGrid');
    const cards = Array.from(grid.querySelectorAll('.cc-card'));
    cards.sort((a, b) => {
        if (sort === 'title') return (a.dataset.title || '').localeCompare(b.dataset.title || '');
        return 0;
    });
    cards.forEach(c => grid.appendChild(c));
}

function ccEnroll(courseId) {
    fetch("{% url 'learning:enroll_course' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': CC_CSRF, 'Content-Type': 'application/json' },
        body: JSON.stringify({ course_id: courseId })
    })
    .then(r => r.json())
    .then(d => { if (d.success) location.reload(); else alert('Error: ' + d.error); });
}
</script>
{% endblock %}
