{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Browse Skills – JobElevate{% endblock %}

{% block content %}
<style>
/* ══════════════════════════════════════════════════
   Browse Skills  (bs- namespace)
   ══════════════════════════════════════════════════ */

/* ── Breadcrumb ── */
.bs-breadcrumb{display:flex;align-items:center;gap:.25rem;font-size:.85rem;color:var(--text-light);margin-bottom:.5rem}
.bs-breadcrumb a{color:var(--primary-color);text-decoration:none}
.bs-breadcrumb a:hover{text-decoration:underline}

/* ── Header ── */
.bs-header{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:1rem;margin-bottom:1.25rem}
.bs-header h1{font-size:1.4rem;font-weight:700;color:var(--heading-color);margin:0;display:flex;align-items:center;gap:.5rem}
.bs-header h1 i{color:var(--primary-color)}
.bs-subtitle{font-size:.88rem;color:var(--text-light);margin-top:.2rem}

/* ── Search / Filter Bar ── */
.bs-filter-bar{
    background:var(--card-bg);border:1px solid var(--border-color);border-radius:14px;
    padding:1rem 1.25rem;margin-bottom:1.5rem;display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;
    box-shadow:0 1px 3px rgba(0,0,0,.03);
}
.bs-search-wrap{
    flex:1;min-width:220px;display:flex;align-items:center;gap:.5rem;
    background:var(--hover-bg,rgba(0,0,0,.03));border:1px solid var(--border-color);
    border-radius:8px;padding:0 .75rem;transition:border-color .15s;
}
.bs-search-wrap:focus-within{border-color:var(--primary-color)}
.bs-search-wrap i{color:var(--text-light);font-size:1.1rem}
.bs-search-wrap input{
    flex:1;border:none;background:transparent;padding:.55rem 0;font-size:.88rem;
    color:var(--text-color);outline:none;
}
.bs-select{
    padding:.55rem .75rem;border:1px solid var(--border-color);border-radius:8px;
    background:var(--card-bg);color:var(--text-color);font-size:.85rem;min-width:160px;
}
.bs-btn{
    padding:.5rem .85rem;border-radius:8px;font-size:.82rem;font-weight:600;border:none;
    cursor:pointer;display:inline-flex;align-items:center;gap:.3rem;transition:all .15s;
    text-decoration:none;
}
.bs-btn-primary{background:var(--primary-color);color:#fff}
.bs-btn-primary:hover{opacity:.88}
.bs-btn-outline{background:none;border:1px solid var(--border-color);color:var(--text-color)}
.bs-btn-outline:hover{border-color:var(--primary-color);color:var(--primary-color)}

/* ── Job Required Skills Banner ── */
.bs-job-banner{
    background:var(--card-bg);border:2px solid var(--primary-color);border-radius:14px;
    padding:1.25rem 1.5rem;margin-bottom:1.5rem;
    border-left:5px solid var(--primary-color);
}
.bs-job-banner-head{display:flex;align-items:center;gap:.85rem;margin-bottom:1rem}
.bs-job-banner-icon{
    width:44px;height:44px;border-radius:10px;background:rgba(79,70,229,.1);color:var(--primary-color);
    display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0;
}
.bs-job-banner h2{font-size:1.1rem;font-weight:600;color:var(--heading-color);margin:0}
.bs-job-banner p{font-size:.85rem;color:var(--text-light);margin:.15rem 0 0}
.bs-job-banner-footer{
    margin-top:1.15rem;padding-top:1rem;border-top:1px solid var(--border-color);
    display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem;
}
.bs-job-banner-footer p{margin:0;font-size:.85rem;color:var(--text-light);display:flex;align-items:center;gap:.3rem}

/* ── Category Section ── */
.bs-category{margin-bottom:1.75rem}
.bs-category-head{
    display:flex;justify-content:space-between;align-items:center;
    padding-bottom:.75rem;margin-bottom:1rem;border-bottom:2px solid var(--border-color);
}
.bs-category-head h2{
    font-size:1.05rem;font-weight:600;color:var(--heading-color);margin:0;
    display:flex;align-items:center;gap:.4rem;
}
.bs-category-head h2 i{color:var(--primary-color)}
.bs-count-badge{
    padding:.2rem .6rem;border-radius:20px;font-size:.72rem;font-weight:600;
    background:rgba(79,70,229,.1);color:var(--primary-color);
}

/* ── Skills Grid ── */
.bs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1rem}
@media(max-width:720px){.bs-grid{grid-template-columns:1fr}}

/* ── Skill Card ── */
.bs-card{
    background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;
    padding:1.15rem 1.25rem;display:flex;flex-direction:column;gap:.55rem;
    transition:all .2s;
}
.bs-card:hover{border-color:var(--primary-color);box-shadow:0 4px 14px rgba(0,0,0,.05);transform:translateY(-1px)}
.bs-card.verified{border-color:#22c55e;background:linear-gradient(135deg,var(--card-bg),rgba(34,197,94,.04))}
.bs-card.claimed{border-color:#f59e0b;background:linear-gradient(135deg,var(--card-bg),rgba(245,158,11,.04))}
.bs-card.required{border-color:var(--primary-color)}

.bs-card-top{display:flex;justify-content:space-between;align-items:flex-start;gap:.5rem}
.bs-card-top h3{font-size:.98rem;font-weight:600;color:var(--heading-color);margin:0}
.bs-badge{
    padding:.18rem .55rem;border-radius:20px;font-size:.68rem;font-weight:600;
    display:inline-flex;align-items:center;gap:.2rem;white-space:nowrap;flex-shrink:0;
}
.bs-badge-success{background:rgba(34,197,94,.1);color:#16a34a}
.bs-badge-warning{background:rgba(245,158,11,.1);color:#d97706}
.bs-badge-primary{background:rgba(79,70,229,.1);color:var(--primary-color)}
.bs-badge-danger{background:rgba(239,68,68,.1);color:#ef4444}

.bs-card-desc{font-size:.84rem;color:var(--text-light);line-height:1.5;flex:1}

.bs-card-actions{display:flex;gap:.35rem;flex-wrap:wrap;margin-top:auto}
.bs-action{
    padding:.32rem .65rem;font-size:.78rem;border-radius:6px;border:none;
    cursor:pointer;font-weight:500;display:inline-flex;align-items:center;gap:.25rem;
    transition:all .15s;text-decoration:none;
}
.bs-action-primary{background:var(--primary-color);color:#fff}
.bs-action-primary:hover{opacity:.88}
.bs-action-outline{background:none;border:1px solid var(--border-color);color:var(--text-color)}
.bs-action-outline:hover{border-color:var(--primary-color);color:var(--primary-color)}

/* ── Empty State ── */
.bs-empty{
    text-align:center;padding:3.5rem 2rem;
    background:var(--card-bg);border:1px solid var(--border-color);border-radius:14px;
}
.bs-empty i{font-size:3.5rem;color:var(--text-light);display:block;margin-bottom:.75rem}
.bs-empty h3{font-size:1.1rem;color:var(--heading-color);margin:0 0 .35rem}
.bs-empty p{color:var(--text-light);font-size:.9rem;margin:0 0 1.25rem}

/* ── Notification ── */
.bs-notify{
    position:fixed;bottom:1.5rem;right:1.5rem;z-index:9999;
    padding:.75rem 1.25rem;border-radius:10px;font-weight:600;font-size:.88rem;
    display:flex;align-items:center;gap:.5rem;transform:translateY(100px);
    opacity:0;transition:all .3s ease;pointer-events:none;
}
.bs-notify.show{transform:translateY(0);opacity:1;pointer-events:auto}
.bs-notify.success{background:#22c55e;color:#fff}
.bs-notify.error{background:#ef4444;color:#fff}

/* ── Responsive ── */
@media(max-width:768px){
    .bs-header{flex-direction:column}
    .bs-filter-bar{flex-direction:column}
    .bs-search-wrap{min-width:100%}
    .bs-select{width:100%}
}
</style>

<!-- Breadcrumb -->
<div class="bs-breadcrumb">
    <a href="{% url 'dashboard:home' %}">Home</a>
    <i class='bx bx-chevron-right'></i>
    <a href="{% url 'assessments:skill_intake_dashboard' %}">Skills Diagnostic</a>
    <i class='bx bx-chevron-right'></i>
    <span>Browse Skills</span>
</div>

<!-- Header -->
<div class="bs-header">
    <div>
        <h1><i class='bx bx-search'></i> Browse All Skills</h1>
        <p class="bs-subtitle">Explore skills, add them to your profile, and take assessments to verify proficiency</p>
    </div>
</div>

<!-- Search & Filter -->
<form method="GET" class="bs-filter-bar">
    {% if job %}<input type="hidden" name="job" value="{{ job.id }}">{% endif %}
    <div class="bs-search-wrap">
        <i class='bx bx-search'></i>
        <input type="text" name="search" placeholder="Search skills…" value="{{ search_query }}">
    </div>
    <select name="category" class="bs-select" onchange="this.form.submit()">
        <option value="">All Categories</option>
        {% for cat in categories %}
        <option value="{{ cat.name }}" {% if category_filter == cat.name %}selected{% endif %}>{{ cat.name }}</option>
        {% endfor %}
    </select>
    <button type="submit" class="bs-btn bs-btn-primary"><i class='bx bx-filter'></i> Filter</button>
    {% if search_query or category_filter %}
    <a href="{% url 'assessments:browse_skills' %}{% if job %}?job={{ job.id }}{% endif %}" class="bs-btn bs-btn-outline">
        <i class='bx bx-x'></i> Clear
    </a>
    {% endif %}
</form>

<!-- Job Required Skills Banner -->
{% if required_skills and job %}
<div class="bs-job-banner">
    <div class="bs-job-banner-head">
        <div class="bs-job-banner-icon"><i class='bx bx-briefcase'></i></div>
        <div>
            <h2>Skills Required for: {{ job.title }}</h2>
            <p>Add these skills and take assessments to qualify for this job</p>
        </div>
    </div>
    <div class="bs-grid">
        {% for skill in required_skills %}
        <div class="bs-card {% if skill.is_verified %}verified{% elif skill.is_claimed %}claimed{% else %}required{% endif %}">
            <div class="bs-card-top">
                <h3>{{ skill.name }}</h3>
                {% if skill.is_verified %}
                    <span class="bs-badge bs-badge-success"><i class='bx bx-check-circle'></i> Verified</span>
                {% elif skill.is_claimed %}
                    <span class="bs-badge bs-badge-warning"><i class='bx bx-time'></i> Claimed</span>
                {% elif skill.not_in_db %}
                    <span class="bs-badge bs-badge-danger"><i class='bx bx-error-circle'></i> Not in System</span>
                {% else %}
                    <span class="bs-badge bs-badge-primary"><i class='bx bx-star'></i> Required</span>
                {% endif %}
            </div>
            <p class="bs-card-desc">{{ skill.description|default:"Required skill for this position." }}</p>
            <div class="bs-card-actions">
                {% if skill.not_in_db %}
                    <button class="bs-action bs-action-outline" disabled title="Contact admin to add this skill">
                        <i class='bx bx-error-circle'></i> Not Available
                    </button>
                {% elif skill.is_verified %}
                    <a href="{% url 'assessments:start_skill_assessment' skill.id %}" class="bs-action bs-action-outline">
                        <i class='bx bx-refresh'></i> Retake Assessment
                    </a>
                {% elif skill.is_claimed %}
                    <a href="{% url 'assessments:start_skill_assessment' skill.id %}" class="bs-action bs-action-primary">
                        <i class='bx bx-play'></i> Take Assessment
                    </a>
                {% else %}
                    <button class="bs-action bs-action-primary" onclick="claimSkill({{ skill.id }}, 5)">
                        <i class='bx bx-plus-circle'></i> Add & Assess
                    </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="bs-job-banner-footer">
        <p><i class='bx bx-info-circle'></i> Verify all required skills to increase your match score</p>
        <a href="{% url 'jobs:job_detail' job.id %}" class="bs-btn bs-btn-outline">
            <i class='bx bx-arrow-back'></i> Back to Job
        </a>
    </div>
</div>
{% endif %}

<!-- Skills by Category -->
{% if skills_by_category %}
    {% for category_name, skills in skills_by_category.items %}
    <div class="bs-category">
        <div class="bs-category-head">
            <h2><i class='bx bx-folder'></i> {{ category_name }}</h2>
            <span class="bs-count-badge">{{ skills|length }} skill{{ skills|length|pluralize }}</span>
        </div>
        <div class="bs-grid">
            {% for skill in skills %}
            <div class="bs-card {% if skill.is_verified %}verified{% elif skill.is_claimed %}claimed{% endif %}">
                <div class="bs-card-top">
                    <h3>{{ skill.name }}</h3>
                    {% if skill.is_verified %}
                        <span class="bs-badge bs-badge-success"><i class='bx bx-check-circle'></i> Verified</span>
                    {% elif skill.is_claimed %}
                        <span class="bs-badge bs-badge-warning"><i class='bx bx-time'></i> Claimed</span>
                    {% endif %}
                </div>
                <p class="bs-card-desc">
                    {{ skill.description|default:"Assess your proficiency in this skill through our AI-powered diagnostic test." }}
                </p>
                <div class="bs-card-actions">
                    {% if skill.is_verified %}
                        <a href="{% url 'assessments:start_skill_assessment' skill.id %}" class="bs-action bs-action-outline">
                            <i class='bx bx-refresh'></i> Retake Assessment
                        </a>
                    {% elif skill.is_claimed %}
                        <a href="{% url 'assessments:start_skill_assessment' skill.id %}" class="bs-action bs-action-primary">
                            <i class='bx bx-play'></i> Take Assessment
                        </a>
                    {% else %}
                        <button class="bs-action bs-action-primary" onclick="claimSkill({{ skill.id }})">
                            <i class='bx bx-plus-circle'></i> Add & Assess
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="bs-empty">
        <i class='bx bx-search-alt'></i>
        <h3>No Skills Found</h3>
        <p>Try adjusting your search or filter criteria</p>
        <a href="{% url 'assessments:browse_skills' %}" class="bs-btn bs-btn-primary" style="padding:.55rem 1.15rem;">
            <i class='bx bx-x'></i> Clear Filters
        </a>
    </div>
{% endif %}

<!-- Notification Toast -->
<div class="bs-notify" id="bs-notify"></div>

<script>
function showNotify(msg, type) {
    const el = document.getElementById('bs-notify');
    el.textContent = msg;
    el.className = 'bs-notify ' + type + ' show';
    setTimeout(() => el.classList.remove('show'), 3000);
}

function claimSkill(skillId) {
    fetch("{% url 'assessments:claim_skill' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ skill_id: skillId, self_rating: 5 })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showNotify('Skill claimed! Redirecting to assessment…', 'success');
            setTimeout(() => {
                window.location.href = `/assessments/start/${skillId}/`;
            }, 800);
        } else {
            showNotify(data.error || 'Failed to claim skill', 'error');
        }
    })
    .catch(err => {
        console.error(err);
        showNotify('Error claiming skill. Please try again.', 'error');
    });
}
</script>
{% endblock %}
