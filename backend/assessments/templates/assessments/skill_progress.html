{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Skill Progress - {{ skill_profile.skill.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">{{ skill_profile.skill.name }}</h2>
                    <p class="text-muted mb-0">Track your learning journey and improvement over time</p>
                </div>
                <a href="{% url 'assessments:skill_intake_dashboard' %}" class="btn btn-outline-primary">
                    <i class='bx bx-arrow-back me-1'></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Current Status Card -->
    <div class="row g-4 mb-4">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <h5 class="mb-4">
                        <i class='bx bx-line-chart me-2'></i>Current Proficiency
                    </h5>
                    <div class="row align-items-center">
                        <div class="col-md-5">
                            <div class="text-center">
                                <div class="proficiency-circle mb-3">
                                    <svg width="200" height="200">
                                        <circle cx="100" cy="100" r="85" fill="none" stroke="#e5e7eb" stroke-width="15"/>
                                        <circle cx="100" cy="100" r="85" fill="none" stroke="#3b82f6" stroke-width="15"
                                                stroke-dasharray="{{ 534|mul:skill_profile.verified_proficiency|div:10 }} 534"
                                                stroke-linecap="round" transform="rotate(-90 100 100)"/>
                                        <text x="100" y="110" text-anchor="middle" class="proficiency-score">
                                            {{ skill_profile.verified_proficiency|floatformat:1 }}
                                        </text>
                                    </svg>
                                </div>
                                {% if skill_profile.verified_proficiency >= 9 %}
                                <span class="badge badge-expert">Expert</span>
                                {% elif skill_profile.verified_proficiency >= 7 %}
                                <span class="badge badge-advanced">Advanced</span>
                                {% elif skill_profile.verified_proficiency >= 5 %}
                                <span class="badge badge-intermediate">Intermediate</span>
                                {% else %}
                                <span class="badge badge-beginner">Beginner</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="mb-4">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Basic Level</span>
                                    <strong>{{ skill_profile.basic_test_score|floatformat:0 }}%</strong>
                                </div>
                                <div class="progress mb-3" style="height: 10px;">
                                    <div class="progress-bar bg-primary" style="width: {{ skill_profile.basic_test_score }}%"></div>
                                </div>

                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Intermediate Level</span>
                                    <strong>{{ skill_profile.intermediate_test_score|floatformat:0 }}%</strong>
                                </div>
                                <div class="progress mb-3" style="height: 10px;">
                                    <div class="progress-bar bg-warning" style="width: {{ skill_profile.intermediate_test_score }}%"></div>
                                </div>

                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Advanced Level</span>
                                    <strong>{{ skill_profile.advanced_test_score|floatformat:0 }}%</strong>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-success" style="width: {{ skill_profile.advanced_test_score }}%"></div>
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="stat-box p-3 rounded">
                                        <small class="text-muted d-block mb-1">Experience</small>
                                        <strong class="fs-5">{{ skill_profile.years_of_experience }} years</strong>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-box p-3 rounded">
                                        <small class="text-muted d-block mb-1">Last Assessed</small>
                                        <strong class="fs-6">{{ skill_profile.last_assessed|date:"M d, Y" }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <h5 class="mb-4">
                        <i class='bx bx-medal me-2'></i>Achievements
                    </h5>
                    
                    <!-- Skill Status -->
                    <div class="achievement-item mb-3">
                        <div class="achievement-icon bg-success-light text-success">
                            <i class='bx bx-check-shield'></i>
                        </div>
                        <div>
                            <strong>Verified Skill</strong>
                            <small class="text-muted d-block">Assessment completed</small>
                        </div>
                    </div>

                    <!-- Experience Milestone -->
                    {% if skill_profile.years_of_experience >= 5 %}
                    <div class="achievement-item mb-3">
                        <div class="achievement-icon bg-primary-light text-primary">
                            <i class='bx bx-time-five'></i>
                        </div>
                        <div>
                            <strong>Experienced Professional</strong>
                            <small class="text-muted d-block">5+ years experience</small>
                        </div>
                    </div>
                    {% endif %}

                    <!-- High Proficiency -->
                    {% if skill_profile.verified_proficiency >= 8 %}
                    <div class="achievement-item mb-3">
                        <div class="achievement-icon bg-warning-light text-warning">
                            <i class='bx bx-trophy'></i>
                        </div>
                        <div>
                            <strong>Top Performer</strong>
                            <small class="text-muted d-block">8+ proficiency score</small>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Perfect Scores -->
                    {% if skill_profile.basic_test_score == 100 %}
                    <div class="achievement-item mb-3">
                        <div class="achievement-icon bg-info-light text-info">
                            <i class='bx bx-star'></i>
                        </div>
                        <div>
                            <strong>Perfect Basic</strong>
                            <small class="text-muted d-block">100% in basic level</small>
                        </div>
                    </div>
                    {% endif %}

                    <a href="{% url 'assessments:start_assessment_direct' skill_profile.skill.id %}" class="btn btn-outline-primary w-100 mt-3">
                        <i class='bx bx-refresh me-1'></i>Retake Assessment
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Assessment History -->
    {% if assessment_history %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
            <h5 class="mb-0">
                <i class='bx bx-history me-2'></i>Assessment History
            </h5>
        </div>
        <div class="card-body">
            <canvas id="progressChart" height="80"></canvas>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom">
            <h5 class="mb-0">Past Assessments</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Basic</th>
                            <th>Intermediate</th>
                            <th>Advanced</th>
                            <th>Overall Score</th>
                            <th>Change</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for history in assessment_history %}
                        <tr>
                            <td>{{ history.taken_at|date:"M d, Y" }}</td>
                            <td>
                                <span class="badge bg-primary">{{ history.basic_score|floatformat:0 }}%</span>
                            </td>
                            <td>
                                <span class="badge bg-warning">{{ history.intermediate_score|floatformat:0 }}%</span>
                            </td>
                            <td>
                                <span class="badge bg-success">{{ history.advanced_score|floatformat:0 }}%</span>
                            </td>
                            <td>
                                <strong>{{ history.overall_score|floatformat:1 }}/10</strong>
                            </td>
                            <td>
                                {% if history.change > 0 %}
                                <span class="text-success">
                                    <i class='bx bx-trending-up'></i> +{{ history.change|floatformat:1 }}
                                </span>
                                {% elif history.change < 0 %}
                                <span class="text-danger">
                                    <i class='bx bx-trending-down'></i> {{ history.change|floatformat:1 }}
                                </span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Related Jobs & Learning -->
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <h5 class="mb-3">
                        <i class='bx bx-briefcase me-2'></i>Jobs Requiring This Skill
                    </h5>
                    {% if matching_jobs %}
                    <div class="list-group list-group-flush">
                        {% for job in matching_jobs|slice:":5" %}
                        <a href="{% url 'jobs:job_detail_with_analysis' job.id %}" 
                           class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ job.title }}</h6>
                                    <small class="text-muted">{{ job.company }}</small>
                                </div>
                                <span class="badge bg-primary">{{ job.match_percentage|floatformat:0 }}% match</span>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    <a href="{% url 'jobs:recommendations_dashboard' %}" class="btn btn-outline-primary w-100 mt-3">
                        View All Job Recommendations
                    </a>
                    {% else %}
                    <p class="text-muted">No matching jobs found. Keep improving your skills!</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-4">
                    <h5 class="mb-3">
                        <i class='bx bx-book-open me-2'></i>Recommended Learning
                    </h5>
                    {% if learning_resources %}
                    <div class="list-group list-group-flush">
                        {% for resource in learning_resources|slice:":5" %}
                        <a href="{{ resource.url }}" class="list-group-item list-group-item-action" target="_blank">
                            <div class="d-flex align-items-start">
                                <i class='bx bx-book fs-4 text-primary me-3'></i>
                                <div>
                                    <h6 class="mb-1">{{ resource.title }}</h6>
                                    <small class="text-muted">{{ resource.type }} - {{ resource.duration }}</small>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    <a href="{% url 'learning:learning_paths_dashboard' %}" class="btn btn-outline-success w-100 mt-3">
                        View Personalized Learning Path
                    </a>
                    {% else %}
                    <div class="alert alert-info">
                        <i class='bx bx-info-circle me-2'></i>
                        Complete your assessment to get personalized learning recommendations
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.proficiency-circle {
    position: relative;
}

.proficiency-score {
    font-size: 2.5rem;
    font-weight: 700;
    fill: var(--text-color);
}

.badge-expert {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    padding: 0.5rem 1.5rem;
    font-size: 1rem;
    color: white;
}

.badge-advanced {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    padding: 0.5rem 1.5rem;
    font-size: 1rem;
    color: white;
}

.badge-intermediate {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    padding: 0.5rem 1.5rem;
    font-size: 1rem;
    color: white;
}

.badge-beginner {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    padding: 0.5rem 1.5rem;
    font-size: 1rem;
    color: white;
}

.stat-box {
    background-color: var(--gray-50);
    border: 1px solid var(--border-color);
}

.achievement-item {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.achievement-icon {
    width: 45px;
    height: 45px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.bg-success-light {
    background-color: var(--success-light);
}

.bg-primary-light {
    background-color: var(--primary-light);
}

.bg-warning-light {
    background-color: var(--warning-light);
}

.bg-info-light {
    background-color: var(--info-light);
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
{% if assessment_history %}
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('progressChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: [{% for h in assessment_history %}'{{ h.taken_at|date:"M d" }}'{% if not forloop.last %},{% endif %}{% endfor %}],
                datasets: [{
                    label: 'Overall Score',
                    data: [{% for h in assessment_history %}{{ h.overall_score }}{% if not forloop.last %},{% endif %}{% endfor %}],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
});
{% endif %}
</script>
{% endblock %}
