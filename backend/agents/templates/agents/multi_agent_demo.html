{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Multi-Agent Demo – JobElevate{% endblock %}

{% block content %}
<style>
/* ══════════════════════════════════════════════════
   Multi-Agent Demo  (ma- namespace)
   ══════════════════════════════════════════════════ */

/* ── Breadcrumb ── */
.ma-breadcrumb{display:flex;align-items:center;gap:.25rem;font-size:.85rem;color:var(--text-light);margin-bottom:.5rem}
.ma-breadcrumb a{color:var(--primary-color);text-decoration:none}
.ma-breadcrumb a:hover{text-decoration:underline}

/* ── Header ── */
.ma-header{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:1rem;margin-bottom:1.25rem}
.ma-header h1{font-size:1.4rem;font-weight:700;color:var(--heading-color);margin:0;display:flex;align-items:center;gap:.5rem}
.ma-header h1 i{color:var(--primary-color)}
.ma-subtitle{font-size:.88rem;color:var(--text-light);margin-top:.2rem}

/* ── Trigger Card ── */
.ma-trigger{
    background:linear-gradient(135deg,#6366f1 0%,var(--primary-color) 100%);
    color:#fff;border:none;border-radius:14px;padding:1.5rem 1.75rem;margin-bottom:1.5rem;
}
.ma-trigger h3{color:#fff;font-size:1.1rem;font-weight:600;margin:0 0 .65rem;display:flex;align-items:center;gap:.5rem}
.ma-trigger h3 i{font-size:1.3rem}
.ma-trigger p{opacity:.9;line-height:1.6;margin:0 0 1.15rem;font-size:.92rem}
.ma-trigger-form{display:flex;gap:1rem;align-items:end;flex-wrap:wrap}
.ma-trigger label{display:block;margin-bottom:.35rem;font-weight:600;color:rgba(255,255,255,.85);font-size:.88rem}
.ma-select{
    min-width:300px;padding:.6rem .85rem;border-radius:10px;font-size:.88rem;
    background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);
    color:#fff;backdrop-filter:blur(4px);
}
.ma-select option{color:var(--text-color);background:var(--card-bg)}
.ma-launch{
    padding:.6rem 1.35rem;background:#fff;color:#6366f1;border:none;
    border-radius:10px;cursor:pointer;font-weight:700;font-size:.92rem;
    display:inline-flex;align-items:center;gap:.5rem;transition:transform .15s,box-shadow .15s;
}
.ma-launch:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,0,0,.2)}

/* ── Card ── */
.ma-card{
    background:var(--card-bg);border:1px solid var(--border-color);border-radius:14px;
    padding:1.5rem;margin-bottom:1.25rem;box-shadow:0 1px 3px rgba(0,0,0,.03);
    transition:box-shadow .2s;
}
.ma-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.06)}
.ma-card h3{
    font-size:1.05rem;font-weight:600;color:var(--heading-color);margin:0 0 1rem;
    display:flex;align-items:center;gap:.5rem;
}
.ma-card h3 i{font-size:1.25rem;color:var(--primary-color)}

/* ── Timeline ── */
.ma-timeline{position:relative;padding-left:2.5rem}
.ma-timeline::before{
    content:'';position:absolute;left:1rem;top:0;bottom:0;width:3px;
    background:linear-gradient(to bottom,var(--primary-color),#6366f1);border-radius:2px;
}
.ma-tl-item{position:relative;padding-bottom:1.15rem}
.ma-tl-dot{
    position:absolute;left:-2rem;top:.2rem;width:14px;height:14px;border-radius:50%;
    border:3px solid var(--primary-color);background:var(--card-bg);transition:background .2s;
}
.ma-tl-item:hover .ma-tl-dot{background:var(--primary-color)}
.ma-tl-sender{font-weight:700;margin-right:.3rem;font-size:.88rem}
.ma-tl-arrow{opacity:.5;margin:0 .2rem}
.ma-tl-intent{
    font-family:'Fira Code',monospace;font-size:.78rem;background:var(--hover-bg);
    padding:.12rem .5rem;border-radius:6px;display:inline-block;margin-left:.3rem;
}
.ma-tl-time{font-size:.72rem;opacity:.5;margin-top:.1rem}

/* ── Tabs ── */
.ma-tabs{display:flex;gap:0;margin-bottom:1.5rem}
.ma-tab{
    padding:.7rem 1.5rem;border:1px solid var(--border-color);background:var(--card-bg);
    cursor:pointer;font-weight:600;font-size:.88rem;transition:all .2s;color:var(--text-color);
    display:inline-flex;align-items:center;gap:.35rem;
}
.ma-tab:first-child{border-radius:10px 0 0 10px}
.ma-tab:last-child{border-radius:0 10px 10px 0}
.ma-tab.active{background:linear-gradient(135deg,var(--primary-color),#6366f1);color:#fff;border-color:var(--primary-color)}
.ma-panel{display:none}
.ma-panel.active{display:block;animation:maFadeUp .35s ease both}

/* ── Badges ── */
.ma-badge{
    display:inline-flex;align-items:center;gap:.3rem;padding:.28rem .7rem;
    border-radius:20px;font-size:.78rem;font-weight:600;margin:.15rem;transition:transform .15s;
}
.ma-badge:hover{transform:scale(1.04)}
.ma-badge-critical{background:rgba(239,68,68,.1);color:#dc2626;border:1px solid rgba(239,68,68,.2)}
.ma-badge-develop{background:rgba(245,158,11,.1);color:#d97706;border:1px solid rgba(245,158,11,.2)}
.ma-badge-strength{background:rgba(34,197,94,.1);color:#059669;border:1px solid rgba(34,197,94,.2)}

/* ── Job Mini ── */
.ma-job-mini{
    display:flex;justify-content:space-between;align-items:center;
    padding:.75rem 1rem;border:1px solid var(--border-color);border-radius:12px;
    margin-bottom:.55rem;transition:all .2s;
}
.ma-job-mini:hover{border-color:var(--primary-color);transform:translateX(3px)}
.ma-job-score{font-size:1.15rem;font-weight:800}

/* ── Candidate Mini ── */
.ma-cand-mini{
    display:flex;justify-content:space-between;align-items:center;
    padding:.75rem 1rem;border-bottom:1px solid var(--border-color);
}
.ma-cand-mini:last-child{border-bottom:none}
.ma-cand-rank{
    width:28px;height:28px;border-radius:50%;display:flex;align-items:center;
    justify-content:center;font-size:.78rem;font-weight:700;color:#fff;margin-right:.7rem;flex-shrink:0;
}
.ma-rank-1{background:#f59e0b}.ma-rank-2{background:#9ca3af}
.ma-rank-3{background:#b45309}.ma-rank-d{background:var(--primary-color)}

/* ── Section Label ── */
.ma-sec-label{font-size:.88rem;font-weight:700;margin-bottom:.55rem;display:flex;align-items:center;gap:.35rem;color:var(--heading-color)}
.ma-sec-label i{font-size:1.05rem;color:var(--primary-color)}

/* ── Insight Highlight ── */
.ma-insight{
    padding:1rem 1.15rem;border-radius:12px;background:var(--hover-bg);
    line-height:1.7;font-size:.9rem;
}
.ma-insight strong{color:var(--primary-color)}

/* ── Roadmap Pill ── */
.ma-roadmap-pill{
    padding:.5rem 1rem;border-left:4px solid var(--primary-color);border-radius:0 10px 10px 0;
    background:var(--hover-bg);margin-bottom:.45rem;font-size:.88rem;
}

/* ── Step List ── */
.ma-steps{list-style:none;padding:0;counter-reset:masteps}
.ma-steps li{
    counter-increment:masteps;padding:.7rem 0 .7rem 3rem;position:relative;
    border-bottom:1px solid var(--border-color);font-size:.88rem;line-height:1.5;
}
.ma-steps li:last-child{border-bottom:none}
.ma-steps li::before{
    content:counter(masteps);position:absolute;left:.3rem;top:.55rem;
    width:1.8rem;height:1.8rem;border-radius:50%;
    background:linear-gradient(135deg,var(--primary-color),#6366f1);color:#fff;
    display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.78rem;
}

/* ── Feedback Pills ── */
.ma-pills{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.45rem}
.ma-pill{
    display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .7rem;
    border-radius:20px;font-size:.78rem;font-weight:600;
    background:rgba(99,102,241,.1);color:#6366f1;border:1px solid rgba(99,102,241,.2);
}

/* ── Loading ── */
.ma-loading{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9999;align-items:center;justify-content:center}
.ma-loading.active{display:flex}
.ma-loading-box{
    background:var(--card-bg);padding:2.5rem 3.5rem;border-radius:20px;
    text-align:center;box-shadow:0 25px 50px rgba(0,0,0,.15);
}
.ma-spinner{
    width:48px;height:48px;border:4px solid var(--border-color);
    border-top-color:var(--primary-color);border-radius:50%;
    animation:maSpin .7s linear infinite;margin:0 auto 1.25rem;
}
@keyframes maSpin{to{transform:rotate(360deg)}}
.ma-loading-box p{font-weight:600;font-size:1rem;color:var(--heading-color)}
.ma-loading-box small{display:block;margin-top:.35rem;opacity:.6;font-size:.85rem;color:var(--text-light)}

/* ── Fade ── */
.ma-fade{animation:maFadeUp .45s ease both}
@keyframes maFadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.ma-fade:nth-child(2){animation-delay:.08s}
.ma-fade:nth-child(3){animation-delay:.16s}

#ma-results{display:none}

/* ── Responsive ── */
@media(max-width:768px){
    .ma-trigger-form{flex-direction:column}
    .ma-select{min-width:100%;width:100%}
    .ma-tabs{flex-direction:column}
    .ma-tab:first-child{border-radius:10px 10px 0 0}
    .ma-tab:last-child{border-radius:0 0 10px 10px}
}
</style>

<!-- Breadcrumb -->
<div class="ma-breadcrumb">
    <a href="{% url 'dashboard:home' %}">Home</a>
    <i class='bx bx-chevron-right'></i>
    <span>Multi-Agent Demo</span>
</div>

<!-- Header -->
<div class="ma-header">
    <div>
        <h1><i class='bx bx-network-chart'></i> Multi-Agent Demo</h1>
        <p class="ma-subtitle">End-to-end pipeline showing both Career Coach and Recruiter agents working together</p>
    </div>
</div>

<!-- Loading -->
<div class="ma-loading" id="ma-loading">
    <div class="ma-loading-box">
        <div class="ma-spinner"></div>
        <p>Running full multi-agent pipeline…</p>
        <small>CareerGuidanceAgent &harr; RecruiterMatchingAgent</small>
    </div>
</div>

<!-- Trigger Card -->
<div class="ma-trigger">
    <h3><i class='bx bx-play-circle'></i> Run Full Multi-Agent Flow</h3>
    <p>This triggers both the <strong>CareerGuidanceAgent</strong> and the <strong>RecruiterMatchingAgent</strong>, passing messages between them, and returns a combined result showing both perspectives.</p>
    <form id="demo-form" method="post" class="ma-trigger-form">
        {% csrf_token %}
        <div>
            <label for="job_id">Target Job</label>
            <select name="job_id" id="job_id" class="ma-select" required>
                <option value="">— choose a job —</option>
                {% for j in jobs %}
                <option value="{{ j.id }}">{{ j.title }} @ {{ j.company }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="ma-launch"><i class='bx bx-network-chart'></i> Run Demo</button>
    </form>
</div>

<!-- Results -->
<div id="ma-results">
    <!-- Timeline -->
    <div class="ma-card ma-fade">
        <h3><i class='bx bx-conversation'></i> Agent Communication Log</h3>
        <div class="ma-timeline" id="ma-timeline"></div>
    </div>

    <!-- Tabs -->
    <div class="ma-tabs">
        <button class="ma-tab active" data-tab="student"><i class='bx bx-user'></i> Student View</button>
        <button class="ma-tab" data-tab="recruiter"><i class='bx bx-briefcase'></i> Recruiter View</button>
    </div>

    <!-- Student Panel -->
    <div class="ma-panel active" id="ma-tab-student">
        <div class="ma-card ma-fade">
            <h3><i class='bx bx-user'></i> Your Career Analysis</h3>
            <div class="ma-sec-label"><i class='bx bx-briefcase'></i> Recommended Jobs</div>
            <div id="ma-sv-jobs" style="margin-bottom:1.15rem;"></div>
            <div class="ma-sec-label"><i class='bx bx-bar-chart-alt-2'></i> Skill Analysis</div>
            <div id="ma-sv-gaps" style="margin-bottom:1.15rem;"></div>
            <div class="ma-sec-label"><i class='bx bx-book-open'></i> Learning Roadmap</div>
            <div id="ma-sv-roadmap" style="margin-bottom:1.15rem;"></div>
            <div class="ma-sec-label"><i class='bx bx-list-check'></i> Next Steps</div>
            <ol class="ma-steps" id="ma-sv-steps"></ol>
        </div>
        <div class="ma-card ma-fade">
            <h3><i class='bx bx-info-circle'></i> Recruiter Insights (for you)</h3>
            <div id="ma-sv-insights"></div>
        </div>
    </div>

    <!-- Recruiter Panel -->
    <div class="ma-panel" id="ma-tab-recruiter">
        <div class="ma-card ma-fade">
            <h3><i class='bx bx-trophy'></i> Candidate Rankings</h3>
            <div id="ma-rv-candidates"></div>
        </div>
        <div class="ma-card ma-fade">
            <h3><i class='bx bx-message-rounded-detail'></i> Feedback</h3>
            <div id="ma-rv-feedback"></div>
        </div>
    </div>
</div>

<!-- Past Timeline -->
{% if messages %}
<div class="ma-card">
    <h3><i class='bx bx-history'></i> Last Run Timeline (Run #{{ latest_run.id }})</h3>
    <div class="ma-timeline">
        {% for m in messages %}
        <div class="ma-tl-item">
            <div class="ma-tl-dot"></div>
            <span class="ma-tl-sender">{{ m.sender_agent }}</span>
            <span class="ma-tl-arrow">&rarr;</span>
            <span class="ma-tl-sender">{{ m.receiver_agent }}</span>
            <span class="ma-tl-intent">{{ m.intent }}</span>
            <div class="ma-tl-time">{{ m.created_at|date:"H:i:s" }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<script>
// Tabs
document.querySelectorAll('.ma-tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
        document.querySelectorAll('.ma-tab').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.ma-panel').forEach(p=>p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('ma-tab-'+btn.dataset.tab).classList.add('active');
    });
});

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function scoreColor(s){return s>=.7?'#22c55e':s>=.4?'#f59e0b':'#ef4444'}

document.getElementById('demo-form').addEventListener('submit',async function(e){
    e.preventDefault();
    document.getElementById('ma-loading').classList.add('active');
    const data=new FormData(e.target);
    try{
        const resp=await fetch(window.location.href,{method:'POST',body:data});
        if(!resp.ok) throw new Error('Server error ('+resp.status+')');
        const json=await resp.json();
        if(json.error){alert('Error: '+json.error);return;}
        renderDemo(json);
    }catch(err){
        alert('Error: '+err.message);
    }finally{
        document.getElementById('ma-loading').classList.remove('active');
    }
});

function renderDemo(data){
    const area=document.getElementById('ma-results');
    area.style.display='block';
    area.querySelectorAll('.ma-fade').forEach(el=>{el.style.animation='none';el.offsetHeight;el.style.animation='';});

    // Timeline
    if(data.run_id){
        fetch(`{% url 'agents:agent_run_detail' 0 %}`.replace('0',data.run_id))
        .then(r=>{if(!r.ok) throw new Error('Failed');return r.json();})
        .then(rd=>{
            document.getElementById('ma-timeline').innerHTML=(rd.messages||[]).map(m=>`
                <div class="ma-tl-item">
                    <div class="ma-tl-dot"></div>
                    <span class="ma-tl-sender">${m.sender_agent}</span>
                    <span class="ma-tl-arrow">&rarr;</span>
                    <span class="ma-tl-sender">${m.receiver_agent}</span>
                    <span class="ma-tl-intent">${m.intent}</span>
                    <div class="ma-tl-time">${m.created_at?new Date(m.created_at).toLocaleTimeString():''}</div>
                </div>
            `).join('')||'<p style="color:var(--text-light);">No messages recorded.</p>';
        });
    }

    // Student view
    const sv=data.student_view||{};
    const sa=sv.skill_analysis||{};

    // Jobs
    document.getElementById('ma-sv-jobs').innerHTML=(sv.recommended_jobs||[]).slice(0,3).map(j=>{
        const pct=(j.ml_score*100).toFixed(0);
        return `
        <div class="ma-job-mini">
            <div><strong>${esc(j.title)}</strong> <span style="opacity:.6;">@ ${esc(j.company)}</span></div>
            <div class="ma-job-score" style="color:${scoreColor(j.ml_score)}">${pct}%</div>
        </div>`;
    }).join('')||'<p style="color:var(--text-light);">No jobs found.</p>';

    // Gaps
    const mPct=sa.match_percentage||0;
    let gapHtml=`<div style="margin-bottom:.65rem;font-weight:700;font-size:.92rem;">Overall Match: <span style="color:var(--primary-color);">${mPct}%</span></div>`;
    gapHtml+=`<div style="display:flex;gap:.35rem;flex-wrap:wrap;">`;
    gapHtml+=(sa.critical_gaps||[]).map(g=>`<span class="ma-badge ma-badge-critical"><i class='bx bx-x-circle'></i> ${g.skill} (gap ${g.gap})</span>`).join('');
    gapHtml+=(sa.development_areas||[]).map(g=>`<span class="ma-badge ma-badge-develop"><i class='bx bx-up-arrow-alt'></i> ${g.skill} (gap ${g.gap})</span>`).join('');
    gapHtml+=(sa.strengths||[]).map(g=>`<span class="ma-badge ma-badge-strength"><i class='bx bx-check'></i> ${g.skill}</span>`).join('');
    gapHtml+=`</div>`;
    document.getElementById('ma-sv-gaps').innerHTML=gapHtml;

    // Roadmap
    document.getElementById('ma-sv-roadmap').innerHTML=(sv.learning_roadmap||[]).map(r=>
        `<div class="ma-roadmap-pill"><strong>${r.skill}</strong> — est. ${r.estimated_weeks||'?'} weeks</div>`
    ).join('')||'<p style="color:var(--text-light);">No roadmap generated.</p>';

    // Steps
    document.getElementById('ma-sv-steps').innerHTML=(sv.next_steps||[]).map(s=>`<li>${s}</li>`).join('');

    // Recruiter insights for student
    const ins=sv.recruiter_insights||{};
    let insHtml=`<div class="ma-insight">`;
    insHtml+=`Your rank among <strong>${ins.total_applicants||'?'}</strong> applicants: <strong>#${ins.your_rank||'?'}</strong>`;
    insHtml+=` (fit score: <strong>${ins.your_fit_score?(ins.your_fit_score*100).toFixed(0)+'%':'N/A'}</strong>)`;
    insHtml+=`</div>`;
    if(ins.key_differentiators&&ins.key_differentiators.length){
        insHtml+=`<p style="font-weight:600;margin-top:.75rem;margin-bottom:.35rem;"><i class='bx bx-star' style="color:#f59e0b;"></i> Key Skills That Matter</p>`;
        insHtml+=`<div class="ma-pills">${ins.key_differentiators.map(d=>`<span class="ma-pill"><i class='bx bx-check-circle'></i> ${d}</span>`).join('')}</div>`;
    }
    document.getElementById('ma-sv-insights').innerHTML=insHtml;

    // Recruiter view
    const rv=data.recruiter_view||{};
    const cands=rv.ranked_candidates||[];
    document.getElementById('ma-rv-candidates').innerHTML=cands.map((c,i)=>{
        const rank=i+1;
        const cls=rank===1?'ma-rank-1':rank===2?'ma-rank-2':rank===3?'ma-rank-3':'ma-rank-d';
        const pct=(c.fit_score*100).toFixed(0);
        return `
        <div class="ma-cand-mini">
            <div style="display:flex;align-items:center;">
                <div class="ma-cand-rank ${cls}">${rank}</div>
                <div>
                    <strong>${esc(c.full_name)}</strong>
                    ${c.explanation?`<div style="font-size:.82rem;color:var(--text-light);margin-top:.1rem;">${esc(c.explanation)}</div>`:''}
                </div>
            </div>
            <div style="font-weight:800;font-size:1.1rem;color:${scoreColor(c.fit_score)};">${pct}%</div>
        </div>`;
    }).join('')||'<p style="color:var(--text-light);">No applicants.</p>';

    const fb=rv.feedback||{};
    let fbHtml='';
    if(fb.summary) fbHtml+=`<div class="ma-insight">${fb.summary}</div>`;
    if(fb.key_differentiators&&fb.key_differentiators.length){
        fbHtml+=`<p style="font-weight:600;margin-top:.75rem;margin-bottom:.35rem;">Key Differentiators</p>`;
        fbHtml+=`<div class="ma-pills">${fb.key_differentiators.map(d=>`<span class="ma-pill">${d}</span>`).join('')}</div>`;
    }
    document.getElementById('ma-rv-feedback').innerHTML=fbHtml||'<p style="color:var(--text-light);">No feedback.</p>';

    area.scrollIntoView({behavior:'smooth',block:'start'});
}
</script>
{% endblock %}
