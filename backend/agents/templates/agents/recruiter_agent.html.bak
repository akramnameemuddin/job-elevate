{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}AI Recruiter Agent – JobElevate{% endblock %}

{% block content %}
<style>
/* ══════════════════════════════════════════════════
   AI Recruiter Agent  (ra- namespace)
   ══════════════════════════════════════════════════ */

/* ── Breadcrumb ── */
.ra-breadcrumb{display:flex;align-items:center;gap:.25rem;font-size:.85rem;color:var(--text-light);margin-bottom:.5rem}
.ra-breadcrumb a{color:var(--primary-color);text-decoration:none}
.ra-breadcrumb a:hover{text-decoration:underline}

/* ── Header ── */
.ra-header{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:1rem;margin-bottom:1.25rem}
.ra-header h1{font-size:1.4rem;font-weight:700;color:var(--heading-color);margin:0;display:flex;align-items:center;gap:.5rem}
.ra-header h1 i{color:var(--primary-color)}
.ra-subtitle{font-size:.88rem;color:var(--text-light);margin-top:.2rem}

/* ── Trigger Card ── */
.ra-trigger{
    background:linear-gradient(135deg,var(--primary-color) 0%,#6366f1 100%);
    color:#fff;border:none;border-radius:14px;padding:1.5rem 1.75rem;margin-bottom:1.5rem;
}
.ra-trigger h3{color:#fff;font-size:1.1rem;font-weight:600;margin:0 0 .65rem;display:flex;align-items:center;gap:.5rem}
.ra-trigger h3 i{font-size:1.3rem}
.ra-trigger p{opacity:.9;line-height:1.6;margin:0 0 1.15rem;font-size:.92rem}
.ra-trigger-form{display:flex;gap:1rem;align-items:end;flex-wrap:wrap}
.ra-trigger label{display:block;margin-bottom:.35rem;font-weight:600;color:rgba(255,255,255,.85);font-size:.88rem}
.ra-select{
    min-width:280px;padding:.6rem .85rem;border-radius:10px;font-size:.88rem;
    background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);
    color:#fff;backdrop-filter:blur(4px);
}
.ra-select option{color:var(--text-color);background:var(--card-bg)}
.ra-launch{
    padding:.6rem 1.35rem;background:#fff;color:var(--primary-color);border:none;
    border-radius:10px;cursor:pointer;font-weight:700;font-size:.92rem;
    display:inline-flex;align-items:center;gap:.5rem;transition:transform .15s,box-shadow .15s;
}
.ra-launch:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,0,0,.2)}
.ra-trigger-note{margin-top:1rem;opacity:.85;font-size:.85rem;display:flex;align-items:center;gap:.3rem}
.ra-trigger-note a{color:#fff;text-decoration:underline}

/* ── Card ── */
.ra-card{
    background:var(--card-bg);border:1px solid var(--border-color);border-radius:14px;
    padding:1.5rem;margin-bottom:1.25rem;box-shadow:0 1px 3px rgba(0,0,0,.03);
    transition:box-shadow .2s;
}
.ra-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.06)}
.ra-card h3{
    font-size:1.05rem;font-weight:600;color:var(--heading-color);margin:0 0 1rem;
    display:flex;align-items:center;gap:.5rem;
}
.ra-card h3 i{font-size:1.25rem;color:var(--primary-color)}

/* ── Candidate Card ── */
.ra-cand{
    display:flex;align-items:flex-start;gap:1.15rem;padding:1.15rem;
    border:1px solid var(--border-color);border-radius:12px;
    margin-bottom:.75rem;transition:all .2s;
}
.ra-cand:hover{border-color:var(--primary-color);background:var(--hover-bg);transform:translateX(3px)}

/* Score Ring */
.ra-ring{position:relative;width:60px;height:60px;flex-shrink:0}
.ra-ring svg{transform:rotate(-90deg);width:60px;height:60px}
.ra-ring-bg{fill:none;stroke:var(--border-color);stroke-width:5}
.ra-ring-fg{fill:none;stroke-width:5;stroke-linecap:round;transition:stroke-dashoffset .8s cubic-bezier(.4,0,.2,1)}
.ra-ring-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.88rem}
.ra-rank-num{
    position:absolute;top:-5px;right:-5px;width:22px;height:22px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;font-size:.68rem;font-weight:700;color:#fff;z-index:2;
}
.ra-rank-1{background:#f59e0b}.ra-rank-2{background:#9ca3af}
.ra-rank-3{background:#b45309}.ra-rank-d{background:var(--primary-color)}

.ra-cand-info{flex:1;min-width:0}
.ra-cand-name{font-weight:700;font-size:1rem;color:var(--heading-color)}
.ra-cand-type{font-size:.82rem;color:var(--text-light)}
.ra-cand-explain{font-size:.85rem;color:var(--text-light);margin-top:.35rem;line-height:1.5}

.ra-comp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:.55rem;margin-top:.75rem}
.ra-comp-chip{
    padding:.5rem .65rem;border-radius:10px;background:var(--hover-bg);text-align:center;
}
.ra-comp-val{font-size:1rem;font-weight:700;color:var(--primary-color)}
.ra-comp-lbl{font-size:.68rem;color:var(--text-light);text-transform:capitalize}

/* ── Skill Bars ── */
.ra-skill-row{display:flex;align-items:center;gap:1rem;padding:.65rem 0;border-bottom:1px solid var(--border-color)}
.ra-skill-row:last-child{border-bottom:none}
.ra-skill-name{min-width:100px;font-weight:600;font-size:.88rem}
.ra-skill-req{font-size:.78rem;color:var(--text-light);min-width:55px;text-align:right}
.ra-skill-bar{flex:1;height:8px;background:var(--border-color);border-radius:4px;overflow:hidden}
.ra-skill-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--primary-color),#6366f1);transition:width .8s}
.ra-diff-pct{font-size:.82rem;font-weight:700;min-width:45px;text-align:right}

/* ── Feedback ── */
.ra-feedback-summary{
    font-size:.92rem;line-height:1.7;padding:1rem 1.15rem;border-radius:10px;
    background:var(--hover-bg);margin-bottom:.85rem;
}
.ra-pills{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.5rem}
.ra-pill{
    display:inline-flex;align-items:center;gap:.3rem;padding:.28rem .7rem;
    border-radius:20px;font-size:.78rem;font-weight:600;
    background:rgba(99,102,241,.1);color:#6366f1;border:1px solid rgba(99,102,241,.2);
}

/* ── Empty State ── */
.ra-empty{text-align:center;padding:2.5rem 1rem}
.ra-empty i{font-size:3rem;color:var(--text-light);opacity:.4;display:block;margin-bottom:.75rem}
.ra-empty p{opacity:.6;font-size:.92rem}

/* ── History Table ── */
.ra-table{width:100%;border-collapse:collapse}
.ra-table th{
    padding:.65rem;text-align:left;font-size:.78rem;text-transform:uppercase;
    letter-spacing:.04em;color:var(--text-light);border-bottom:2px solid var(--border-color);
}
.ra-table td{padding:.65rem;border-bottom:1px solid var(--border-color)}
.ra-status{
    display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;
    border-radius:20px;font-size:.78rem;font-weight:600;
}
.ra-status-completed{background:rgba(34,197,94,.1);color:#16a34a}
.ra-status-failed{background:rgba(239,68,68,.1);color:#ef4444}
.ra-status-running{background:rgba(59,130,246,.1);color:#2563eb}

/* ── Loading ── */
.ra-loading{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9999;align-items:center;justify-content:center}
.ra-loading.active{display:flex}
.ra-loading-box{
    background:var(--card-bg);padding:2.5rem 3.5rem;border-radius:20px;
    text-align:center;box-shadow:0 25px 50px rgba(0,0,0,.15);
}
.ra-spinner{
    width:48px;height:48px;border:4px solid var(--border-color);
    border-top-color:var(--primary-color);border-radius:50%;
    animation:raSpin .7s linear infinite;margin:0 auto 1.25rem;
}
@keyframes raSpin{to{transform:rotate(360deg)}}
.ra-loading-box p{font-weight:600;font-size:1rem;color:var(--heading-color)}
.ra-loading-box small{display:block;margin-top:.35rem;opacity:.6;font-size:.85rem;color:var(--text-light)}

/* ── Fade-in ── */
.ra-fade{animation:raFadeUp .45s ease both}
@keyframes raFadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.ra-fade:nth-child(2){animation-delay:.08s}
.ra-fade:nth-child(3){animation-delay:.16s}

#ra-results{display:none}

/* ── Responsive ── */
@media(max-width:768px){
    .ra-trigger-form{flex-direction:column}
    .ra-select{min-width:100%;width:100%}
    .ra-cand{flex-direction:column;align-items:center;text-align:center}
    .ra-comp-grid{grid-template-columns:repeat(2,1fr)}
}
</style>

<!-- Breadcrumb -->
<div class="ra-breadcrumb">
    <a href="{% url 'dashboard:home' %}">Home</a>
    <i class='bx bx-chevron-right'></i>
    <span>AI Recruiter Agent</span>
</div>

<!-- Header -->
<div class="ra-header">
    <div>
        <h1><i class='bx bx-target-lock'></i> AI Recruiter Agent</h1>
        <p class="ra-subtitle">Rank applicants using AI-powered skill analysis and proficiency matching</p>
    </div>
</div>

<!-- Loading Overlay -->
<div class="ra-loading" id="ra-loading">
    <div class="ra-loading-box">
        <div class="ra-spinner"></div>
        <p>AI agent is ranking candidates…</p>
        <small>Analysing skills, assessments &amp; proficiency fit</small>
    </div>
</div>

<!-- Trigger Card -->
<div class="ra-trigger">
    <h3><i class='bx bx-search-alt'></i> Select a Job to Rank Applicants</h3>
    <p>The AI agent will evaluate all applicants using verified skills, assessment scores, and proficiency fit to produce a ranked shortlist.</p>
    <form id="recruiter-form" method="post" class="ra-trigger-form">
        {% csrf_token %}
        <div>
            <label for="job_id">Your Jobs</label>
            <select name="job_id" id="job_id" class="ra-select" required>
                <option value="">— choose a job —</option>
                {% for j in my_jobs %}
                <option value="{{ j.id }}" {% if job and job.id == j.id %}selected{% endif %}>
                    {{ j.title }} @ {{ j.company }} ({{ j.applicant_count }} applicants)
                </option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="ra-launch"><i class='bx bx-sort-alt-2'></i> Rank Candidates</button>
    </form>
    {% if not my_jobs %}
    <p class="ra-trigger-note"><i class='bx bx-info-circle'></i> You haven't posted any jobs yet. <a href="/recruiter/">Go to dashboard</a> to post a job first.</p>
    {% endif %}
</div>

<!-- Results Area -->
<div id="ra-results">
    <!-- Candidates -->
    <div class="ra-card ra-fade">
        <h3><i class='bx bx-trophy'></i> Candidate Rankings</h3>
        <div id="ra-candidates"></div>
    </div>

    <!-- Skill Importance -->
    <div class="ra-card ra-fade">
        <h3><i class='bx bx-bar-chart-alt-2'></i> Skill Importance</h3>
        <div id="ra-skills"></div>
    </div>

    <!-- Feedback -->
    <div class="ra-card ra-fade">
        <h3><i class='bx bx-message-rounded-detail'></i> Agent Feedback</h3>
        <div id="ra-feedback"></div>
    </div>
</div>

<!-- Recent Rankings -->
{% if recent_runs %}
<div class="ra-card">
    <h3><i class='bx bx-history'></i> Recent Rankings</h3>
    <table class="ra-table">
        <thead><tr><th>Run</th><th>Status</th><th>Date</th></tr></thead>
        <tbody>
        {% for run in recent_runs %}
        <tr>
            <td style="font-weight:600;">#{{ run.id }}</td>
            <td>
                <span class="ra-status {% if run.status == 'completed' %}ra-status-completed{% elif run.status == 'failed' %}ra-status-failed{% else %}ra-status-running{% endif %}">
                    <i class='bx {% if run.status == "completed" %}bx-check{% elif run.status == "failed" %}bx-x{% else %}bx-loader-alt{% endif %}'></i>
                    {{ run.status }}
                </span>
            </td>
            <td style="color:var(--text-light);font-size:.88rem;">{{ run.started_at|date:"M d, Y H:i" }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
function scoreColor(s){return s>=.7?'#22c55e':s>=.4?'#f59e0b':'#ef4444'}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

function ringHtml(score,rank){
    const pct=(score*100).toFixed(0);
    const c=28,r=25.5,circ=2*Math.PI*r;
    const offset=circ*(1-score);
    const color=scoreColor(score);
    const cls=rank===1?'ra-rank-1':rank===2?'ra-rank-2':rank===3?'ra-rank-3':'ra-rank-d';
    return `
    <div class="ra-ring">
        <svg viewBox="0 0 56 56">
            <circle class="ra-ring-bg" cx="${c}" cy="${c}" r="${r}"/>
            <circle class="ra-ring-fg" cx="${c}" cy="${c}" r="${r}"
                    stroke="${color}" stroke-dasharray="${circ}" stroke-dashoffset="${offset}"/>
        </svg>
        <div class="ra-ring-text" style="color:${color};">${pct}%</div>
        <div class="ra-rank-num ${cls}">${rank}</div>
    </div>`;
}

document.getElementById('recruiter-form').addEventListener('submit',async function(e){
    e.preventDefault();
    document.getElementById('ra-loading').classList.add('active');
    const data=new FormData(e.target);
    try{
        const resp=await fetch(window.location.href,{method:'POST',body:data});
        if(!resp.ok) throw new Error('Server error ('+resp.status+')');
        const json=await resp.json();
        if(json.error){alert('Error: '+json.error);return;}
        renderResults(json);
    }catch(err){
        alert('Error: '+err.message);
    }finally{
        document.getElementById('ra-loading').classList.remove('active');
    }
});

function renderResults(data){
    const area=document.getElementById('ra-results');
    area.style.display='block';
    area.querySelectorAll('.ra-fade').forEach(el=>{el.style.animation='none';el.offsetHeight;el.style.animation='';});

    // Candidates
    const cands=data.ranked_candidates||[];
    if(!cands.length){
        document.getElementById('ra-candidates').innerHTML=`<div class="ra-empty"><i class='bx bx-user-x'></i><p>No applicants for this job yet.</p></div>`;
    }else{
        document.getElementById('ra-candidates').innerHTML=cands.map((c,i)=>{
            const rank=i+1;
            const comps=c.score_components||{};
            return `
            <div class="ra-cand">
                ${ringHtml(c.fit_score,rank)}
                <div class="ra-cand-info">
                    <span class="ra-cand-name">${esc(c.full_name)}</span>
                    <span class="ra-cand-type">${esc(c.user_type)}</span>
                    ${c.explanation?`<div class="ra-cand-explain">${esc(c.explanation)}</div>`:''}
                    <div class="ra-comp-grid">
                        ${Object.entries(comps).map(([k,v])=>`
                            <div class="ra-comp-chip">
                                <div class="ra-comp-val">${(v*100).toFixed(0)}%</div>
                                <div class="ra-comp-lbl">${k.replace(/_/g,' ')}</div>
                            </div>`).join('')}
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    // Skill importance
    const si=data.skill_importance||[];
    if(!si.length){
        document.getElementById('ra-skills').innerHTML='<p style="color:var(--text-light);">No skill data.</p>';
    }else{
        const maxDiff=Math.max(...si.map(s=>s.differentiating_power),0.01);
        document.getElementById('ra-skills').innerHTML=si.map(s=>{
            const pct=((s.differentiating_power/maxDiff)*100).toFixed(0);
            const diffPct=(s.differentiating_power*100).toFixed(0);
            return `
            <div class="ra-skill-row">
                <span class="ra-skill-name">${s.skill}</span>
                <span class="ra-skill-req">req ${s.required_proficiency}/10</span>
                <div class="ra-skill-bar"><div class="ra-skill-fill" style="width:${pct}%;"></div></div>
                <span class="ra-diff-pct" style="color:${scoreColor(s.differentiating_power)};">${diffPct}%</span>
            </div>`;
        }).join('');
    }

    // Feedback
    const fb=data.feedback||{};
    let fbHtml='';
    if(fb.summary) fbHtml+=`<div class="ra-feedback-summary">${fb.summary}</div>`;
    if(fb.key_differentiators&&fb.key_differentiators.length){
        fbHtml+=`<p style="font-weight:600;margin-bottom:.5rem;"><i class='bx bx-star' style="color:#f59e0b;"></i> Key Differentiators</p>`;
        fbHtml+=`<div class="ra-pills">${fb.key_differentiators.map(d=>`<span class="ra-pill"><i class='bx bx-check-circle'></i> ${d}</span>`).join('')}</div>`;
    }
    if(fb.most_important_skills&&fb.most_important_skills.length){
        fbHtml+=`<p style="font-weight:600;margin:.75rem 0 .5rem;"><i class='bx bx-brain' style="color:#6366f1;"></i> Most Important Skills</p>`;
        fbHtml+=`<div class="ra-pills">${fb.most_important_skills.map(s=>`<span class="ra-pill" style="background:rgba(34,197,94,.1);color:#16a34a;border-color:rgba(34,197,94,.2);"><i class='bx bx-code-alt'></i> ${s}</span>`).join('')}</div>`;
    }
    document.getElementById('ra-feedback').innerHTML=fbHtml||'<p style="color:var(--text-light);">No feedback generated.</p>';

    area.scrollIntoView({behavior:'smooth',block:'start'});
}
</script>
{% endblock %}
