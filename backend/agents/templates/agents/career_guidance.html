{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}AI Career Coach – JobElevate{% endblock %}

{% block content %}
<style>
/* ══════════════════════════════════════════════════
   AI Career Coach  (cc- namespace)
   ══════════════════════════════════════════════════ */

/* ── Breadcrumb ── */
.cc-breadcrumb{display:flex;align-items:center;gap:.25rem;font-size:.85rem;color:var(--text-light);margin-bottom:.5rem}
.cc-breadcrumb a{color:var(--primary-color);text-decoration:none}
.cc-breadcrumb a:hover{text-decoration:underline}

/* ── Header ── */
.cc-header{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:1rem;margin-bottom:1.25rem}
.cc-header h1{font-size:1.4rem;font-weight:700;color:var(--heading-color);margin:0;display:flex;align-items:center;gap:.5rem}
.cc-header h1 i{color:var(--primary-color)}
.cc-subtitle{font-size:.88rem;color:var(--text-light);margin-top:.2rem}

/* ── Trigger Card ── */
.cc-trigger{
    background:linear-gradient(135deg,var(--primary-color) 0%,#6366f1 100%);
    color:#fff;border:none;border-radius:14px;padding:1.5rem 1.75rem;margin-bottom:1.5rem;
}
.cc-trigger h3{color:#fff;font-size:1.1rem;font-weight:600;margin:0 0 .65rem;display:flex;align-items:center;gap:.5rem}
.cc-trigger h3 i{font-size:1.3rem}
.cc-trigger p{opacity:.9;line-height:1.6;margin:0 0 1.15rem;font-size:.92rem}
.cc-trigger-form{display:flex;gap:1rem;align-items:end;flex-wrap:wrap}
.cc-trigger label{display:block;margin-bottom:.35rem;font-weight:600;color:rgba(255,255,255,.85);font-size:.88rem}
.cc-select{
    min-width:280px;padding:.6rem .85rem;border-radius:10px;font-size:.88rem;
    background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);
    color:#fff;backdrop-filter:blur(4px);
}
.cc-select option{color:var(--text-color);background:var(--card-bg)}
.cc-launch{
    padding:.6rem 1.35rem;background:#fff;color:var(--primary-color);border:none;
    border-radius:10px;cursor:pointer;font-weight:700;font-size:.92rem;
    display:inline-flex;align-items:center;gap:.5rem;transition:transform .15s,box-shadow .15s;
}
.cc-launch:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,0,0,.2)}

/* ── Card ── */
.cc-card{
    background:var(--card-bg);border:1px solid var(--border-color);border-radius:14px;
    padding:1.5rem;margin-bottom:1.25rem;box-shadow:0 1px 3px rgba(0,0,0,.03);
    transition:box-shadow .2s;
}
.cc-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.06)}
.cc-card h3{
    font-size:1.05rem;font-weight:600;color:var(--heading-color);margin:0 0 1rem;
    display:flex;align-items:center;gap:.5rem;
}
.cc-card h3 i{font-size:1.25rem;color:var(--primary-color)}

/* ── Badge ── */
.cc-badge{
    display:inline-flex;align-items:center;gap:.3rem;padding:.28rem .75rem;
    border-radius:20px;font-size:.78rem;font-weight:600;margin:.15rem;transition:transform .15s;
}
.cc-badge:hover{transform:scale(1.04)}
.cc-badge-critical{background:rgba(239,68,68,.1);color:#dc2626;border:1px solid rgba(239,68,68,.2)}
.cc-badge-develop{background:rgba(245,158,11,.1);color:#d97706;border:1px solid rgba(245,158,11,.2)}
.cc-badge-strength{background:rgba(34,197,94,.1);color:#059669;border:1px solid rgba(34,197,94,.2)}

/* ── Match Bar ── */
.cc-match-wrap{margin-top:.75rem}
.cc-match-label{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:.35rem;font-size:.95rem}
.cc-match-pct{font-size:1.4rem;font-weight:800;color:var(--primary-color)}
.cc-match-bar{height:10px;border-radius:5px;background:var(--border-color);overflow:hidden}
.cc-match-fill{height:100%;border-radius:5px;transition:width .8s cubic-bezier(.4,0,.2,1);
    background:linear-gradient(90deg,#ef4444 0%,#f59e0b 40%,#22c55e 100%)}

/* ── Job Card ── */
.cc-job{
    display:flex;justify-content:space-between;align-items:center;
    padding:1rem 1.15rem;border:1px solid var(--border-color);border-radius:12px;
    margin-bottom:.55rem;transition:all .2s;
}
.cc-job:hover{border-color:var(--primary-color);background:var(--hover-bg);transform:translateX(3px)}
.cc-job-meta{font-size:.82rem;color:var(--text-light);margin-top:.2rem}
.cc-job-score{text-align:right}
.cc-job-score .pct{font-size:1.3rem;font-weight:800}
.cc-job-score small{display:block;font-size:.68rem;text-transform:uppercase;letter-spacing:.04em;opacity:.6}

/* ── Roadmap Card ── */
.cc-roadmap{
    padding:1rem 1.15rem;border-left:4px solid var(--primary-color);border-radius:0 12px 12px 0;
    background:var(--hover-bg);margin-bottom:.55rem;transition:all .2s;
}
.cc-roadmap:hover{transform:translateX(3px);border-left-color:#6366f1}
.cc-roadmap strong{font-size:.92rem}
.cc-roadmap small{display:block;margin-top:.2rem;color:var(--text-light)}

/* ── Step List ── */
.cc-steps{list-style:none;padding:0;counter-reset:ccsteps}
.cc-steps li{
    counter-increment:ccsteps;padding:.8rem 0 .8rem 3.25rem;position:relative;
    border-bottom:1px solid var(--border-color);line-height:1.55;font-size:.9rem;transition:background .15s;
}
.cc-steps li:hover{background:var(--hover-bg)}
.cc-steps li:last-child{border-bottom:none}
.cc-steps li::before{
    content:counter(ccsteps);position:absolute;left:.4rem;top:.65rem;
    width:2rem;height:2rem;border-radius:50%;
    background:linear-gradient(135deg,var(--primary-color),#6366f1);color:#fff;
    display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.82rem;
}

/* ── Skill Columns ── */
.cc-skill-cols{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1.25rem}
.cc-skill-cols h4{margin-bottom:.65rem;font-size:.92rem;display:flex;align-items:center;gap:.35rem}

/* ── Cluster Pill ── */
.cc-cluster{
    display:inline-flex;align-items:center;gap:.5rem;padding:.65rem 1.15rem;border-radius:12px;
    background:linear-gradient(135deg,rgba(99,102,241,.08),rgba(59,130,246,.08));
    border:1px solid rgba(99,102,241,.2);font-weight:600;
}

/* ── History Table ── */
.cc-table{width:100%;border-collapse:collapse}
.cc-table th{
    padding:.65rem;text-align:left;font-size:.78rem;text-transform:uppercase;
    letter-spacing:.04em;color:var(--text-light);border-bottom:2px solid var(--border-color);
}
.cc-table td{padding:.65rem;border-bottom:1px solid var(--border-color)}
.cc-status{
    display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .6rem;
    border-radius:20px;font-size:.78rem;font-weight:600;
}
.cc-status-completed{background:rgba(34,197,94,.1);color:#16a34a}
.cc-status-failed{background:rgba(239,68,68,.1);color:#ef4444}
.cc-status-pending{background:rgba(59,130,246,.1);color:#2563eb}

/* ── Loading ── */
.cc-loading{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9999;align-items:center;justify-content:center}
.cc-loading.active{display:flex}
.cc-loading-box{
    background:var(--card-bg);padding:2.5rem 3.5rem;border-radius:20px;
    text-align:center;box-shadow:0 25px 50px rgba(0,0,0,.15);
}
.cc-spinner{
    width:48px;height:48px;border:4px solid var(--border-color);
    border-top-color:var(--primary-color);border-radius:50%;
    animation:ccSpin .7s linear infinite;margin:0 auto 1.25rem;
}
@keyframes ccSpin{to{transform:rotate(360deg)}}
.cc-loading-box p{font-weight:600;font-size:1rem;color:var(--heading-color)}
.cc-loading-box small{display:block;margin-top:.35rem;opacity:.6;font-size:.85rem;color:var(--text-light)}

/* ── Fade-in ── */
.cc-fade{animation:ccFadeUp .5s ease both}
@keyframes ccFadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.cc-fade:nth-child(2){animation-delay:.1s}
.cc-fade:nth-child(3){animation-delay:.2s}
.cc-fade:nth-child(4){animation-delay:.3s}
.cc-fade:nth-child(5){animation-delay:.4s}

#cc-results{display:none}

/* ── Responsive ── */
@media(max-width:768px){
    .cc-trigger-form{flex-direction:column}
    .cc-select{min-width:100%;width:100%}
    .cc-skill-cols{grid-template-columns:1fr}
}
</style>

<!-- Breadcrumb -->
<div class="cc-breadcrumb">
    <a href="{% url 'dashboard:home' %}">Home</a>
    <i class='bx bx-chevron-right'></i>
    <span>AI Career Coach</span>
</div>

<!-- Header -->
<div class="cc-header">
    <div>
        <h1><i class='bx bx-bot'></i> AI Career Coach</h1>
        <p class="cc-subtitle">AI-powered profile analysis, job matching, gap detection, and learning roadmaps</p>
    </div>
</div>

<!-- Loading Overlay -->
<div class="cc-loading" id="cc-loading">
    <div class="cc-loading-box">
        <div class="cc-spinner"></div>
        <p>AI agents are analysing your profile…</p>
        <small>Matching skills, computing gaps, building roadmap</small>
    </div>
</div>

<!-- Trigger Card -->
<div class="cc-trigger">
    <h3><i class='bx bx-bot'></i> Run Career Analysis</h3>
    <p>The AI Career Coach agent will analyse your profile, recommend matching jobs, identify skill gaps, and build a personalised learning roadmap.</p>
    <form id="career-form" method="post" class="cc-trigger-form">
        {% csrf_token %}
        <div>
            <label for="job_id">Target Job (optional)</label>
            <select name="job_id" id="job_id" class="cc-select">
                <option value="">— auto-select best match —</option>
                {% for j in available_jobs %}
                <option value="{{ j.id }}" {% if target_job and target_job.id == j.id %}selected{% endif %}>
                    {{ j.title }} @ {{ j.company }}
                </option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="cc-launch"><i class='bx bx-rocket'></i> Analyse My Career</button>
    </form>
</div>

<!-- Results Area -->
<div id="cc-results">
    <!-- Recommended Jobs -->
    <div class="cc-card cc-fade">
        <h3><i class='bx bx-briefcase'></i> Recommended Jobs</h3>
        <div id="cc-jobs"></div>
    </div>

    <!-- Skill Analysis -->
    <div class="cc-card cc-fade">
        <h3><i class='bx bx-bar-chart-alt-2'></i> Skill Gap Analysis</h3>
        <div id="cc-match"></div>
        <div class="cc-skill-cols" id="cc-skill-cols">
            <div>
                <h4><i class='bx bx-error-circle' style="color:#dc2626;"></i> Critical Gaps</h4>
                <div id="cc-critical"></div>
            </div>
            <div>
                <h4><i class='bx bx-trending-up' style="color:#d97706;"></i> Development Areas</h4>
                <div id="cc-develop"></div>
            </div>
            <div>
                <h4><i class='bx bx-check-shield' style="color:#059669;"></i> Strengths</h4>
                <div id="cc-strengths"></div>
            </div>
        </div>
    </div>

    <!-- Learning Roadmap -->
    <div class="cc-card cc-fade">
        <h3><i class='bx bx-book-open'></i> Learning Roadmap</h3>
        <div id="cc-roadmap"></div>
    </div>

    <!-- Next Steps -->
    <div class="cc-card cc-fade">
        <h3><i class='bx bx-list-check'></i> Recommended Next Steps</h3>
        <ol class="cc-steps" id="cc-steps"></ol>
    </div>

    <!-- Cluster -->
    <div class="cc-card cc-fade" id="cc-cluster-section" style="display:none;">
        <h3><i class='bx bx-group'></i> Your Career Cluster</h3>
        <div id="cc-cluster"></div>
    </div>
</div>

<!-- Recent Analyses -->
{% if recent_runs %}
<div class="cc-card">
    <h3><i class='bx bx-history'></i> Recent Analyses</h3>
    <table class="cc-table">
        <thead><tr><th>Run</th><th>Status</th><th>Date</th></tr></thead>
        <tbody>
        {% for run in recent_runs %}
        <tr>
            <td style="font-weight:600;">#{{ run.id }}</td>
            <td>
                <span class="cc-status {% if run.status == 'completed' %}cc-status-completed{% elif run.status == 'failed' %}cc-status-failed{% else %}cc-status-pending{% endif %}">
                    <i class='bx {% if run.status == "completed" %}bx-check{% elif run.status == "failed" %}bx-x{% else %}bx-loader-alt{% endif %}'></i>
                    {{ run.status }}
                </span>
            </td>
            <td style="color:var(--text-light);font-size:.88rem;">{{ run.started_at|date:"M d, Y H:i" }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function scoreColor(s){return s>=.7?'#22c55e':s>=.4?'#f59e0b':'#ef4444'}

document.getElementById('career-form').addEventListener('submit',async function(e){
    e.preventDefault();
    document.getElementById('cc-loading').classList.add('active');
    const data=new FormData(e.target);
    try{
        const resp=await fetch(e.target.action||window.location.href,{method:'POST',body:data});
        if(!resp.ok) throw new Error('Server error ('+resp.status+')');
        const json=await resp.json();
        if(json.error){alert('Error: '+json.error);return;}
        renderResults(json);
    }catch(err){
        alert('Error: '+err.message);
    }finally{
        document.getElementById('cc-loading').classList.remove('active');
    }
});

function renderResults(data){
    const area=document.getElementById('cc-results');
    area.style.display='block';
    area.querySelectorAll('.cc-fade').forEach(el=>{el.style.animation='none';el.offsetHeight;el.style.animation='';});

    // Jobs
    document.getElementById('cc-jobs').innerHTML=(data.recommended_jobs||[]).slice(0,5).map(j=>{
        const pct=(j.ml_score*100).toFixed(0);
        return `
        <div class="cc-job">
            <div>
                <strong>${esc(j.title)}</strong> <span style="opacity:.6;">@ ${esc(j.company)}</span>
                <div class="cc-job-meta">${esc(j.location||'')} · ${esc(j.job_type||'Full-time')} · ${j.experience_required||0}+ yrs</div>
            </div>
            <div class="cc-job-score">
                <div class="pct" style="color:${scoreColor(j.ml_score)}">${pct}%</div>
                <small>ML match</small>
            </div>
        </div>`;
    }).join('')||'<p style="color:var(--text-light);">No job recommendations available.</p>';

    // Skill analysis
    const sa=data.skill_analysis||{};
    const mPct=sa.match_percentage||0;
    document.getElementById('cc-match').innerHTML=`
        <div class="cc-match-wrap">
            <div class="cc-match-label"><span>Overall Match</span><span class="cc-match-pct">${mPct}%</span></div>
            <div class="cc-match-bar"><div class="cc-match-fill" style="width:${mPct}%;"></div></div>
        </div>`;

    document.getElementById('cc-critical').innerHTML=(sa.critical_gaps||[]).map(g=>
        `<span class="cc-badge cc-badge-critical"><i class='bx bx-x-circle'></i> ${g.skill} <small>(gap: ${g.gap})</small></span>`
    ).join('')||'<p style="color:var(--text-light);font-size:.88rem;">None — great job!</p>';

    document.getElementById('cc-develop').innerHTML=(sa.development_areas||[]).map(g=>
        `<span class="cc-badge cc-badge-develop"><i class='bx bx-up-arrow-alt'></i> ${g.skill} <small>(gap: ${g.gap})</small></span>`
    ).join('')||'<p style="color:var(--text-light);font-size:.88rem;">None</p>';

    document.getElementById('cc-strengths').innerHTML=(sa.strengths||[]).map(g=>
        `<span class="cc-badge cc-badge-strength"><i class='bx bx-check'></i> ${g.skill}</span>`
    ).join('')||'<p style="color:var(--text-light);font-size:.88rem;">—</p>';

    // Roadmap
    document.getElementById('cc-roadmap').innerHTML=(data.learning_roadmap||[]).map(r=>`
        <div class="cc-roadmap">
            <strong>${r.skill}</strong>${r.title?` — <span style="opacity:.7">${r.title}</span>`:''}
            <small><i class='bx bx-time-five'></i> Est. ${r.estimated_weeks||'?'} weeks${r.message?' · '+r.message:''}</small>
        </div>
    `).join('')||'<p style="color:var(--text-light);">No learning paths generated.</p>';

    // Steps
    document.getElementById('cc-steps').innerHTML=(data.next_steps||[]).map(s=>`<li>${s}</li>`).join('');

    // Cluster
    const ci=data.cluster_info||{};
    if(ci.label&&ci.label!=='Not yet classified'){
        document.getElementById('cc-cluster-section').style.display='block';
        document.getElementById('cc-cluster').innerHTML=`
            <div class="cc-cluster">
                <i class='bx bx-scatter-chart' style="font-size:1.2rem;color:var(--primary-color);"></i>
                You belong to the <strong>"${ci.label}"</strong> cluster (cluster #${ci.cluster})
            </div>`;
    }

    area.scrollIntoView({behavior:'smooth',block:'start'});
}
</script>
{% endblock %}
