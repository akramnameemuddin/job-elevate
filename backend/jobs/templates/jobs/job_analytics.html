{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Job Market Analytics{% endblock %}

{% block content %}
<style>
/* ══════════════════════════════════════════════
   Job Analytics Page  (ja- namespace)
   ══════════════════════════════════════════════ */
.ja-stats {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    gap: 1rem; margin-bottom: 1.75rem;
}
.ja-stat {
    background: var(--card-bg); border: 1px solid var(--border-color);
    border-radius: 12px; padding: 1rem 1.25rem;
    display: flex; align-items: center; gap: .85rem;
    transition: transform .15s;
}
.ja-stat:hover { transform: translateY(-2px); }
.ja-stat-icon {
    width: 44px; height: 44px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.35rem; flex-shrink: 0;
}
.ja-stat-icon.jobs    { background: rgba(79,70,229,.12); color: var(--primary-color); }
.ja-stat-icon.skills  { background: rgba(34,197,94,.12); color: #22c55e; }
.ja-stat-icon.loc     { background: rgba(59,130,246,.12); color: #3b82f6; }
.ja-stat-icon.overlap { background: rgba(245,158,11,.12); color: #f59e0b; }
.ja-stat h4 { font-size: .72rem; color: var(--text-muted); margin: 0 0 .1rem; text-transform: uppercase; letter-spacing: .4px; }
.ja-stat .val { font-size: 1.35rem; font-weight: 700; color: var(--heading-color); }

/* ── Grid layout ── */
.ja-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; margin-bottom: 1.25rem; }
@media(max-width:800px) { .ja-grid { grid-template-columns: 1fr; } }
.ja-full { grid-column: 1 / -1; }

.ja-card {
    background: var(--card-bg); border: 1px solid var(--border-color);
    border-radius: 14px; padding: 1.25rem 1.5rem; position: relative; overflow: hidden;
}
.ja-card-title {
    font-size: .95rem; font-weight: 600; color: var(--heading-color);
    margin: 0 0 1rem; display: flex; align-items: center; gap: .45rem;
}
.ja-card-title i { color: var(--primary-color); font-size: 1.15rem; }

/* ── Skill bar chart ── */
.ja-bar-list { display: flex; flex-direction: column; gap: .55rem; }
.ja-bar-item { display: flex; align-items: center; gap: .75rem; }
.ja-bar-rank {
    width: 22px; height: 22px; border-radius: 6px; font-size: .68rem;
    font-weight: 700; display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
}
.ja-bar-rank.top3 { background: rgba(245,158,11,.15); color: #f59e0b; }
.ja-bar-rank.rest { background: var(--hover-bg); color: var(--text-muted); }
.ja-bar-label {
    width: 100px; font-size: .82rem; font-weight: 500; color: var(--heading-color);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    text-transform: capitalize; flex-shrink: 0;
}
.ja-bar-track {
    flex: 1; height: 22px; background: var(--hover-bg); border-radius: 6px;
    overflow: hidden; position: relative;
}
.ja-bar-fill {
    height: 100%; border-radius: 6px;
    background: linear-gradient(90deg, var(--primary-color), #8b5cf6);
    transition: width .6s ease; display: flex; align-items: center;
    padding-left: .5rem; min-width: 28px;
}
.ja-bar-fill span {
    font-size: .68rem; font-weight: 600; color: #fff; white-space: nowrap;
}

/* ── Donut chart ── */
.ja-chart-wrap {
    display: flex; align-items: center; justify-content: center; gap: 1.5rem;
    padding: .25rem 0;
}
.ja-chart-canvas { max-width: 170px; max-height: 170px; }
.ja-chart-legend { display: flex; flex-direction: column; gap: .4rem; }
.ja-legend-item {
    display: flex; align-items: center; gap: .5rem;
    font-size: .82rem; color: var(--text-color);
}
.ja-legend-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }

/* ── Location cards ── */
.ja-loc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: .6rem; }
.ja-loc-card {
    background: var(--hover-bg); border-radius: 10px; padding: .75rem;
    text-align: center; transition: transform .15s;
}
.ja-loc-card:hover { transform: translateY(-2px); }
.ja-loc-card .city { font-size: .85rem; font-weight: 600; color: var(--heading-color); margin-bottom: .1rem; text-transform: capitalize; }
.ja-loc-card .count { font-size: .75rem; color: var(--text-muted); }

/* ── Recommendation cards ── */
.ja-rec-list { display: flex; flex-direction: column; gap: .6rem; }
.ja-rec-item {
    display: flex; align-items: center; gap: .8rem; padding: .7rem;
    background: var(--hover-bg); border-radius: 10px;
    transition: transform .15s;
}
.ja-rec-item:hover { transform: translateX(4px); }
.ja-rec-icon {
    width: 36px; height: 36px; border-radius: 10px;
    background: rgba(245,158,11,.12); color: #f59e0b;
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem; flex-shrink: 0;
}
.ja-rec-info { flex: 1; }
.ja-rec-info h4 { font-size: .85rem; font-weight: 600; color: var(--heading-color); margin: 0; text-transform: capitalize; }
.ja-rec-info p  { font-size: .75rem; color: var(--text-muted); margin: .1rem 0 0; }
.ja-rec-badge {
    font-size: .7rem; font-weight: 600; padding: .18rem .5rem;
    border-radius: 20px; background: rgba(239,68,68,.1); color: #ef4444;
    white-space: nowrap;
}

/* ── Overlap gauge ── */
.ja-gauge-wrap { display: flex; align-items: center; justify-content: center; padding: 1.5rem 0; }
.ja-gauge { position: relative; width: 140px; height: 140px; }
.ja-gauge svg { width: 140px; height: 140px; transform: rotate(-90deg); }
.ja-gauge-track { fill: none; stroke: var(--border-color); stroke-width: 10; }
.ja-gauge-fill  { fill: none; stroke-width: 10; stroke-linecap: round; transition: stroke-dashoffset .8s ease; }
.ja-gauge-text  {
    position: absolute; inset: 0; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
}
.ja-gauge-pct { font-size: 1.6rem; font-weight: 800; color: var(--heading-color); }
.ja-gauge-label { font-size: .72rem; color: var(--text-muted); }

/* ── Salary cards ── */
.ja-salary-list { display: flex; flex-direction: column; gap: .5rem; max-height: 260px; overflow-y: auto; }
.ja-salary-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: .6rem .75rem; background: var(--hover-bg); border-radius: 8px;
}
.ja-salary-title { font-size: .82rem; font-weight: 600; color: var(--heading-color); }
.ja-salary-co { font-size: .72rem; color: var(--text-muted); }
.ja-salary-amt {
    font-size: .82rem; font-weight: 700; color: #22c55e; white-space: nowrap;
}
</style>

<!-- Breadcrumb -->
<div class="breadcrumb">
    <div class="breadcrumb-item">
        <a href="{% url 'dashboard:home' %}" class="breadcrumb-link">Home</a>
        <i class='bx bx-chevron-right'></i>
    </div>
    <div class="breadcrumb-item">
        <a href="{% url 'jobs:job_listings' %}" class="breadcrumb-link">Jobs</a>
        <i class='bx bx-chevron-right'></i>
    </div>
    <div class="breadcrumb-item"><span>Market Analytics</span></div>
</div>

<!-- Page Header -->
<div class="page-content-header">
    <div>
        <h1 class="page-title"><i class='bx bx-bar-chart-alt-2' style="color:var(--primary-color)"></i> Job Market Analytics</h1>
        <p class="page-subtitle">Discover trends, in-demand skills, and where opportunities are growing</p>
    </div>
    <a href="{% url 'jobs:job_listings' %}" class="btn btn-outline-secondary btn-sm">
        <i class='bx bx-arrow-back'></i> Back to Jobs
    </a>
</div>

<!-- Stats -->
<div class="ja-stats">
    <div class="ja-stat">
        <div class="ja-stat-icon jobs"><i class='bx bx-briefcase'></i></div>
        <div><h4>Active Jobs</h4><div class="val">{{ total_jobs }}</div></div>
    </div>
    <div class="ja-stat">
        <div class="ja-stat-icon skills"><i class='bx bx-code-alt'></i></div>
        <div><h4>Top Skills Tracked</h4><div class="val">{{ top_skills|length }}</div></div>
    </div>
    <div class="ja-stat">
        <div class="ja-stat-icon loc"><i class='bx bx-map'></i></div>
        <div><h4>Hiring Locations</h4><div class="val">{{ top_locations|length }}</div></div>
    </div>
    <div class="ja-stat">
        <div class="ja-stat-icon overlap"><i class='bx bx-target-lock'></i></div>
        <div><h4>Your Skill Match</h4><div class="val">{{ skill_overlap_pct }}%</div></div>
    </div>
</div>

<div class="ja-grid">
    <!-- ─── Top Skills in Demand ─── -->
    <div class="ja-card">
        <h3 class="ja-card-title"><i class='bx bx-trending-up'></i> Top Skills in Demand</h3>
        {% if top_skills %}
        <div class="ja-bar-list">
            {% for skill, count in top_skills %}
            <div class="ja-bar-item">
                <span class="ja-bar-rank {% if forloop.counter <= 3 %}top3{% else %}rest{% endif %}">{{ forloop.counter }}</span>
                <span class="ja-bar-label">{{ skill }}</span>
                <div class="ja-bar-track">
                    <div class="ja-bar-fill" style="width: {% widthratio count top_skills.0.1 100 %}%;">
                        <span>{{ count }} job{{ count|pluralize }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align:center; color:var(--text-muted); padding:2rem 0;">No skill data available yet.</p>
        {% endif %}
    </div>

    <!-- ─── Job Type Distribution ─── -->
    <div class="ja-card">
        <h3 class="ja-card-title"><i class='bx bx-pie-chart-alt-2'></i> Job Type Distribution</h3>
        {% if job_type_distribution %}
        <div class="ja-chart-wrap">
            <canvas id="jobTypeChart" class="ja-chart-canvas"></canvas>
            <div class="ja-chart-legend" id="jobTypeLegend"></div>
        </div>
        {% else %}
        <p style="text-align:center; color:var(--text-muted); padding:2rem 0;">No distribution data yet.</p>
        {% endif %}
    </div>

    <!-- ─── Experience Level Breakdown ─── -->
    <div class="ja-card">
        <h3 class="ja-card-title"><i class='bx bx-bar-chart'></i> Experience Level Breakdown</h3>
        {% if experience_distribution %}
        <div class="ja-chart-wrap">
            <canvas id="expChart" class="ja-chart-canvas"></canvas>
            <div class="ja-chart-legend" id="expLegend"></div>
        </div>
        {% else %}
        <p style="text-align:center; color:var(--text-muted); padding:2rem 0;">No experience data yet.</p>
        {% endif %}
    </div>

    <!-- ─── Your Market Alignment ─── -->
    <div class="ja-card">
        <h3 class="ja-card-title"><i class='bx bx-analyse'></i> Your Market Alignment</h3>
        <div class="ja-gauge-wrap">
            <div class="ja-gauge">
                <svg viewBox="0 0 36 36">
                    <circle class="ja-gauge-track" cx="18" cy="18" r="15.9"/>
                    <circle class="ja-gauge-fill" cx="18" cy="18" r="15.9"
                        stroke-dasharray="{{ skill_overlap_pct }}, 100"
                        stroke="{% if skill_overlap_pct >= 70 %}#22c55e{% elif skill_overlap_pct >= 40 %}#f59e0b{% else %}#ef4444{% endif %}"/>
                </svg>
                <div class="ja-gauge-text">
                    <span class="ja-gauge-pct">{{ skill_overlap_pct }}%</span>
                    <span class="ja-gauge-label">Market Fit</span>
                </div>
            </div>
        </div>
        <p style="text-align:center; font-size:.82rem; color:var(--text-muted); margin-top:.5rem;">
            You have <strong>{{ user_skill_count }}</strong> skill{{ user_skill_count|pluralize }} —
            {% if skill_overlap_pct >= 70 %}great alignment with market demand!
            {% elif skill_overlap_pct >= 40 %}solid foundation, consider adding a few more.
            {% else %}learning a few trending skills could boost your matches.{% endif %}
        </p>
    </div>

    <!-- ─── Top Locations ─── -->
    <div class="ja-card">
        <h3 class="ja-card-title"><i class='bx bx-map-alt'></i> Top Hiring Locations</h3>
        {% if top_locations %}
        <div class="ja-loc-grid">
            {% for location, count in top_locations %}
            <div class="ja-loc-card">
                <div class="city"><i class='bx bx-map-pin' style="font-size:.9rem; color:var(--primary-color);"></i> {{ location }}</div>
                <div class="count">{{ count }} job{{ count|pluralize }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align:center; color:var(--text-muted); padding:2rem 0;">No location data yet.</p>
        {% endif %}
    </div>

    <!-- ─── Salary Insights ─── -->
    <div class="ja-card">
        <h3 class="ja-card-title"><i class='bx bx-money'></i> Salary Insights</h3>
        {% if salary_data %}
        <div class="ja-salary-list">
            {% for item in salary_data %}
            <div class="ja-salary-item">
                <div>
                    <div class="ja-salary-title">{{ item.title }}</div>
                    <div class="ja-salary-co">{{ item.company }}</div>
                </div>
                <span class="ja-salary-amt">{{ item.salary }}</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align:center; color:var(--text-muted); padding:2rem 0;">Salary data not available for current listings.</p>
        {% endif %}
    </div>

    <!-- ─── Skills You Should Learn (full width) ─── -->
    <div class="ja-card ja-full">
        <h3 class="ja-card-title"><i class='bx bx-bulb'></i> Recommended Skills to Learn</h3>
        {% if recommended_skills %}
        <div class="ja-rec-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:.6rem;">
            {% for rec in recommended_skills %}
            <div class="ja-rec-item">
                <div class="ja-rec-icon"><i class='bx bx-code-curly'></i></div>
                <div class="ja-rec-info">
                    <h4>{{ rec.skill }}</h4>
                    <p>Appears in {{ rec.demand_count }} active listing{{ rec.demand_count|pluralize }}</p>
                </div>
                <span class="ja-rec-badge">Gap</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align:center; color:var(--text-muted); padding:1.5rem 0;">
            <i class='bx bx-check-circle' style="font-size:1.5rem; color:#22c55e; display:block; margin-bottom:.5rem;"></i>
            You cover most in-demand skills. Keep it up!
        </p>
        {% endif %}
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
(function() {
    const COLORS = ['#4f46e5','#22c55e','#f59e0b','#ef4444','#3b82f6','#8b5cf6','#14b8a6','#f97316','#ec4899','#06b6d4'];
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#e5e7eb' : '#374151';

    function buildChart(canvasId, legendId, labels, data, type) {
        const ctx = document.getElementById(canvasId);
        if (!ctx || !labels.length) return;
        const colors = labels.map((_, i) => COLORS[i % COLORS.length]);
        new Chart(ctx, {
            type: type || 'doughnut',
            data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] },
            options: {
                responsive: true, maintainAspectRatio: true, cutout: '58%',
                plugins: { legend: { display: false } }
            }
        });
        const legend = document.getElementById(legendId);
        if (legend) {
            labels.forEach((l, i) => {
                legend.innerHTML += `<div class="ja-legend-item">
                    <span class="ja-legend-dot" style="background:${colors[i]}"></span>
                    ${l} <span style="font-weight:600;margin-left:auto">${data[i]}</span>
                </div>`;
            });
        }
    }

    /* Job type chart */
    {% if job_type_distribution %}
    buildChart('jobTypeChart', 'jobTypeLegend',
        [{% for jt in job_type_distribution %}'{{ jt.job_type }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        [{% for jt in job_type_distribution %}{{ jt.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
        'doughnut'
    );
    {% endif %}

    /* Experience chart */
    {% if experience_distribution %}
    buildChart('expChart', 'expLegend',
        [{% for e in experience_distribution %}'{{ e.level }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        [{% for e in experience_distribution %}{{ e.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
        'doughnut'
    );
    {% endif %}
})();
</script>
{% endblock %}
