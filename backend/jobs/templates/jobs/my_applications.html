{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}My Applications{% endblock %}

{% block content %}
<style>
/* ══════════════════════════════════════════════
   My Applications Page  (ma- namespace)
   ══════════════════════════════════════════════ */
.ma-stats {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    gap: 1rem; margin-bottom: 1.75rem;
}
.ma-stat {
    background: var(--card-bg); border: 1px solid var(--border-color);
    border-radius: 12px; padding: 1rem 1.25rem;
    display: flex; align-items: center; gap: .85rem;
    transition: transform .15s;
}
.ma-stat:hover { transform: translateY(-2px); }
.ma-stat-icon {
    width: 44px; height: 44px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.35rem; flex-shrink: 0;
}
.ma-stat-icon.total { background: rgba(79,70,229,.12); color: var(--primary-color); }
.ma-stat-icon.pending { background: rgba(245,158,11,.12); color: #f59e0b; }
.ma-stat-icon.interview { background: rgba(59,130,246,.12); color: #3b82f6; }
.ma-stat-icon.hired { background: rgba(34,197,94,.12); color: #22c55e; }
.ma-stat h4 { font-size: .75rem; color: var(--text-muted); margin: 0 0 .1rem; text-transform: uppercase; letter-spacing: .4px; }
.ma-stat .val { font-size: 1.35rem; font-weight: 700; color: var(--heading-color); }

.ma-filter-bar {
    background: var(--card-bg); border: 1px solid var(--border-color);
    border-radius: 12px; padding: .75rem 1.15rem;
    display: flex; align-items: center; gap: .75rem; margin-bottom: 1.25rem;
    flex-wrap: wrap;
}
.ma-search-wrap { flex: 1; min-width: 200px; position: relative; }
.ma-search-wrap i { position: absolute; left: .75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 1.1rem; }
.ma-search-wrap input {
    width: 100%; border: 1px solid var(--border-color); border-radius: 8px;
    padding: .5rem .75rem .5rem 2.2rem; font-size: .88rem;
    background: var(--bg-color); color: var(--text-color); transition: border-color .15s;
}
.ma-search-wrap input:focus { border-color: var(--primary-color); outline: none; }
.ma-filter-select {
    border: 1px solid var(--border-color); border-radius: 8px;
    padding: .5rem .75rem; font-size: .85rem;
    background: var(--bg-color); color: var(--text-color); cursor: pointer;
}
.ma-filter-select:focus { border-color: var(--primary-color); outline: none; }

.ma-list { display: flex; flex-direction: column; gap: .85rem; }

.ma-card {
    background: var(--card-bg); border: 1px solid var(--border-color);
    border-radius: 14px; padding: 1.25rem 1.5rem;
    display: grid; grid-template-columns: auto 1fr auto;
    align-items: center; gap: 1.25rem; transition: all .2s;
}
.ma-card:hover { border-color: var(--primary-color); box-shadow: 0 4px 16px rgba(0,0,0,.06); }

.ma-avatar {
    width: 50px; height: 50px; border-radius: 12px;
    background: linear-gradient(135deg, var(--primary-color), #6f42c1);
    color: #fff; font-weight: 700; font-size: 1.1rem;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; text-transform: uppercase;
}
.ma-info { min-width: 0; }
.ma-info h3 {
    font-size: 1.05rem; font-weight: 600; color: var(--heading-color);
    margin: 0 0 .2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.ma-info h3 a { color: inherit; text-decoration: none; }
.ma-info h3 a:hover { color: var(--primary-color); }
.ma-meta {
    display: flex; flex-wrap: wrap; gap: .3rem .85rem;
    font-size: .82rem; color: var(--text-muted);
}
.ma-meta span { display: flex; align-items: center; gap: .3rem; }
.ma-meta i { font-size: .95rem; }

.ma-badge {
    padding: .25rem .65rem; border-radius: 20px;
    font-size: .72rem; font-weight: 600; text-transform: uppercase;
    letter-spacing: .3px; white-space: nowrap;
}
.ma-badge-applied    { background: rgba(79,70,229,.1); color: var(--primary-color); }
.ma-badge-shortlisted { background: rgba(59,130,246,.1); color: #3b82f6; }
.ma-badge-interview   { background: rgba(245,158,11,.1); color: #d97706; }
.ma-badge-offered     { background: rgba(34,197,94,.1); color: #16a34a; }
.ma-badge-hired       { background: rgba(34,197,94,.15); color: #15803d; }
.ma-badge-rejected    { background: rgba(239,68,68,.1); color: #ef4444; }

.ma-actions {
    display: flex; flex-direction: column; align-items: flex-end; gap: .5rem;
}
.ma-date { font-size: .78rem; color: var(--text-muted); white-space: nowrap; }

.ma-timeline { display: flex; align-items: center; gap: 0; margin-top: .5rem; }
.ma-tl-dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--border-color); flex-shrink: 0;
}
.ma-tl-dot.active { background: var(--primary-color); }
.ma-tl-dot.success { background: #22c55e; }
.ma-tl-dot.rejected { background: #ef4444; }
.ma-tl-line { width: 28px; height: 2px; background: var(--border-color); }
.ma-tl-line.active { background: var(--primary-color); }
.ma-tl-line.success { background: #22c55e; }

.ma-empty {
    text-align: center; padding: 4rem 2rem;
    background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 14px;
}
.ma-empty i { font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem; display: block; }
.ma-empty h3 { font-size: 1.15rem; color: var(--heading-color); margin-bottom: .4rem; }
.ma-empty p { color: var(--text-muted); font-size: .9rem; margin-bottom: 1.25rem; }

@media(max-width: 640px) {
    .ma-card { grid-template-columns: 1fr; gap: .75rem; }
    .ma-actions { flex-direction: row; align-items: center; }
    .ma-avatar { display: none; }
}
</style>

<!-- Breadcrumb -->
<div class="breadcrumb">
    <div class="breadcrumb-item">
        <a href="{% url 'dashboard:home' %}" class="breadcrumb-link">Home</a>
        <i class='bx bx-chevron-right'></i>
    </div>
    <div class="breadcrumb-item">
        <a href="{% url 'jobs:job_listings' %}" class="breadcrumb-link">Jobs</a>
        <i class='bx bx-chevron-right'></i>
    </div>
    <div class="breadcrumb-item"><span>My Applications</span></div>
</div>

<!-- Page Header -->
<div class="page-content-header">
    <div>
        <h1 class="page-title"><i class='bx bx-send' style="color:var(--primary-color)"></i> My Applications</h1>
        <p class="page-subtitle">Track and manage all your job applications in one place</p>
    </div>
    <a href="{% url 'jobs:job_listings' %}" class="btn btn-primary btn-sm">
        <i class='bx bx-search'></i> Browse Jobs
    </a>
</div>

{% if applications %}
<div class="ma-stats">
    <div class="ma-stat">
        <div class="ma-stat-icon total"><i class='bx bx-send'></i></div>
        <div><h4>Total</h4><div class="val">{{ applications|length }}</div></div>
    </div>
    <div class="ma-stat">
        <div class="ma-stat-icon pending"><i class='bx bx-time-five'></i></div>
        <div><h4>Pending</h4><div class="val" id="statPending">0</div></div>
    </div>
    <div class="ma-stat">
        <div class="ma-stat-icon interview"><i class='bx bx-video'></i></div>
        <div><h4>Interviews</h4><div class="val" id="statInterview">0</div></div>
    </div>
    <div class="ma-stat">
        <div class="ma-stat-icon hired"><i class='bx bx-check-shield'></i></div>
        <div><h4>Offered / Hired</h4><div class="val" id="statHired">0</div></div>
    </div>
</div>

<div class="ma-filter-bar">
    <div class="ma-search-wrap">
        <i class='bx bx-search'></i>
        <input type="text" id="maSearch" placeholder="Search by job title or company...">
    </div>
    <select class="ma-filter-select" id="maStatusFilter">
        <option value="">All Statuses</option>
        <option value="Applied">Applied</option>
        <option value="Shortlisted">Shortlisted</option>
        <option value="Interview">Interview</option>
        <option value="Offered">Offered</option>
        <option value="Hired">Hired</option>
        <option value="Rejected">Rejected</option>
    </select>
    <select class="ma-filter-select" id="maSortBy">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
    </select>
</div>

<div class="ma-list" id="maList">
    {% for app in applications %}
    <div class="ma-card" data-status="{{ app.status }}" data-title="{{ app.job.title|lower }}" data-company="{{ app.job.company|lower }}" data-date="{{ app.applied_at|date:'U' }}">
        <div class="ma-avatar">{{ app.job.company|truncatechars:2 }}</div>
        <div class="ma-info">
            <h3><a href="{% url 'jobs:application_detail' app.id %}">{{ app.job.title }}</a></h3>
            <div class="ma-meta">
                <span><i class='bx bx-buildings'></i> {{ app.job.company }}</span>
                <span><i class='bx bx-map'></i> {{ app.job.location }}</span>
                <span><i class='bx bx-briefcase-alt-2'></i> {{ app.job.job_type }}</span>
            </div>
            <div class="ma-timeline">
                {% with s=app.status %}
                <div class="ma-tl-dot {% if s != 'Rejected' %}active{% else %}rejected{% endif %}"></div>
                <div class="ma-tl-line {% if s == 'Shortlisted' or s == 'Interview' or s == 'Offered' or s == 'Hired' %}active{% endif %}"></div>
                <div class="ma-tl-dot {% if s == 'Shortlisted' or s == 'Interview' or s == 'Offered' or s == 'Hired' %}active{% endif %}"></div>
                <div class="ma-tl-line {% if s == 'Interview' or s == 'Offered' or s == 'Hired' %}active{% endif %}"></div>
                <div class="ma-tl-dot {% if s == 'Interview' or s == 'Offered' or s == 'Hired' %}active{% endif %}"></div>
                <div class="ma-tl-line {% if s == 'Offered' or s == 'Hired' %}success{% endif %}"></div>
                <div class="ma-tl-dot {% if s == 'Offered' or s == 'Hired' %}success{% endif %}"></div>
                {% endwith %}
            </div>
        </div>
        <div class="ma-actions">
            <span class="ma-badge ma-badge-{{ app.status|lower }}">{{ app.status }}</span>
            <span class="ma-date"><i class='bx bx-calendar'></i> {{ app.applied_at|date:"M d, Y" }}</span>
            <a href="{% url 'jobs:application_detail' app.id %}" class="btn btn-outline-primary btn-sm" style="font-size:.78rem; padding:.3rem .65rem;">
                View Details <i class='bx bx-right-arrow-alt'></i>
            </a>
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<div class="ma-empty">
    <i class='bx bx-send'></i>
    <h3>No applications yet</h3>
    <p>Start applying to jobs to see your applications here</p>
    <a href="{% url 'jobs:job_listings' %}" class="btn btn-primary"><i class='bx bx-search'></i> Browse Jobs</a>
</div>
{% endif %}

<script>
(function() {
    const cards = document.querySelectorAll('.ma-card');
    let pending = 0, interview = 0, hired = 0;
    cards.forEach(c => {
        const s = c.dataset.status;
        if (s === 'Applied' || s === 'Shortlisted') pending++;
        else if (s === 'Interview') interview++;
        else if (s === 'Offered' || s === 'Hired') hired++;
    });
    const el = id => document.getElementById(id);
    if (el('statPending')) el('statPending').textContent = pending;
    if (el('statInterview')) el('statInterview').textContent = interview;
    if (el('statHired')) el('statHired').textContent = hired;

    function applyFilters() {
        const query = (el('maSearch')?.value || '').toLowerCase();
        const status = el('maStatusFilter')?.value || '';
        const sort = el('maSortBy')?.value || 'newest';
        const list = document.getElementById('maList');
        const items = Array.from(list.children);
        items.forEach(card => {
            const matchText = !query || card.dataset.title.includes(query) || card.dataset.company.includes(query);
            const matchStatus = !status || card.dataset.status === status;
            card.style.display = (matchText && matchStatus) ? '' : 'none';
        });
        const visible = items.filter(c => c.style.display !== 'none');
        visible.sort((a, b) => {
            const da = parseInt(a.dataset.date), db = parseInt(b.dataset.date);
            return sort === 'newest' ? db - da : da - db;
        });
        visible.forEach(c => list.appendChild(c));
    }
    el('maSearch')?.addEventListener('input', applyFilters);
    el('maStatusFilter')?.addEventListener('change', applyFilters);
    el('maSortBy')?.addEventListener('change', applyFilters);
})();
</script>
{% endblock %}
