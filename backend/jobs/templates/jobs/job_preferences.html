{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Job Preferences | Job Elevate{% endblock %}

{% block content %}
<div class="pref-page">
    <!-- Breadcrumb -->
    <nav class="pref-breadcrumb">
        <a href="{% url 'dashboard:home' %}">Home</a>
        <i class='bx bx-chevron-right'></i>
        <a href="{% url 'jobs:job_listings' %}">Jobs</a>
        <i class='bx bx-chevron-right'></i>
        <span>Preferences</span>
    </nav>

    <!-- Header -->
    <div class="pref-header">
        <div>
            <h1 class="pref-title">Job Preferences</h1>
            <p class="pref-subtitle">Customize your job search preferences to get better recommendations</p>
        </div>
        <a href="{% url 'jobs:recommended_jobs' %}" class="pref-btn pref-btn-outline">
            <i class='bx bx-arrow-back'></i> Back to Jobs
        </a>
    </div>



    <!-- Main Form -->
    <form method="POST" action="{% url 'jobs:update_job_preferences' %}" id="pref-form">
        {% csrf_token %}

        <div class="pref-grid">
            <!-- LEFT COLUMN -->
            <div class="pref-col">

                <!-- Job Types -->
                <div class="pref-card">
                    <div class="pref-card-header">
                        <i class='bx bx-briefcase'></i>
                        <div>
                            <h2>Job Types</h2>
                            <p>Select employment types you're interested in</p>
                        </div>
                    </div>
                    <div class="pref-checkbox-grid">
                        {% for value, label in job_types.items %}
                        <label class="pref-chip {% if preferences and value in preferences.preferred_job_types %}pref-chip-active{% endif %}">
                            <input type="checkbox" name="preferred_job_types" value="{{ value }}"
                                {% if preferences and value in preferences.preferred_job_types %}checked{% endif %}>
                            <i class='bx {% if value == "Full-time" %}bx-time{% elif value == "Part-time" %}bx-time-five{% elif value == "Contract" %}bx-file{% elif value == "Freelance" %}bx-user{% elif value == "Internship" %}bx-graduation{% elif value == "Remote" %}bx-home{% else %}bx-briefcase{% endif %}'></i>
                            <span>{{ label }}</span>
                        </label>
                        {% endfor %}
                    </div>

                    <!-- Remote toggle -->
                    <div class="pref-toggle-row">
                        <div>
                            <label><i class='bx bx-home'></i> Remote Work Preference</label>
                            <p>Prioritize remote and work-from-home opportunities</p>
                        </div>
                        <div class="pref-toggle">
                            <input type="checkbox" name="remote_preference" id="remote-pref"
                                {% if preferences and preferences.remote_preference %}checked{% endif %}>
                            <label for="remote-pref"><span></span></label>
                        </div>
                    </div>
                </div>

                <!-- Locations -->
                <div class="pref-card">
                    <div class="pref-card-header">
                        <i class='bx bx-map-pin'></i>
                        <div>
                            <h2>Preferred Locations</h2>
                            <p>Add cities, states or countries where you'd like to work</p>
                        </div>
                    </div>
                    <div class="pref-input-row">
                        <input type="text" id="loc-input" placeholder="e.g. Hyderabad, Bangalore, Mumbai" class="pref-input">
                        <button type="button" id="add-loc-btn" class="pref-btn pref-btn-primary pref-btn-sm">
                            <i class='bx bx-plus'></i> Add
                        </button>
                    </div>
                    <div class="pref-tags" id="loc-tags">
                        {% if preferences and preferences.preferred_locations %}
                            {% for loc in preferences.preferred_locations %}
                            <span class="pref-tag">
                                <i class='bx bx-map'></i> {{ loc }}
                                <button type="button" class="pref-tag-x" data-val="{{ loc }}"><i class='bx bx-x'></i></button>
                            </span>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <input type="hidden" name="preferred_locations" id="loc-hidden"
                           value="{% if preferences and preferences.preferred_locations %}{{ preferences.preferred_locations|join:',' }}{% endif %}">
                    <p class="pref-hint"><i class='bx bx-info-circle'></i> Your primary location will be visible to recruiters for matching</p>
                </div>

                <!-- Experience Level -->
                <div class="pref-card">
                    <div class="pref-card-header">
                        <i class='bx bx-bar-chart-alt-2'></i>
                        <div>
                            <h2>Experience Level</h2>
                            <p>Select your current experience level</p>
                        </div>
                    </div>
                    <div class="pref-exp-grid">
                        {% for val, label in experience_level_choices %}
                        <label class="pref-exp-chip {% if preferences and preferences.experience_level == val %}pref-exp-active{% endif %}">
                            <input type="radio" name="experience_level" value="{{ val }}"
                                {% if preferences and preferences.experience_level == val %}checked{% endif %}>
                            <span>{{ label }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="pref-col">

                <!-- Salary Expectations -->
                <div class="pref-card">
                    <div class="pref-card-header">
                        <i class='bx bx-wallet'></i>
                        <div>
                            <h2>Salary Expectations</h2>
                            <p>Set your expected salary range</p>
                        </div>
                    </div>

                    <!-- Currency & Period Row -->
                    <div class="pref-salary-config">
                        <div class="pref-field">
                            <label>Currency</label>
                            <select name="salary_currency" id="sal-currency" class="pref-select">
                                {% for val, label in currency_choices %}
                                <option value="{{ val }}" {% if preferences and preferences.salary_currency == val %}selected{% elif not preferences and val == 'INR' %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="pref-field">
                            <label>Period</label>
                            <select name="salary_period" id="sal-period" class="pref-select">
                                {% for val, label in salary_period_choices %}
                                <option value="{{ val }}" {% if preferences and preferences.salary_period == val %}selected{% elif not preferences and val == 'yearly' %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Salary Range inputs -->
                    <div class="pref-salary-range">
                        <div class="pref-field">
                            <label>Minimum Salary</label>
                            <div class="pref-salary-input-wrap">
                                <span class="pref-currency-sym" id="min-cur-sym">&#8377;</span>
                                <input type="number" name="min_salary_expectation" id="min-salary"
                                       value="{{ preferences.min_salary_expectation|default:'' }}"
                                       placeholder="e.g. 500000" min="0" step="1000" class="pref-input pref-salary-input">
                            </div>
                        </div>
                        <div class="pref-salary-sep">&mdash;</div>
                        <div class="pref-field">
                            <label>Maximum Salary</label>
                            <div class="pref-salary-input-wrap">
                                <span class="pref-currency-sym" id="max-cur-sym">&#8377;</span>
                                <input type="number" name="max_salary_expectation" id="max-salary"
                                       value="{{ preferences.max_salary_expectation|default:'' }}"
                                       placeholder="e.g. 1200000" min="0" step="1000" class="pref-input pref-salary-input">
                            </div>
                        </div>
                    </div>

                    <!-- Salary display summary -->
                    <div class="pref-salary-summary" id="sal-summary"></div>

                    <p class="pref-hint"><i class='bx bx-info-circle'></i> Enter your expected range in your chosen currency. Leave blank if no preference.</p>
                </div>

                <!-- Industry Preferences -->
                <div class="pref-card">
                    <div class="pref-card-header">
                        <i class='bx bx-buildings'></i>
                        <div>
                            <h2>Industry Preferences</h2>
                            <p>Select industries that interest you most</p>
                        </div>
                    </div>

                    <div class="pref-industry-grid">
                        {% for industry, label in industry_choices %}
                        <button type="button" class="pref-ind-card {% if preferences and industry in preferences.industry_preferences %}pref-ind-active{% endif %}" data-industry="{{ industry }}">
                            <i class='bx {% if industry == "Technology" %}bx-code-alt{% elif industry == "Healthcare" %}bx-plus-medical{% elif industry == "Finance" %}bx-money{% elif industry == "Education" %}bx-book-reader{% elif industry == "Marketing" %}bx-trending-up{% elif industry == "Manufacturing" %}bx-cog{% elif industry == "Retail" %}bx-store{% elif industry == "Media" %}bx-camera{% elif industry == "Construction" %}bx-building{% elif industry == "Transportation" %}bx-car{% elif industry == "Food Service" %}bx-restaurant{% elif industry == "Consulting" %}bx-chat{% elif industry == "Government" %}bx-buildings{% elif industry == "E-commerce" %}bx-cart{% elif industry == "Telecommunications" %}bx-phone{% elif industry == "Energy" %}bx-bolt-circle{% else %}bx-briefcase{% endif %}'></i>
                            <span>{{ label }}</span>
                            <div class="pref-ind-check"><i class='bx bx-check'></i></div>
                        </button>
                        {% endfor %}
                    </div>

                    <div class="pref-input-row" style="margin-top: 1rem;">
                        <input type="text" id="ind-input" placeholder="Add custom industry..." class="pref-input">
                        <button type="button" id="add-ind-btn" class="pref-btn pref-btn-primary pref-btn-sm">
                            <i class='bx bx-plus'></i> Add
                        </button>
                    </div>

                    <div class="pref-tags" id="ind-tags">
                        {% if preferences and preferences.industry_preferences %}
                            {% for ind in preferences.industry_preferences %}
                            <span class="pref-tag pref-tag-green">
                                <i class='bx bx-building'></i> {{ ind }}
                                <button type="button" class="pref-tag-x" data-val="{{ ind }}"><i class='bx bx-x'></i></button>
                            </span>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <input type="hidden" name="industry_preferences" id="ind-hidden"
                           value="{% if preferences and preferences.industry_preferences %}{{ preferences.industry_preferences|join:',' }}{% endif %}">
                </div>
            </div>
        </div>

        <!-- Save Actions -->
        <div class="pref-actions">
            <button type="button" class="pref-btn pref-btn-outline" onclick="window.history.back()">
                <i class='bx bx-arrow-back'></i> Cancel
            </button>
            <button type="submit" class="pref-btn pref-btn-primary pref-btn-lg">
                <i class='bx bx-save'></i> Save Preferences
            </button>
        </div>
    </form>
</div>

<style>
/* ===== Job Preferences Page ===== */
.pref-page {
    max-width: 100%;
    margin: 0 auto;
    padding: 1rem 1.5rem 3rem;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}

/* Breadcrumb */
.pref-breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.85rem;
    margin-bottom: 1.5rem;
    color: #6b7280;
}
.pref-breadcrumb a { color: #6b7280; text-decoration: none; }
.pref-breadcrumb a:hover { color: #1f2937; }
.pref-breadcrumb span { color: #1f2937; font-weight: 500; }
.pref-breadcrumb i { font-size: 0.7rem; color: #9ca3af; }

/* Header */
.pref-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}
.pref-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0 0 0.25rem;
}
.pref-subtitle {
    color: #6b7280;
    margin: 0;
    font-size: 0.95rem;
}

/* Alerts */
.pref-alerts { margin-bottom: 1.5rem; }
.pref-alert {
    display: flex; justify-content: space-between; align-items: center;
    padding: 0.7rem 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem;
    font-size: 0.9rem; border: 1px solid;
}
.pref-alert-success { background: #f0fdf4; border-color: #bbf7d0; color: #166534; }
.pref-alert-error { background: #fef2f2; border-color: #fecaca; color: #dc2626; }
.pref-alert-warning { background: #fffbeb; border-color: #fed7aa; color: #d97706; }
.pref-alert-info { background: #eff6ff; border-color: #bfdbfe; color: #2563eb; }
.pref-alert button { background: none; border: none; color: inherit; cursor: pointer; font-size: 1.1rem; }

/* Two-column grid */
.pref-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}
@media (max-width: 900px) {
    .pref-grid { grid-template-columns: 1fr; }
}

/* Card */
.pref-card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    transition: box-shadow 0.2s;
}
.pref-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }

.pref-card-header {
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
    margin-bottom: 1.25rem;
}
.pref-card-header > i {
    font-size: 1.5rem;
    color: #3b82f6;
    margin-top: 2px;
}
.pref-card-header h2 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
}
.pref-card-header p {
    color: #6b7280;
    font-size: 0.825rem;
    margin: 0.15rem 0 0;
}

/* Checkbox chip grid */
.pref-checkbox-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
    margin-bottom: 1.25rem;
}
.pref-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.6rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 2rem;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    color: #374151;
    background: #fff;
    transition: all 0.2s;
    user-select: none;
}
.pref-chip input { display: none; }
.pref-chip i { font-size: 1.1rem; color: #6b7280; transition: color 0.2s; }
.pref-chip:hover { border-color: #3b82f6; background: #f0f7ff; }
.pref-chip-active, .pref-chip:has(input:checked) {
    border-color: #3b82f6;
    background: #eff6ff;
    color: #1d4ed8;
}
.pref-chip-active i, .pref-chip:has(input:checked) i { color: #3b82f6; }

/* Toggle */
.pref-toggle-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.6rem;
    background: #f9fafb;
}
.pref-toggle-row label {
    display: flex; align-items: center; gap: 0.4rem;
    font-weight: 500; color: #374151; font-size: 0.9rem;
}
.pref-toggle-row > div:first-child p {
    color: #6b7280; font-size: 0.8rem; margin: 0.15rem 0 0;
}
.pref-toggle { position: relative; }
.pref-toggle input { opacity: 0; position: absolute; }
.pref-toggle label {
    display: block; width: 3rem; height: 1.5rem; cursor: pointer;
}
.pref-toggle label span {
    display: block; width: 100%; height: 100%;
    background: #d1d5db; border-radius: 1.5rem;
    position: relative; transition: background 0.3s;
}
.pref-toggle label span::before {
    content: ''; position: absolute;
    width: 1.25rem; height: 1.25rem;
    background: white; border-radius: 50%;
    top: 0.125rem; left: 0.125rem;
    transition: transform 0.3s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.pref-toggle input:checked + label span { background: #3b82f6; }
.pref-toggle input:checked + label span::before { transform: translateX(1.5rem); }

/* Inputs */
.pref-input {
    width: 100%;
    padding: 0.65rem 0.85rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    color: #1f2937;
    background: #fff;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-sizing: border-box;
}
.pref-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
}
.pref-input::placeholder { color: #9ca3af; }

.pref-select {
    width: 100%;
    padding: 0.65rem 0.85rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    color: #1f2937;
    background: #fff;
    cursor: pointer;
    transition: border-color 0.2s;
    box-sizing: border-box;
}
.pref-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
}

.pref-input-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}
.pref-input-row .pref-input { flex: 1; }

/* Tags */
.pref-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    min-height: 2rem;
    margin-bottom: 0.5rem;
}
.pref-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    background: #3b82f6;
    color: white;
    padding: 0.3rem 0.6rem;
    border-radius: 1.5rem;
    font-size: 0.78rem;
    font-weight: 500;
}
.pref-tag-green {
    background: #059669;
}
.pref-tag-x {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0;
    margin-left: 0.15rem;
    display: flex;
    align-items: center;
    opacity: 0.8;
    transition: opacity 0.2s;
}
.pref-tag-x:hover { opacity: 1; }

.pref-hint {
    display: flex; align-items: center; gap: 0.3rem;
    color: #6b7280; font-size: 0.78rem; margin: 0.5rem 0 0;
}

/* Experience chips */
.pref-exp-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}
.pref-exp-chip {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 2rem;
    cursor: pointer;
    font-size: 0.825rem;
    font-weight: 500;
    color: #374151;
    background: #fff;
    transition: all 0.2s;
}
.pref-exp-chip input { display: none; }
.pref-exp-chip:hover { border-color: #3b82f6; }
.pref-exp-active, .pref-exp-chip:has(input:checked) {
    border-color: #3b82f6;
    background: #eff6ff;
    color: #1d4ed8;
}

/* Salary section */
.pref-salary-config {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.25rem;
}
.pref-field label {
    display: block;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.35rem;
    font-size: 0.825rem;
}

.pref-salary-range {
    display: flex;
    align-items: flex-end;
    gap: 0.75rem;
    margin-bottom: 1rem;
}
.pref-salary-range .pref-field { flex: 1; }
.pref-salary-sep {
    color: #9ca3af;
    font-size: 1.1rem;
    padding-bottom: 0.65rem;
}

.pref-salary-input-wrap {
    position: relative;
    display: flex;
    align-items: center;
}
.pref-currency-sym {
    position: absolute;
    left: 0.75rem;
    color: #6b7280;
    font-weight: 600;
    font-size: 0.9rem;
    pointer-events: none;
    z-index: 1;
}
.pref-salary-input {
    padding-left: 2rem !important;
}

.pref-salary-summary {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    font-size: 0.85rem;
    color: #166534;
    text-align: center;
    font-weight: 500;
    display: none;
}
.pref-salary-summary.visible { display: block; }

/* Industry grid */
.pref-industry-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 0.6rem;
    margin-bottom: 1rem;
}
.pref-ind-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.3rem;
    padding: 0.8rem 0.5rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.6rem;
    cursor: pointer;
    background: #fff;
    transition: all 0.2s;
    position: relative;
    text-align: center;
    font-size: 0.8rem;
}
.pref-ind-card i { font-size: 1.3rem; color: #6b7280; transition: color 0.2s; }
.pref-ind-card span { color: #374151; font-weight: 500; }
.pref-ind-card:hover { border-color: #3b82f6; box-shadow: 0 2px 8px rgba(59,130,246,0.1); }
.pref-ind-active {
    border-color: #3b82f6;
    background: #eff6ff;
}
.pref-ind-active i { color: #3b82f6; }
.pref-ind-active span { color: #1d4ed8; }
.pref-ind-check {
    position: absolute;
    top: -0.4rem; right: -0.4rem;
    width: 1.2rem; height: 1.2rem;
    background: #3b82f6; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: white; font-size: 0.65rem;
    opacity: 0; transform: scale(0.5);
    transition: all 0.2s;
}
.pref-ind-active .pref-ind-check { opacity: 1; transform: scale(1); }

/* Buttons */
.pref-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.6rem 1.2rem;
    border-radius: 0.5rem;
    font-weight: 500;
    font-size: 0.875rem;
    text-decoration: none;
    cursor: pointer;
    border: 1px solid;
    transition: all 0.2s;
}
.pref-btn-primary {
    background: #3b82f6; border-color: #3b82f6; color: white;
}
.pref-btn-primary:hover { background: #2563eb; border-color: #2563eb; }
.pref-btn-outline {
    background: transparent; border-color: #d1d5db; color: #374151;
}
.pref-btn-outline:hover { background: #f3f4f6; }
.pref-btn-sm { padding: 0.5rem 0.85rem; font-size: 0.8rem; }
.pref-btn-lg { padding: 0.75rem 2rem; font-size: 0.95rem; }

/* Actions bar */
.pref-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 0;
    border-top: 1px solid #e5e7eb;
}

/* Responsive */
@media (max-width: 640px) {
    .pref-header { flex-direction: column; }
    .pref-salary-config { grid-template-columns: 1fr; }
    .pref-salary-range { flex-direction: column; }
    .pref-salary-sep { display: none; }
    .pref-industry-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
    .pref-actions { flex-direction: column; gap: 0.75rem; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Currency symbol map
    const currencySymbols = {
        'INR': '\u20b9', 'USD': '$', 'EUR': '\u20ac', 'GBP': '\u00a3',
        'AUD': 'A$', 'CAD': 'C$', 'SGD': 'S$', 'AED': '\u062f.\u0625', 'JPY': '\u00a5'
    };

    // ===== Salary =====
    const currSel = document.getElementById('sal-currency');
    const periodSel = document.getElementById('sal-period');
    const minSal = document.getElementById('min-salary');
    const maxSal = document.getElementById('max-salary');
    const minSym = document.getElementById('min-cur-sym');
    const maxSym = document.getElementById('max-cur-sym');
    const summary = document.getElementById('sal-summary');

    function updateCurrencySymbol() {
        const sym = currencySymbols[currSel.value] || '\u20b9';
        minSym.textContent = sym;
        maxSym.textContent = sym;
        updateSalSummary();
    }

    function formatNum(n, currency) {
        const localeMap = {
            'INR': 'en-IN', 'USD': 'en-US', 'EUR': 'de-DE', 'GBP': 'en-GB',
            'AUD': 'en-AU', 'CAD': 'en-CA', 'SGD': 'en-SG', 'AED': 'ar-AE', 'JPY': 'ja-JP'
        };
        return new Intl.NumberFormat(localeMap[currency] || 'en-IN').format(n);
    }

    function updateSalSummary() {
        const currency = currSel.value;
        const sym = currencySymbols[currency] || '\u20b9';
        const period = periodSel.value === 'monthly' ? '/month' : '/year';
        const mn = parseInt(minSal.value);
        const mx = parseInt(maxSal.value);
        if (mn || mx) {
            let text = 'Expected: ';
            if (mn && mx) {
                text += sym + formatNum(mn, currency) + ' \u2014 ' + sym + formatNum(mx, currency) + ' ' + period;
            } else if (mn) {
                text += sym + formatNum(mn, currency) + '+ ' + period;
            } else {
                text += 'Up to ' + sym + formatNum(mx, currency) + ' ' + period;
            }
            summary.textContent = text;
            summary.classList.add('visible');
        } else {
            summary.classList.remove('visible');
        }
    }

    currSel.addEventListener('change', updateCurrencySymbol);
    periodSel.addEventListener('change', updateSalSummary);
    minSal.addEventListener('input', updateSalSummary);
    maxSal.addEventListener('input', updateSalSummary);
    updateCurrencySymbol();

    // ===== Chip toggle (job types) =====
    document.querySelectorAll('.pref-chip').forEach(function(chip) {
        chip.addEventListener('click', function() {
            var cb = this.querySelector('input');
            var self = this;
            setTimeout(function() {
                if (cb.checked) {
                    self.classList.add('pref-chip-active');
                } else {
                    self.classList.remove('pref-chip-active');
                }
            }, 0);
        });
    });

    // ===== Experience chips =====
    document.querySelectorAll('.pref-exp-chip').forEach(function(chip) {
        chip.addEventListener('click', function() {
            document.querySelectorAll('.pref-exp-chip').forEach(function(c) { c.classList.remove('pref-exp-active'); });
            this.classList.add('pref-exp-active');
        });
    });

    // ===== Location tags =====
    var locInput = document.getElementById('loc-input');
    var locBtn = document.getElementById('add-loc-btn');
    var locTags = document.getElementById('loc-tags');
    var locHidden = document.getElementById('loc-hidden');

    function getLocations() {
        var btns = locTags.querySelectorAll('.pref-tag-x');
        var locs = [];
        btns.forEach(function(b) { if (b.dataset.val) locs.push(b.dataset.val); });
        return locs;
    }

    function syncLocHidden() {
        locHidden.value = getLocations().join(',');
    }

    function createLocTag(val) {
        var tag = document.createElement('span');
        tag.className = 'pref-tag';
        tag.innerHTML = '<i class="bx bx-map"></i> ' + val + ' <button type="button" class="pref-tag-x" data-val="' + val + '"><i class="bx bx-x"></i></button>';
        tag.querySelector('.pref-tag-x').addEventListener('click', function() {
            tag.remove();
            syncLocHidden();
        });
        locTags.appendChild(tag);
    }

    function addLocation() {
        var val = locInput.value.trim();
        if (!val) return;
        var existing = getLocations().map(function(l) { return l.toLowerCase(); });
        if (existing.indexOf(val.toLowerCase()) !== -1) {
            alert('Location already added!');
            return;
        }
        createLocTag(val);
        locInput.value = '';
        syncLocHidden();
    }

    locBtn.addEventListener('click', addLocation);
    locInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); addLocation(); }
    });
    locTags.querySelectorAll('.pref-tag-x').forEach(function(btn) {
        btn.addEventListener('click', function() { this.closest('.pref-tag').remove(); syncLocHidden(); });
    });

    // ===== Industry =====
    var indCards = document.querySelectorAll('.pref-ind-card');
    var indInput = document.getElementById('ind-input');
    var indBtn = document.getElementById('add-ind-btn');
    var indTags = document.getElementById('ind-tags');
    var indHidden = document.getElementById('ind-hidden');

    function getIndustries() {
        var btns = indTags.querySelectorAll('.pref-tag-x');
        var inds = [];
        btns.forEach(function(b) { if (b.dataset.val) inds.push(b.dataset.val); });
        return inds;
    }

    function syncIndHidden() {
        indHidden.value = getIndustries().join(',');
    }

    function createIndTag(val) {
        var existing = getIndustries().map(function(i) { return i.toLowerCase(); });
        if (existing.indexOf(val.toLowerCase()) !== -1) return;
        var tag = document.createElement('span');
        tag.className = 'pref-tag pref-tag-green';
        tag.innerHTML = '<i class="bx bx-building"></i> ' + val + ' <button type="button" class="pref-tag-x" data-val="' + val + '"><i class="bx bx-x"></i></button>';
        tag.querySelector('.pref-tag-x').addEventListener('click', function() {
            tag.remove();
            syncIndHidden();
            var card = document.querySelector('.pref-ind-card[data-industry="' + val + '"]');
            if (card) card.classList.remove('pref-ind-active');
        });
        indTags.appendChild(tag);
    }

    function removeIndTag(val) {
        indTags.querySelectorAll('.pref-tag-x').forEach(function(btn) {
            if (btn.dataset.val === val) btn.closest('.pref-tag').remove();
        });
    }

    indCards.forEach(function(card) {
        card.addEventListener('click', function() {
            var ind = this.dataset.industry;
            if (this.classList.contains('pref-ind-active')) {
                this.classList.remove('pref-ind-active');
                removeIndTag(ind);
            } else {
                this.classList.add('pref-ind-active');
                createIndTag(ind);
            }
            syncIndHidden();
        });
    });

    if (indBtn) {
        function addCustomInd() {
            var val = indInput.value.trim();
            if (!val) return;
            createIndTag(val);
            indInput.value = '';
            syncIndHidden();
        }
        indBtn.addEventListener('click', addCustomInd);
        indInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); addCustomInd(); }
        });
    }

    indTags.querySelectorAll('.pref-tag-x').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var val = this.dataset.val;
            this.closest('.pref-tag').remove();
            syncIndHidden();
            var card = document.querySelector('.pref-ind-card[data-industry="' + val + '"]');
            if (card) card.classList.remove('pref-ind-active');
        });
    });

    // ===== Form validation =====
    document.getElementById('pref-form').addEventListener('submit', function(e) {
        var mn = parseInt(minSal.value);
        var mx = parseInt(maxSal.value);
        if (mn && mx && mn > mx) {
            e.preventDefault();
            alert('Minimum salary cannot be greater than maximum salary.');
            return false;
        }
    });
});
</script>

{% endblock %}
