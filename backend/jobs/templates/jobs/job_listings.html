{% extends 'dashboard/base.html' %}
{% load static %}
{% load jobs_extras %}

{% block title %}Job Matches{% endblock %}

{% block content %}
{% csrf_token %}
<style>
/* ══════════════════════════════════════════════════
   Job Listings – Card-Based Layout  (jl- namespace)
   Matching recommended_jobs.html design language
   ══════════════════════════════════════════════════ */

/* ── Page Header ── */
.jl-header { display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:1rem; margin-bottom:1.5rem; }
.jl-header h1 { font-size:1.5rem; font-weight:700; color:var(--heading-color); margin:0; display:flex; align-items:center; gap:.5rem; }
.jl-header h1 i { color:var(--primary-color); }
.jl-subtitle { font-size:.9rem; color:var(--text-light); margin-top:.25rem; }
.jl-header-actions { display:flex; gap:.5rem; flex-wrap:wrap; }
.jl-header-btn {
    font-size:.82rem; padding:.45rem .85rem; border-radius:8px;
    border:1px solid var(--border-color); background:var(--card-bg); color:var(--text-color);
    text-decoration:none; display:inline-flex; align-items:center; gap:.35rem; transition:all .15s;
}
.jl-header-btn:hover { border-color:var(--primary-color); color:var(--primary-color); }
.jl-header-btn.primary { background:var(--primary-color); color:#fff; border-color:var(--primary-color); }
.jl-header-btn.primary:hover { background:var(--primary-hover,var(--primary-color)); }

/* ── Messages ── */
.jl-messages { margin-bottom:1.25rem; display:flex; flex-direction:column; gap:.5rem; }
.jl-msg {
    display:flex; align-items:center; padding:.85rem 1rem; border-radius:10px;
    background:var(--card-bg); border:1px solid var(--border-color); gap:.6rem;
    animation:jlSlideIn .3s ease; font-size:.9rem;
}
@keyframes jlSlideIn { from { transform:translateY(-10px); opacity:0; } to { transform:translateY(0); opacity:1; } }
.jl-msg i { font-size:1.15rem; flex-shrink:0; }
.jl-msg p { flex:1; margin:0; }
.jl-msg-close { background:none; border:none; color:var(--text-light); cursor:pointer; font-size:1rem; padding:.2rem; border-radius:50%; }
.jl-msg-close:hover { background:var(--hover-bg); }
.jl-msg.success { border-left:3px solid #22c55e; }
.jl-msg.success i { color:#22c55e; }
.jl-msg.error { border-left:3px solid #ef4444; }
.jl-msg.error i { color:#ef4444; }
.jl-msg.warning { border-left:3px solid #f59e0b; }
.jl-msg.warning i { color:#f59e0b; }
.jl-msg.info { border-left:3px solid #3b82f6; }
.jl-msg.info i { color:#3b82f6; }

/* ── Recommended Section ── */
.jl-rec-section {
    background:var(--card-bg); border:1px solid var(--border-color);
    border-radius:14px; padding:1.5rem; margin-bottom:1.25rem;
    border-left:4px solid var(--primary-color);
}
.jl-rec-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.25rem; }
.jl-rec-title { font-size:1.15rem; font-weight:600; color:var(--heading-color); display:flex; align-items:center; gap:.5rem; margin:0; }
.jl-rec-title i { color:var(--primary-color); }
.jl-rec-sub { font-size:.82rem; color:var(--text-light); margin-top:.15rem; }

/* ── Card Grid (shared) ── */
.jl-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(330px,1fr)); gap:1rem; }
@media(max-width:720px) { .jl-grid { grid-template-columns:1fr; } }

/* ── Job Card ── */
.jl-card {
    background:var(--card-bg); border:1px solid var(--border-color);
    border-radius:14px; padding:1.25rem 1.5rem;
    transition:all .2s; position:relative;
    display:flex; flex-direction:column; gap:.7rem;
}
.jl-card:hover { border-color:var(--primary-color); box-shadow:0 4px 16px rgba(0,0,0,.06); transform:translateY(-2px); }
.jl-card.featured { border-color:var(--success-color,#22c55e); }
.jl-card.featured::before {
    content:''; position:absolute; top:0; left:0; right:0; height:3px;
    background:var(--success-color,#22c55e); border-radius:14px 14px 0 0;
}

.jl-card-top { display:flex; justify-content:space-between; align-items:flex-start; gap:.75rem; }
.jl-card-info { flex:1; min-width:0; }
.jl-card-info h3 { font-size:1.05rem; font-weight:600; color:var(--heading-color); margin:0 0 .2rem; }
.jl-card-info h3 a { color:inherit; text-decoration:none; }
.jl-card-info h3 a:hover { color:var(--primary-color); }
.jl-card-company { font-size:.85rem; color:var(--text-muted,var(--text-light)); display:flex; align-items:center; gap:.3rem; }

/* ── Score Ring ── */
.jl-score { width:52px; height:52px; position:relative; flex-shrink:0; }
.jl-score svg { width:52px; height:52px; transform:rotate(-90deg); }
.jl-score-track { fill:none; stroke:var(--border-color); stroke-width:4; }
.jl-score-fill  { fill:none; stroke-width:4; stroke-linecap:round; transition:stroke-dashoffset .6s ease; }
.jl-score-text {
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-size:.75rem; font-weight:700; color:var(--heading-color);
}
.jl-score-high .jl-score-fill { stroke:#22c55e; }
.jl-score-med  .jl-score-fill { stroke:#f59e0b; }
.jl-score-low  .jl-score-fill { stroke:#ef4444; }

/* ── Meta Row ── */
.jl-meta { display:flex; flex-wrap:wrap; gap:.3rem .6rem; font-size:.8rem; color:var(--text-muted,var(--text-light)); align-items:center; }
.jl-meta span { display:flex; align-items:center; gap:.2rem; }

/* ── Type Badge ── */
.jl-type-badge { padding:.2rem .55rem; border-radius:20px; font-size:.72rem; font-weight:500; display:inline-flex; align-items:center; }
.jl-type-full-time  { background:rgba(34,197,94,.1); color:#16a34a; }
.jl-type-part-time  { background:rgba(59,130,246,.1); color:#2563eb; }
.jl-type-remote     { background:rgba(79,70,229,.1); color:var(--primary-color); }
.jl-type-contract   { background:rgba(245,158,11,.1); color:#d97706; }
.jl-type-internship { background:rgba(139,92,246,.1); color:#7c3aed; }
.jl-type-freelance  { background:rgba(236,72,153,.1); color:#db2777; }

/* ── Skills ── */
.jl-skills { display:flex; flex-wrap:wrap; gap:.3rem; }
.jl-skill {
    font-size:.72rem; padding:.18rem .5rem; border-radius:6px;
    background:rgba(79,70,229,.08); color:var(--primary-color); font-weight:500;
}
.jl-skill-more { background:var(--hover-bg); color:var(--text-light); }

/* ── Reason ── */
.jl-reason {
    font-size:.8rem; color:var(--text-muted,var(--text-light)); font-style:italic;
    display:flex; align-items:center; gap:.3rem; line-height:1.35;
}
.jl-reason i { font-size:.9rem; color:var(--primary-color); flex-shrink:0; }

/* ── Card Footer ── */
.jl-card-footer {
    display:flex; justify-content:space-between; align-items:center;
    padding-top:.65rem; border-top:1px solid var(--border-color); margin-top:auto;
}
.jl-card-actions { display:flex; gap:.35rem; }
.jl-icon-btn {
    width:34px; height:34px; border-radius:8px; border:1px solid var(--border-color);
    background:var(--card-bg); cursor:pointer; display:flex; align-items:center;
    justify-content:center; font-size:1rem; color:var(--text-light); transition:all .15s;
    text-decoration:none;
}
.jl-icon-btn:hover { border-color:var(--primary-color); color:var(--primary-color); }
.jl-icon-btn.bookmarked { color:#f59e0b; border-color:#f59e0b; background:rgba(245,158,11,.06); }

.jl-view-btn {
    padding:.3rem .7rem; font-size:.8rem; border-radius:6px; border:none;
    background:var(--primary-color); color:#fff; cursor:pointer; font-weight:500;
    text-decoration:none; display:inline-flex; align-items:center; gap:.25rem; transition:background .15s;
}
.jl-view-btn:hover { background:var(--primary-hover,var(--primary-color)); }

.jl-applied-badge {
    font-size:.72rem; padding:.2rem .6rem; border-radius:20px;
    background:rgba(34,197,94,.1); color:#16a34a; font-weight:600;
}

/* ── Status Badges (Applied tab) ── */
.jl-status-badge { padding:.25rem .65rem; border-radius:20px; font-size:.72rem; font-weight:600; }
.jl-status-pending    { background:rgba(245,158,11,.1); color:#d97706; }
.jl-status-reviewed   { background:rgba(59,130,246,.1); color:#2563eb; }
.jl-status-interview  { background:rgba(139,92,246,.1); color:#7c3aed; }
.jl-status-accepted   { background:rgba(34,197,94,.1); color:#16a34a; }
.jl-status-rejected   { background:rgba(239,68,68,.1); color:#ef4444; }
.jl-status-withdrawn  { background:var(--hover-bg); color:var(--text-muted,var(--text-light)); }

/* ── Preferences Card ── */
.jl-prefs-card {
    border-radius:14px; padding:1.25rem 1.5rem; margin-bottom:1.25rem;
    display:flex; align-items:center; gap:1.25rem; flex-wrap:wrap;
}
.jl-prefs-card.not-set { background:linear-gradient(135deg,rgba(79,70,229,.08),rgba(79,70,229,.18)); }
.jl-prefs-card.active { background:linear-gradient(135deg,rgba(34,197,94,.08),rgba(34,197,94,.18)); }
.jl-prefs-icon {
    width:48px; height:48px; border-radius:50%; display:flex; align-items:center;
    justify-content:center; font-size:1.5rem; color:#fff; flex-shrink:0;
}
.jl-prefs-card.not-set .jl-prefs-icon { background:var(--primary-color); }
.jl-prefs-card.active .jl-prefs-icon { background:#22c55e; }
.jl-prefs-text { flex:1; min-width:200px; }
.jl-prefs-text h3 { font-size:1.05rem; font-weight:600; color:var(--heading-color); margin:0 0 .25rem; }
.jl-prefs-text p { font-size:.85rem; color:var(--text-light); margin:0; line-height:1.5; }

/* ── Filter Toolbar ── */
.jl-toolbar {
    background:var(--card-bg); border:1px solid var(--border-color); border-radius:12px;
    padding:.75rem 1rem; display:flex; align-items:center; gap:.6rem;
    flex-wrap:wrap; margin-bottom:1rem;
}
.jl-search-wrap { flex:1; min-width:180px; position:relative; }
.jl-search-wrap i { position:absolute; left:.75rem; top:50%; transform:translateY(-50%); color:var(--text-light); font-size:1.1rem; }
.jl-search-wrap input {
    width:100%; border:1px solid var(--border-color); border-radius:8px;
    padding:.5rem .75rem .5rem 2.2rem; font-size:.88rem;
    background:var(--input-bg,var(--card-bg)); color:var(--text-color); transition:border-color .15s;
}
.jl-search-wrap input:focus { border-color:var(--primary-color); outline:none; box-shadow:0 0 0 2px rgba(79,70,229,.08); }
.jl-select {
    border:1px solid var(--border-color); border-radius:8px; padding:.5rem .7rem;
    font-size:.85rem; background:var(--input-bg,var(--card-bg)); color:var(--text-color); cursor:pointer;
}
.jl-select:focus { border-color:var(--primary-color); outline:none; }
.jl-filter-submit {
    padding:.5rem .85rem; border-radius:8px; border:none;
    background:var(--primary-color); color:#fff; font-size:.85rem; font-weight:500;
    cursor:pointer; display:inline-flex; align-items:center; gap:.3rem; transition:background .15s;
}
.jl-filter-submit:hover { background:var(--primary-hover,var(--primary-color)); }
.jl-clear-link { font-size:.82rem; color:var(--text-light); text-decoration:none; }
.jl-clear-link:hover { color:var(--primary-color); text-decoration:underline; }

/* ── Tab Navigation ── */
.jl-section {
    background:var(--card-bg); border:1px solid var(--border-color);
    border-radius:14px; padding:1.5rem;
    box-shadow:var(--card-shadow,0 1px 3px rgba(0,0,0,.04));
}
.jl-tabs {
    display:flex; gap:.5rem; border-bottom:1px solid var(--border-color);
    margin-bottom:1.25rem; padding-bottom:.5rem; overflow-x:auto;
}
.jl-tabs::-webkit-scrollbar { display:none; }
.jl-tab {
    display:flex; align-items:center; gap:.4rem; padding:.6rem 1rem;
    background:none; border:none; color:var(--text-light); font-weight:500;
    font-size:.9rem; cursor:pointer; border-radius:8px; transition:all .15s; white-space:nowrap;
}
.jl-tab:hover { background:var(--hover-bg); color:var(--text-color); }
.jl-tab.active { background:rgba(79,70,229,.1); color:var(--primary-color); font-weight:600; }
.jl-tab i { font-size:1.1rem; }
.jl-tab-content { display:none; }
.jl-tab-content.active { display:block; }

/* ── Summary ── */
.jl-summary { font-size:.85rem; color:var(--text-light); margin-bottom:.75rem; display:flex; align-items:center; gap:.5rem; }
.jl-summary strong { color:var(--heading-color); }

/* ── Time stamp ── */
.jl-time { font-size:.78rem; color:var(--text-light); display:flex; align-items:center; gap:.25rem; }

/* ── Empty State ── */
.jl-empty {
    text-align:center; padding:3rem 1.5rem; grid-column:1/-1;
}
.jl-empty i { font-size:3rem; color:var(--text-light); display:block; margin-bottom:.75rem; opacity:.5; }
.jl-empty h3 { font-size:1.1rem; color:var(--heading-color); margin:0 0 .35rem; }
.jl-empty p { color:var(--text-light); font-size:.88rem; margin:0 0 1rem; }

/* ── Pagination ── */
.jl-pagination {
    display:flex; justify-content:center; gap:.3rem; margin-top:1.5rem;
    padding-top:1rem; border-top:1px solid var(--border-color); flex-wrap:wrap;
}
.jl-page-link {
    padding:.4rem .7rem; border-radius:6px; font-size:.85rem; font-weight:500;
    color:var(--text-light); background:var(--card-bg); border:1px solid var(--border-color);
    text-decoration:none; transition:all .15s; display:inline-flex; align-items:center;
}
.jl-page-link:hover { border-color:var(--primary-color); color:var(--primary-color); }
.jl-page-link.active { background:var(--primary-color); color:#fff; border-color:var(--primary-color); }
.jl-page-link.disabled { opacity:.4; pointer-events:none; }

/* ── Responsive ── */
@media(max-width:768px) {
    .jl-header { flex-direction:column; }
    .jl-header-actions { width:100%; overflow-x:auto; }
    .jl-toolbar { flex-direction:column; }
    .jl-search-wrap { min-width:100%; }
    .jl-prefs-card { flex-direction:column; text-align:center; }
    .jl-prefs-icon { margin:0 auto; }
    .jl-rec-header { flex-direction:column; gap:.5rem; align-items:flex-start; }
}
@media(max-width:480px) {
    .jl-grid { grid-template-columns:1fr; }
    .jl-section { padding:1rem; }
}
</style>

<!-- Breadcrumb -->
<div class="breadcrumb">
    <div class="breadcrumb-item">
        <a href="{% url 'dashboard:home' %}" class="breadcrumb-link">Home</a>
        <i class='bx bx-chevron-right'></i>
    </div>
    <div class="breadcrumb-item"><span>Job Matches</span></div>
</div>

<!-- Page Header -->
<div class="jl-header">
    <div>
        <h1><i class='bx bx-briefcase'></i> Job Matches</h1>
        <p class="jl-subtitle">Discover opportunities that match your skills and career goals</p>
    </div>
    <div class="jl-header-actions">
        <a href="{% url 'jobs:update_job_preferences' %}" class="jl-header-btn {% if not has_preferences %}primary{% endif %}">
            <i class='bx bx-slider-alt'></i> {% if has_preferences %}Edit Preferences{% else %}Set Preferences{% endif %}
        </a>
        <a href="{% url 'jobs:search_jobs' %}" class="jl-header-btn">
            <i class='bx bx-search'></i> Advanced Search
        </a>
        <a href="{% url 'jobs:job_analytics' %}" class="jl-header-btn">
            <i class='bx bx-line-chart'></i> Market Insights
        </a>
    </div>
</div>

<!-- Messages -->
{% if messages %}
<div class="jl-messages">
    {% for message in messages %}
    <div class="jl-msg {% if message.tags %}{{ message.tags }}{% endif %}">
        {% if message.tags == 'success' %}<i class='bx bx-check-circle'></i>
        {% elif message.tags == 'error' %}<i class='bx bx-error'></i>
        {% elif message.tags == 'warning' %}<i class='bx bx-error-circle'></i>
        {% else %}<i class='bx bx-info-circle'></i>{% endif %}
        <p>{{ message }}</p>
        <button class="jl-msg-close" onclick="this.parentElement.remove()"><i class='bx bx-x'></i></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- ═══ Recommended For You ═══ -->
{% if recommended_jobs %}
<div class="jl-rec-section">
    <div class="jl-rec-header">
        <div>
            <h2 class="jl-rec-title"><i class='bx bx-star'></i> Recommended For You</h2>
            <p class="jl-rec-sub">Jobs matching your profile and preferences</p>
        </div>
        <a href="{% url 'jobs:recommended_jobs' %}" class="jl-header-btn">View All</a>
    </div>
    <div class="jl-grid">
        {% for rec in recommended_jobs %}
        <div class="jl-card {% if rec.score > 0.7 %}featured{% endif %}">
            <div class="jl-card-top">
                <div class="jl-card-info">
                    <h3><a href="{% url 'jobs:job_detail' job_id=rec.job.id %}">{{ rec.job.title }}</a></h3>
                    <div class="jl-card-company"><i class='bx bx-buildings'></i> {{ rec.job.company }}</div>
                </div>
                <div class="jl-score {% if rec.score|percentage >= 80 %}jl-score-high{% elif rec.score|percentage >= 60 %}jl-score-med{% else %}jl-score-low{% endif %}">
                    <svg viewBox="0 0 36 36">
                        <circle class="jl-score-track" cx="18" cy="18" r="15.9"/>
                        <circle class="jl-score-fill" cx="18" cy="18" r="15.9"
                            stroke-dasharray="{{ rec.score|percentage }}, 100"/>
                    </svg>
                    <span class="jl-score-text">{{ rec.score|percentage }}%</span>
                </div>
            </div>
            <div class="jl-meta">
                <span><i class='bx bx-map'></i> {{ rec.job.location }}</span>
                <span><i class='bx bx-briefcase-alt-2'></i> {{ rec.job.get_job_type_display }}</span>
                {% if rec.job.salary %}<span><i class='bx bx-money'></i> {{ rec.job.salary }}</span>{% endif %}
            </div>
            {% if rec.job.skills %}
            <div class="jl-skills">
                {% for skill in rec.job.skills|slice:":4" %}
                <span class="jl-skill">{% if skill.name %}{{ skill.name }}{% else %}{{ skill }}{% endif %}</span>
                {% endfor %}
                {% if rec.job.skills|length > 4 %}<span class="jl-skill jl-skill-more">+{{ rec.job.skills|length|add:"-4" }}</span>{% endif %}
            </div>
            {% endif %}
            {% if rec.reason %}
            <div class="jl-reason"><i class='bx bx-bulb'></i> {{ rec.reason }}</div>
            {% endif %}
            <div class="jl-card-footer">
                <a href="{% url 'jobs:job_detail' job_id=rec.job.id %}" class="jl-view-btn">View Details <i class='bx bx-right-arrow-alt'></i></a>
                <button class="jl-icon-btn bookmark-btn {% if rec.job.id in bookmarked_job_ids %}bookmarked{% endif %}"
                        data-job-id="{{ rec.job.id }}">
                    <i class='bx {% if rec.job.id in bookmarked_job_ids %}bxs-bookmark{% else %}bx-bookmark{% endif %}'></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- ═══ Preferences Banner ═══ -->
{% if not has_preferences %}
<div class="jl-prefs-card not-set">
    <div class="jl-prefs-icon"><i class='bx bx-slider-alt'></i></div>
    <div class="jl-prefs-text">
        <h3>Set Your Job Preferences</h3>
        <p>Tell us your preferred locations, job types, salary expectations, and industries for better recommendations.</p>
    </div>
    <a href="{% url 'jobs:update_job_preferences' %}" class="jl-view-btn" style="padding:.5rem 1rem; white-space:nowrap;">
        <i class='bx bx-cog'></i> Set Preferences
    </a>
</div>
{% elif user_preferences %}
<div class="jl-prefs-card active">
    <div class="jl-prefs-icon"><i class='bx bx-check'></i></div>
    <div class="jl-prefs-text">
        <h3>Preferences Active</h3>
        <p>
            {% if user_preferences.preferred_locations %}
                <i class='bx bx-map' style="vertical-align:middle;"></i> {{ user_preferences.preferred_locations|join:", " }}
                &nbsp;&middot;&nbsp;
            {% endif %}
            {% if user_preferences.preferred_job_types %}
                <i class='bx bx-time' style="vertical-align:middle;"></i> {{ user_preferences.preferred_job_types|join:", " }}
                &nbsp;&middot;&nbsp;
            {% endif %}
            {% if user_preferences.min_salary_expectation %}
                <i class='bx bx-dollar-circle' style="vertical-align:middle;"></i> ₹{{ user_preferences.min_salary_expectation|floatformat:0 }}+
            {% endif %}
        </p>
    </div>
    <a href="{% url 'jobs:update_job_preferences' %}" class="jl-header-btn" style="white-space:nowrap;">
        <i class='bx bx-edit'></i> Edit
    </a>
</div>
{% endif %}

<!-- ═══ Main Content with Tabs ═══ -->
<div class="jl-section">
    <!-- Tab Navigation -->
    <div class="jl-tabs">
        <button class="jl-tab active" data-tab="all-jobs"><i class='bx bx-briefcase'></i> All Jobs</button>
        <button class="jl-tab" data-tab="bookmarked"><i class='bx bx-bookmark'></i> Bookmarked</button>
        <button class="jl-tab" data-tab="applied"><i class='bx bx-check-circle'></i> Applied</button>
    </div>

    <!-- ══ ALL JOBS TAB ══ -->
    <div class="jl-tab-content active" id="all-jobs-content">
        <!-- Filter Toolbar -->
        <form method="get" class="jl-toolbar" id="jlFilterForm">
            <div class="jl-search-wrap">
                <i class='bx bx-search'></i>
                <input type="text" name="search" value="{{ search_query }}" placeholder="Search by title or company…">
            </div>
            <select name="location" class="jl-select">
                <option value="">All Locations</option>
                {% for loc in all_locations %}
                <option value="{{ loc }}" {% if location_filter == loc %}selected{% endif %}>{{ loc }}</option>
                {% endfor %}
            </select>
            <select name="job_type" class="jl-select">
                <option value="">All Types</option>
                <option value="Full-time" {% if job_type_filter == 'Full-time' %}selected{% endif %}>Full-time</option>
                <option value="Part-time" {% if job_type_filter == 'Part-time' %}selected{% endif %}>Part-time</option>
                <option value="Remote" {% if job_type_filter == 'Remote' %}selected{% endif %}>Remote</option>
                <option value="Contract" {% if job_type_filter == 'Contract' %}selected{% endif %}>Contract</option>
                <option value="Internship" {% if job_type_filter == 'Internship' %}selected{% endif %}>Internship</option>
                <option value="Freelance" {% if job_type_filter == 'Freelance' %}selected{% endif %}>Freelance</option>
            </select>
            <select name="sort" class="jl-select">
                <option value="match" {% if sort_by == 'match' %}selected{% endif %}>Best Match</option>
                <option value="date" {% if sort_by == 'date' %}selected{% endif %}>Newest First</option>
            </select>
            <button type="submit" class="jl-filter-submit"><i class='bx bx-filter'></i> Filter</button>
            {% if has_filters %}
            <a href="{% url 'jobs:job_listings' %}" class="jl-clear-link">Clear</a>
            {% endif %}
        </form>

        <!-- Results Summary -->
        <div class="jl-summary">
            <strong>{{ total_jobs }}</strong> job{{ total_jobs|pluralize }} found
            {% if has_filters %}<span>&middot; Filtered results</span>{% endif %}
        </div>

        <!-- Job Cards Grid -->
        <div class="jl-grid" id="jlGrid">
            {% for job in jobs %}
            {% with match_info=job_match_scores|dict_get:job.id %}
            <div class="jl-card {% if match_info.percentage >= 80 %}featured{% endif %}">
                <div class="jl-card-top">
                    <div class="jl-card-info">
                        <h3><a href="{% url 'jobs:job_detail' job_id=job.id %}">{{ job.title }}</a></h3>
                        <div class="jl-card-company"><i class='bx bx-buildings'></i> {{ job.company }}</div>
                    </div>
                    {% if match_info %}
                    <div class="jl-score {% if match_info.percentage >= 80 %}jl-score-high{% elif match_info.percentage >= 60 %}jl-score-med{% else %}jl-score-low{% endif %}">
                        <svg viewBox="0 0 36 36">
                            <circle class="jl-score-track" cx="18" cy="18" r="15.9"/>
                            <circle class="jl-score-fill" cx="18" cy="18" r="15.9"
                                stroke-dasharray="{{ match_info.percentage }}, 100"/>
                        </svg>
                        <span class="jl-score-text">{{ match_info.percentage }}%</span>
                    </div>
                    {% endif %}
                </div>

                <div class="jl-meta">
                    <span><i class='bx bx-map'></i> {{ job.location }}</span>
                    <span class="jl-type-badge jl-type-{{ job.job_type|slugify }}">{{ job.get_job_type_display }}</span>
                    {% if job.salary %}<span><i class='bx bx-money'></i> {{ job.salary }}</span>{% endif %}
                    <span><i class='bx bx-time-five'></i> {{ job.created_at|timesince }} ago</span>
                </div>

                {% if job.skills %}
                <div class="jl-skills">
                    {% for skill in job.skills|slice:":5" %}
                    <span class="jl-skill">{% if skill.name %}{{ skill.name }}{% else %}{{ skill }}{% endif %}</span>
                    {% endfor %}
                    {% if job.skills|length > 5 %}<span class="jl-skill jl-skill-more">+{{ job.skills|length|add:"-5" }}</span>{% endif %}
                </div>
                {% endif %}

                <div class="jl-card-footer">
                    <a href="{% url 'jobs:job_detail' job_id=job.id %}" class="jl-view-btn">View Details <i class='bx bx-right-arrow-alt'></i></a>
                    <div class="jl-card-actions">
                        <button class="jl-icon-btn bookmark-btn {% if job.id in bookmarked_job_ids %}bookmarked{% endif %}"
                                data-job-id="{{ job.id }}">
                            <i class='bx {% if job.id in bookmarked_job_ids %}bxs-bookmark{% else %}bx-bookmark{% endif %}'></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endwith %}
            {% empty %}
            <div class="jl-empty">
                <i class='bx bx-search-alt'></i>
                <h3>No jobs found</h3>
                <p>Try adjusting your filters or check back later for new opportunities.</p>
                {% if has_filters %}
                <a href="{% url 'jobs:job_listings' %}" class="jl-view-btn" style="padding:.5rem 1rem;">Clear Filters</a>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if jobs.has_other_pages %}
        <div class="jl-pagination">
            {% if jobs.has_previous %}
            <a href="?page={{ jobs.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if location_filter %}&location={{ location_filter }}{% endif %}{% if job_type_filter %}&job_type={{ job_type_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}"
               class="jl-page-link"><i class='bx bx-chevron-left'></i></a>
            {% else %}
            <span class="jl-page-link disabled"><i class='bx bx-chevron-left'></i></span>
            {% endif %}

            {% for page_num in jobs.paginator.page_range %}
                {% if page_num == jobs.number %}
                <span class="jl-page-link active">{{ page_num }}</span>
                {% elif page_num > jobs.number|add:'-3' and page_num < jobs.number|add:'3' %}
                <a href="?page={{ page_num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if location_filter %}&location={{ location_filter }}{% endif %}{% if job_type_filter %}&job_type={{ job_type_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}"
                   class="jl-page-link">{{ page_num }}</a>
                {% elif page_num == 1 or page_num == jobs.paginator.num_pages %}
                <a href="?page={{ page_num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if location_filter %}&location={{ location_filter }}{% endif %}{% if job_type_filter %}&job_type={{ job_type_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}"
                   class="jl-page-link">{{ page_num }}</a>
                {% elif page_num == jobs.number|add:'-3' or page_num == jobs.number|add:'3' %}
                <span class="jl-page-link disabled">&hellip;</span>
                {% endif %}
            {% endfor %}

            {% if jobs.has_next %}
            <a href="?page={{ jobs.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if location_filter %}&location={{ location_filter }}{% endif %}{% if job_type_filter %}&job_type={{ job_type_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}"
               class="jl-page-link"><i class='bx bx-chevron-right'></i></a>
            {% else %}
            <span class="jl-page-link disabled"><i class='bx bx-chevron-right'></i></span>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- ══ BOOKMARKED TAB ══ -->
    <div class="jl-tab-content" id="bookmarked-content">
        {% if bookmarked_jobs %}
        <div class="jl-grid">
            {% for bookmark in bookmarked_jobs %}
            <div class="jl-card" data-job-id="{{ bookmark.job.id }}">
                <div class="jl-card-top">
                    <div class="jl-card-info">
                        <h3><a href="{% url 'jobs:job_detail' job_id=bookmark.job.id %}">{{ bookmark.job.title }}</a></h3>
                        <div class="jl-card-company"><i class='bx bx-buildings'></i> {{ bookmark.job.company }}</div>
                    </div>
                    <i class='bx bxs-bookmark' style="color:#f59e0b; font-size:1.5rem; flex-shrink:0;"></i>
                </div>
                <div class="jl-meta">
                    <span><i class='bx bx-map'></i> {{ bookmark.job.location }}</span>
                    <span class="jl-type-badge jl-type-{{ bookmark.job.job_type|slugify }}">{{ bookmark.job.get_job_type_display }}</span>
                    {% if bookmark.job.salary %}<span><i class='bx bx-money'></i> {{ bookmark.job.salary }}</span>{% endif %}
                </div>
                {% if bookmark.job.skills %}
                <div class="jl-skills">
                    {% for skill in bookmark.job.skills|slice:":4" %}
                    <span class="jl-skill">{% if skill.name %}{{ skill.name }}{% else %}{{ skill }}{% endif %}</span>
                    {% endfor %}
                    {% if bookmark.job.skills|length > 4 %}<span class="jl-skill jl-skill-more">+{{ bookmark.job.skills|length|add:"-4" }}</span>{% endif %}
                </div>
                {% endif %}
                <div class="jl-time"><i class='bx bx-time'></i> Bookmarked {{ bookmark.bookmarked_at|timesince }} ago</div>
                <div class="jl-card-footer">
                    <a href="{% url 'jobs:job_detail' job_id=bookmark.job.id %}" class="jl-view-btn">View Details <i class='bx bx-right-arrow-alt'></i></a>
                    <button class="jl-icon-btn bookmark-btn bookmarked" data-job-id="{{ bookmark.job.id }}">
                        <i class='bx bxs-bookmark'></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="jl-empty">
            <i class='bx bx-bookmark'></i>
            <h3>No Bookmarked Jobs Yet</h3>
            <p>Jobs you bookmark will appear here for easy access</p>
            <button class="jl-view-btn" style="padding:.5rem 1rem;" onclick="switchToTab('all-jobs')">Browse Jobs</button>
        </div>
        {% endif %}
    </div>

    <!-- ══ APPLIED TAB ══ -->
    <div class="jl-tab-content" id="applied-content">
        {% if applied_jobs %}
        <div class="jl-grid">
            {% for application in applied_jobs %}
            <div class="jl-card" data-job-id="{{ application.job.id }}">
                <div class="jl-card-top">
                    <div class="jl-card-info">
                        <h3><a href="{% url 'jobs:job_detail' job_id=application.job.id %}">{{ application.job.title }}</a></h3>
                        <div class="jl-card-company"><i class='bx bx-buildings'></i> {{ application.job.company }}</div>
                    </div>
                    <span class="jl-status-badge jl-status-{{ application.status|slugify }}">{{ application.get_status_display }}</span>
                </div>
                <div class="jl-meta">
                    <span><i class='bx bx-map'></i> {{ application.job.location }}</span>
                    <span class="jl-type-badge jl-type-{{ application.job.job_type|slugify }}">{{ application.job.get_job_type_display }}</span>
                </div>
                <div class="jl-time"><i class='bx bx-time'></i> Applied {{ application.applied_at|timesince }} ago</div>
                <div class="jl-card-footer">
                    <a href="{% url 'jobs:application_detail' application_id=application.id %}" class="jl-view-btn">
                        View Application <i class='bx bx-right-arrow-alt'></i>
                    </a>
                    <a href="{% url 'jobs:job_detail' job_id=application.job.id %}" class="jl-icon-btn" title="View Job">
                        <i class='bx bx-briefcase'></i>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="jl-empty">
            <i class='bx bx-check-square'></i>
            <h3>No Applications Yet</h3>
            <p>Jobs you've applied to will appear here</p>
            <button class="jl-view-btn" style="padding:.5rem 1rem;" onclick="switchToTab('all-jobs')">Browse Jobs</button>
        </div>
        {% endif %}
    </div>
</div>

<script>
(function() {
    /* ── CSRF Token ── */
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value
        || getCookie('csrftoken');

    function getCookie(name) {
        const cookies = document.cookie.split(';');
        for (const c of cookies) {
            const [k, v] = c.trim().split('=');
            if (k === name) return decodeURIComponent(v);
        }
        return null;
    }

    /* ── Tab Navigation ── */
    const tabBtns = document.querySelectorAll('.jl-tab');
    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            tabBtns.forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.jl-tab-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            const content = document.getElementById(this.dataset.tab + '-content');
            if (content) content.classList.add('active');
            setTimeout(initBookmarkButtons, 50);
        });
    });

    function switchToTab(name) {
        tabBtns.forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.jl-tab-content').forEach(c => c.classList.remove('active'));
        const target = document.querySelector(`[data-tab="${name}"]`);
        const content = document.getElementById(name + '-content');
        if (target && content) {
            target.classList.add('active');
            content.classList.add('active');
        }
    }
    window.switchToTab = switchToTab;

    /* ── Bookmark Toggle ── */
    function initBookmarkButtons() {
        document.querySelectorAll('.bookmark-btn').forEach(btn => {
            const clone = btn.cloneNode(true);
            btn.replaceWith(clone);
            clone.addEventListener('click', handleBookmarkClick);
        });
    }

    async function handleBookmarkClick(e) {
        e.preventDefault();
        const btn = this;
        const jobId = btn.dataset.jobId;
        btn.disabled = true;

        try {
            const res = await fetch(`/jobs/toggle-bookmark/${jobId}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken, 'Content-Type': 'application/json' },
                credentials: 'same-origin'
            });
            const data = await res.json();
            if (data.success) {
                // Update ALL bookmark buttons for this job across all tabs
                document.querySelectorAll(`.bookmark-btn[data-job-id="${jobId}"]`).forEach(b => {
                    const icon = b.querySelector('i');
                    if (data.bookmarked) {
                        b.classList.add('bookmarked');
                        icon.className = 'bx bxs-bookmark';
                    } else {
                        b.classList.remove('bookmarked');
                        icon.className = 'bx bx-bookmark';
                    }
                });

                showNotification(data.message, data.bookmarked ? 'success' : 'info');

                // If unbookmarked from bookmarked tab, remove card
                if (!data.bookmarked) {
                    const card = document.querySelector(`#bookmarked-content .jl-card[data-job-id="${jobId}"]`);
                    if (card) {
                        card.style.opacity = '0';
                        card.style.transform = 'scale(.95)';
                        setTimeout(() => {
                            card.remove();
                            checkBookmarkedEmpty();
                        }, 250);
                    }
                }
            } else {
                showNotification(data.message || 'Error updating bookmark', 'error');
            }
        } catch(err) {
            console.error(err);
            showNotification('Error updating bookmark', 'error');
        } finally {
            btn.disabled = false;
        }
    }

    function checkBookmarkedEmpty() {
        const content = document.getElementById('bookmarked-content');
        if (content && !content.querySelector('.jl-card')) {
            content.innerHTML = `
                <div class="jl-empty">
                    <i class='bx bx-bookmark'></i>
                    <h3>No Bookmarked Jobs Yet</h3>
                    <p>Jobs you bookmark will appear here for easy access</p>
                    <button class="jl-view-btn" style="padding:.5rem 1rem;" onclick="switchToTab('all-jobs')">Browse Jobs</button>
                </div>`;
        }
    }

    /* ── Notifications ── */
    function showNotification(message, type) {
        type = type || 'info';
        let container = document.querySelector('.jl-messages');
        if (!container) {
            container = document.createElement('div');
            container.className = 'jl-messages';
            const header = document.querySelector('.jl-header');
            if (header) header.parentNode.insertBefore(container, header.nextSibling);
            else document.body.prepend(container);
        }
        const icons = {
            success: 'bx-check-circle',
            error: 'bx-error',
            warning: 'bx-error-circle',
            info: 'bx-info-circle'
        };
        const el = document.createElement('div');
        el.className = 'jl-msg ' + type;
        el.innerHTML = '<i class="bx ' + (icons[type] || icons.info) + '"></i>'
            + '<p>' + message + '</p>'
            + '<button class="jl-msg-close" onclick="this.parentElement.remove()"><i class="bx bx-x"></i></button>';
        container.appendChild(el);
        setTimeout(() => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(-10px)';
            el.style.transition = 'all .3s';
            setTimeout(() => el.remove(), 300);
        }, 5000);
    }

    /* ── Auto-submit filters on select change ── */
    document.querySelectorAll('#jlFilterForm .jl-select').forEach(sel => {
        sel.addEventListener('change', () => {
            document.getElementById('jlFilterForm')?.submit();
        });
    });

    /* ── Theme awareness ── */
    const theme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', theme);
    window.addEventListener('theme-change', function(e) {
        document.documentElement.setAttribute('data-theme', e.detail.theme);
    });

    /* ── Init ── */
    initBookmarkButtons();
})();
</script>
{% endblock %}
