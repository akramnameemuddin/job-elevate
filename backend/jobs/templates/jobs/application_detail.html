{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Application – {{ application.job.title }}{% endblock %}

{% block content %}
<style>
/* ══════════════════════════════════════════════
   Application Detail Page  (ad- namespace)
   ══════════════════════════════════════════════ */
.ad-grid { display: grid; grid-template-columns: 1fr 340px; gap: 1.5rem; }
@media(max-width:900px) { .ad-grid { grid-template-columns: 1fr; } }

/* ── Status banner ── */
.ad-status-bar {
    border-radius: 14px; padding: 1.25rem 1.5rem;
    display: flex; align-items: center; gap: 1.15rem; margin-bottom: 1.5rem;
    border: 1px solid; flex-wrap: wrap;
}
.ad-status-bar.applied    { background: rgba(79,70,229,.06); border-color: rgba(79,70,229,.25); }
.ad-status-bar.shortlisted { background: rgba(59,130,246,.06); border-color: rgba(59,130,246,.25); }
.ad-status-bar.interview   { background: rgba(245,158,11,.06); border-color: rgba(245,158,11,.25); }
.ad-status-bar.offered     { background: rgba(34,197,94,.06); border-color: rgba(34,197,94,.25); }
.ad-status-bar.hired       { background: rgba(34,197,94,.08); border-color: rgba(34,197,94,.35); }
.ad-status-bar.rejected    { background: rgba(239,68,68,.06); border-color: rgba(239,68,68,.25); }
.ad-status-icon {
    width: 48px; height: 48px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem; flex-shrink: 0;
}
.ad-status-bar.applied .ad-status-icon    { background: rgba(79,70,229,.15); color: var(--primary-color); }
.ad-status-bar.shortlisted .ad-status-icon { background: rgba(59,130,246,.15); color: #3b82f6; }
.ad-status-bar.interview .ad-status-icon   { background: rgba(245,158,11,.15); color: #d97706; }
.ad-status-bar.offered .ad-status-icon     { background: rgba(34,197,94,.15); color: #16a34a; }
.ad-status-bar.hired .ad-status-icon       { background: rgba(34,197,94,.2); color: #15803d; }
.ad-status-bar.rejected .ad-status-icon    { background: rgba(239,68,68,.15); color: #ef4444; }
.ad-status-text h3 { font-size: 1.1rem; font-weight: 600; margin: 0 0 .15rem; color: var(--heading-color); }
.ad-status-text p  { font-size: .85rem; color: var(--text-muted); margin: 0; }

/* ── Cards ── */
.ad-card {
    background: var(--card-bg); border: 1px solid var(--border-color);
    border-radius: 14px; padding: 1.25rem 1.5rem; margin-bottom: 1.25rem;
}
.ad-card-title {
    font-size: .95rem; font-weight: 600; color: var(--heading-color);
    margin: 0 0 1rem; display: flex; align-items: center; gap: .45rem;
}
.ad-card-title i { font-size: 1.15rem; color: var(--primary-color); }

/* ── Job info header ── */
.ad-job-header { display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem; }
.ad-job-avatar {
    width: 56px; height: 56px; border-radius: 14px;
    background: linear-gradient(135deg, var(--primary-color), #6f42c1);
    color: #fff; font-weight: 700; font-size: 1.2rem;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; text-transform: uppercase;
}
.ad-job-info h2 { font-size: 1.2rem; font-weight: 700; color: var(--heading-color); margin: 0 0 .25rem; }
.ad-job-meta {
    display: flex; flex-wrap: wrap; gap: .25rem .75rem;
    font-size: .82rem; color: var(--text-muted);
}
.ad-job-meta span { display: flex; align-items: center; gap: .25rem; }

/* ── Detail rows ── */
.ad-detail-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: .65rem 0; border-bottom: 1px solid var(--border-color);
}
.ad-detail-row:last-child { border-bottom: none; }
.ad-detail-row .label { font-size: .82rem; color: var(--text-muted); }
.ad-detail-row .value { font-size: .88rem; font-weight: 500; color: var(--heading-color); }

/* ── Timeline ── */
.ad-timeline { padding: 0; margin: 0; list-style: none; }
.ad-tl-item {
    display: flex; gap: .85rem; padding-bottom: 1.25rem;
    position: relative;
}
.ad-tl-item:last-child { padding-bottom: 0; }
.ad-tl-item::before {
    content: ''; position: absolute; left: 14px; top: 28px;
    width: 2px; height: calc(100% - 28px);
    background: var(--border-color);
}
.ad-tl-item:last-child::before { display: none; }
.ad-tl-dot {
    width: 30px; height: 30px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: .85rem; flex-shrink: 0; z-index: 1;
}
.ad-tl-dot.done { background: rgba(34,197,94,.12); color: #22c55e; }
.ad-tl-dot.current { background: rgba(79,70,229,.12); color: var(--primary-color); }
.ad-tl-dot.pending { background: var(--hover-bg); color: var(--text-muted); }
.ad-tl-dot.rejected { background: rgba(239,68,68,.12); color: #ef4444; }
.ad-tl-content h4 { font-size: .88rem; font-weight: 600; color: var(--heading-color); margin: 0 0 .15rem; }
.ad-tl-content p  { font-size: .78rem; color: var(--text-muted); margin: 0; }

/* ── Cover letter ── */
.ad-cover-letter {
    background: var(--hover-bg); border-radius: 10px; padding: 1rem 1.25rem;
    font-size: .88rem; color: var(--text-color); line-height: 1.6;
    white-space: pre-wrap; max-height: 200px; overflow-y: auto;
}

/* ── Messages thread ── */
.ad-msg-list { display: flex; flex-direction: column; gap: .75rem; max-height: 350px; overflow-y: auto; padding-right: .5rem; }
.ad-msg {
    display: flex; gap: .65rem; align-items: flex-start;
}
.ad-msg.self { flex-direction: row-reverse; }
.ad-msg-avatar {
    width: 32px; height: 32px; border-radius: 50%;
    background: var(--hover-bg); color: var(--text-muted);
    display: flex; align-items: center; justify-content: center;
    font-size: .75rem; font-weight: 600; flex-shrink: 0;
}
.ad-msg.self .ad-msg-avatar { background: rgba(79,70,229,.12); color: var(--primary-color); }
.ad-msg-bubble {
    background: var(--hover-bg); border-radius: 12px; padding: .65rem 1rem;
    max-width: 75%; font-size: .85rem; color: var(--text-color); line-height: 1.5;
}
.ad-msg.self .ad-msg-bubble { background: rgba(79,70,229,.08); }
.ad-msg-time { font-size: .7rem; color: var(--text-muted); margin-top: .2rem; }

/* ── Message form ── */
.ad-msg-form {
    display: flex; gap: .5rem; margin-top: .75rem; padding-top: .75rem;
    border-top: 1px solid var(--border-color);
}
.ad-msg-form textarea {
    flex: 1; border: 1px solid var(--border-color); border-radius: 10px;
    padding: .6rem .85rem; font-size: .85rem; resize: none; min-height: 42px;
    background: var(--bg-color); color: var(--text-color);
    font-family: inherit;
}
.ad-msg-form textarea:focus { border-color: var(--primary-color); outline: none; }
.ad-msg-form button {
    width: 42px; height: 42px; border-radius: 10px;
    background: var(--primary-color); color: #fff; border: none;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem; flex-shrink: 0; transition: opacity .15s;
}
.ad-msg-form button:hover { opacity: .9; }
</style>

<!-- Breadcrumb -->
<div class="breadcrumb">
    <div class="breadcrumb-item">
        <a href="{% url 'dashboard:home' %}" class="breadcrumb-link">Home</a>
        <i class='bx bx-chevron-right'></i>
    </div>
    <div class="breadcrumb-item">
        <a href="{% url 'jobs:my_applications' %}" class="breadcrumb-link">Applications</a>
        <i class='bx bx-chevron-right'></i>
    </div>
    <div class="breadcrumb-item"><span>{{ application.job.title|truncatechars:30 }}</span></div>
</div>

<!-- Page Header -->
<div class="page-content-header">
    <div>
        <h1 class="page-title"><i class='bx bx-detail' style="color:var(--primary-color)"></i> Application Details</h1>
        <p class="page-subtitle">{{ application.job.title }} at {{ application.job.company }}</p>
    </div>
    <div style="display:flex; gap:.5rem;">
        <a href="{% url 'jobs:job_detail' application.job.id %}" class="btn btn-outline-secondary btn-sm">
            <i class='bx bx-link-external'></i> View Job
        </a>
        <a href="{% url 'jobs:my_applications' %}" class="btn btn-outline-secondary btn-sm">
            <i class='bx bx-arrow-back'></i> Back
        </a>
    </div>
</div>

<!-- Status Banner -->
<div class="ad-status-bar {{ application.status|lower }}">
    <div class="ad-status-icon">
        {% if application.status == 'Applied' %}<i class='bx bx-send'></i>
        {% elif application.status == 'Shortlisted' %}<i class='bx bx-list-check'></i>
        {% elif application.status == 'Interview' %}<i class='bx bx-video'></i>
        {% elif application.status == 'Offered' %}<i class='bx bx-gift'></i>
        {% elif application.status == 'Hired' %}<i class='bx bx-check-shield'></i>
        {% elif application.status == 'Rejected' %}<i class='bx bx-x-circle'></i>
        {% endif %}
    </div>
    <div class="ad-status-text">
        <h3>Status: {{ application.status }}</h3>
        <p>
            {% if application.status == 'Applied' %}Your application has been submitted and is under review.
            {% elif application.status == 'Shortlisted' %}Great news! You've been shortlisted for this position.
            {% elif application.status == 'Interview' %}You've been selected for an interview. Check messages for details.
            {% elif application.status == 'Offered' %}Congratulations! You've received a job offer.
            {% elif application.status == 'Hired' %}Welcome aboard! You've been hired for this position.
            {% elif application.status == 'Rejected' %}Unfortunately, your application was not selected this time.
            {% endif %}
        </p>
    </div>
</div>

<div class="ad-grid">
    <!-- Left column -->
    <div>
        <!-- Job Info -->
        <div class="ad-card">
            <div class="ad-job-header">
                <div class="ad-job-avatar">{{ application.job.company|truncatechars:2 }}</div>
                <div class="ad-job-info">
                    <h2>{{ application.job.title }}</h2>
                    <div class="ad-job-meta">
                        <span><i class='bx bx-buildings'></i> {{ application.job.company }}</span>
                        <span><i class='bx bx-map'></i> {{ application.job.location }}</span>
                        <span><i class='bx bx-briefcase-alt-2'></i> {{ application.job.job_type }}</span>
                        {% if application.job.salary %}
                        <span><i class='bx bx-money'></i> {{ application.job.salary }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="ad-detail-row">
                <span class="label">Applied On</span>
                <span class="value">{{ application.applied_at|date:"F d, Y \a\t g:i A" }}</span>
            </div>
            <div class="ad-detail-row">
                <span class="label">Last Updated</span>
                <span class="value">{{ application.updated_at|date:"F d, Y \a\t g:i A" }}</span>
            </div>
            {% if application.resume %}
            <div class="ad-detail-row">
                <span class="label">Resume</span>
                <span class="value">
                    <a href="{{ application.resume.url }}" target="_blank" style="color:var(--primary-color); text-decoration:none; display:flex; align-items:center; gap:.3rem;">
                        <i class='bx bx-download'></i> Download Resume
                    </a>
                </span>
            </div>
            {% endif %}
        </div>

        <!-- Cover Letter -->
        {% if application.cover_letter %}
        <div class="ad-card">
            <h3 class="ad-card-title"><i class='bx bx-envelope'></i> Cover Letter</h3>
            <div class="ad-cover-letter">{{ application.cover_letter }}</div>
        </div>
        {% endif %}

        <!-- Messages -->
        <div class="ad-card">
            <h3 class="ad-card-title"><i class='bx bx-chat'></i> Messages</h3>
            {% if messages %}
            <div class="ad-msg-list">
                {% for msg in messages %}
                <div class="ad-msg {% if msg.sender == request.user %}self{% endif %}">
                    <div class="ad-msg-avatar">
                        {% if msg.sender == request.user %}ME{% else %}HR{% endif %}
                    </div>
                    <div>
                        <div class="ad-msg-bubble">{{ msg.content }}</div>
                        <div class="ad-msg-time">{{ msg.sent_at|date:"M d, g:i A" }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p style="font-size:.85rem; color:var(--text-muted); text-align:center; padding:1rem 0;">
                No messages yet. Send a message to the recruiter below.
            </p>
            {% endif %}

            <form class="ad-msg-form" method="post" action="{% url 'jobs:send_application_message' application.id %}">
                {% csrf_token %}
                <textarea name="message" placeholder="Type your message..." rows="1" required></textarea>
                <button type="submit"><i class='bx bx-send'></i></button>
            </form>
        </div>
    </div>

    <!-- Right sidebar -->
    <div>
        <!-- Application Timeline -->
        <div class="ad-card">
            <h3 class="ad-card-title"><i class='bx bx-git-branch'></i> Application Timeline</h3>
            <ul class="ad-timeline">
                {% with s=application.status %}
                <li class="ad-tl-item">
                    <div class="ad-tl-dot done"><i class='bx bx-check'></i></div>
                    <div class="ad-tl-content">
                        <h4>Applied</h4>
                        <p>{{ application.applied_at|date:"M d, Y" }}</p>
                    </div>
                </li>
                <li class="ad-tl-item">
                    <div class="ad-tl-dot {% if s == 'Shortlisted' or s == 'Interview' or s == 'Offered' or s == 'Hired' %}done{% elif s == 'Applied' %}current{% elif s == 'Rejected' %}rejected{% else %}pending{% endif %}">
                        {% if s == 'Shortlisted' or s == 'Interview' or s == 'Offered' or s == 'Hired' %}<i class='bx bx-check'></i>{% elif s == 'Rejected' %}<i class='bx bx-x'></i>{% else %}<i class='bx bx-loader-alt'></i>{% endif %}
                    </div>
                    <div class="ad-tl-content">
                        <h4>Under Review</h4>
                        <p>{% if s == 'Applied' %}In progress{% elif s == 'Rejected' %}Application reviewed{% else %}Completed{% endif %}</p>
                    </div>
                </li>
                <li class="ad-tl-item">
                    <div class="ad-tl-dot {% if s == 'Interview' or s == 'Offered' or s == 'Hired' %}done{% elif s == 'Shortlisted' %}current{% else %}pending{% endif %}">
                        {% if s == 'Interview' or s == 'Offered' or s == 'Hired' %}<i class='bx bx-check'></i>{% elif s == 'Shortlisted' %}<i class='bx bx-loader-alt'></i>{% else %}<i class='bx bx-minus'></i>{% endif %}
                    </div>
                    <div class="ad-tl-content">
                        <h4>Interview</h4>
                        <p>{% if s == 'Interview' %}Scheduled{% elif s == 'Offered' or s == 'Hired' %}Completed{% else %}Pending{% endif %}</p>
                    </div>
                </li>
                <li class="ad-tl-item">
                    <div class="ad-tl-dot {% if s == 'Offered' or s == 'Hired' %}done{% elif s == 'Interview' %}current{% else %}pending{% endif %}">
                        {% if s == 'Offered' or s == 'Hired' %}<i class='bx bx-check'></i>{% else %}<i class='bx bx-minus'></i>{% endif %}
                    </div>
                    <div class="ad-tl-content">
                        <h4>Decision</h4>
                        <p>{% if s == 'Offered' %}Offer received{% elif s == 'Hired' %}Hired!{% elif s == 'Rejected' %}Not selected{% else %}Awaiting{% endif %}</p>
                    </div>
                </li>
                {% endwith %}
            </ul>
        </div>

        <!-- Quick Actions -->
        <div class="ad-card">
            <h3 class="ad-card-title"><i class='bx bx-zap'></i> Quick Actions</h3>
            <div style="display:flex; flex-direction:column; gap:.5rem;">
                <a href="{% url 'jobs:job_detail' application.job.id %}" class="btn btn-outline-primary btn-sm" style="justify-content:flex-start;">
                    <i class='bx bx-link-external'></i> View Full Job Details
                </a>
                {% if application.resume %}
                <a href="{{ application.resume.url }}" target="_blank" class="btn btn-outline-secondary btn-sm" style="justify-content:flex-start;">
                    <i class='bx bx-download'></i> Download Submitted Resume
                </a>
                {% endif %}
                <a href="{% url 'jobs:my_applications' %}" class="btn btn-outline-secondary btn-sm" style="justify-content:flex-start;">
                    <i class='bx bx-list-ul'></i> All Applications
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
