{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{{ job.title }} at {{ job.company }} | JobElevate{% endblock %}

{% block content %}
<style>
/* Job Detail Page (jd- namespace) */
.jd-grid { display: grid; grid-template-columns: 1fr; gap: 1.25rem; }
@media(min-width:1024px){ .jd-grid { grid-template-columns: 1fr 340px; } }
@media(min-width:1200px){ .jd-grid { grid-template-columns: 1fr 360px; } }

/* Hero Card */
.jd-hero {
    background: var(--card-bg); border: 1px solid var(--border-color);
    border-radius: 16px; padding: 1.5rem; position: relative; overflow: hidden;
}
.jd-hero::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
    background: linear-gradient(90deg, var(--primary-color), #8b5cf6, #ec4899);
}
.jd-hero-top { display: flex; gap: 1rem; align-items: flex-start; margin-bottom: 1.25rem; }
.jd-logo {
    width: 56px; height: 56px; border-radius: 14px; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    background: var(--hover-bg); border: 1px solid var(--border-color);
    font-size: 1.5rem; color: var(--primary-color);
}
.jd-logo img { width: 100%; height: 100%; object-fit: contain; border-radius: 14px; }
.jd-hero-info { flex: 1; min-width: 0; }
.jd-hero-title {
    font-size: 1.35rem; font-weight: 700; color: var(--heading-color);
    margin: 0 0 .4rem; line-height: 1.3;
}
.jd-hero-company { font-size: .92rem; color: var(--text-muted); margin-bottom: .6rem; }
.jd-tags { display: flex; flex-wrap: wrap; gap: .4rem; }
.jd-tag {
    display: inline-flex; align-items: center; gap: .3rem;
    padding: .3rem .65rem; border-radius: 8px; font-size: .78rem; font-weight: 500;
    background: var(--hover-bg); color: var(--text-muted); border: 1px solid var(--border-color);
}
.jd-tag i { font-size: .9rem; color: var(--primary-color); }

/* Action Buttons */
.jd-actions { display: flex; flex-wrap: wrap; gap: .6rem; padding-top: 1.25rem; border-top: 1px solid var(--border-color); }
.jd-btn {
    display: inline-flex; align-items: center; gap: .4rem;
    padding: .6rem 1.1rem; border-radius: 10px; font-size: .85rem; font-weight: 600;
    cursor: pointer; border: 1px solid var(--border-color); text-decoration: none;
    transition: all .2s; background: var(--card-bg); color: var(--heading-color);
}
.jd-btn:hover { border-color: var(--primary-color); background: var(--hover-bg); }
.jd-btn-primary { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
.jd-btn-primary:hover { opacity: .9; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(79,70,229,.3); }
.jd-btn-success { background: #22c55e; color: #fff; border-color: #22c55e; cursor: default; }
.jd-btn i { font-size: 1.05rem; }
.jd-btn-sm { padding: .4rem .75rem; font-size: .78rem; }

/* Match Ring */
.jd-match-ring { display: flex; align-items: center; gap: 1rem; padding: 1rem 0; }
.jd-ring-svg { width: 80px; height: 80px; flex-shrink: 0; }
.jd-ring-bg { fill: none; stroke: var(--border-color); stroke-width: 6; }
.jd-ring-fill { fill: none; stroke-width: 6; stroke-linecap: round; transition: stroke-dashoffset .8s ease; }
.jd-ring-fill.excellent { stroke: #22c55e; }
.jd-ring-fill.good { stroke: #3b82f6; }
.jd-ring-fill.moderate { stroke: #f59e0b; }
.jd-ring-fill.low { stroke: #ef4444; }
.jd-ring-text { font-size: 1.1rem; font-weight: 700; fill: var(--heading-color); text-anchor: middle; dominant-baseline: central; }
.jd-ring-info h4 { font-size: .85rem; color: var(--text-muted); margin: 0 0 .15rem; }
.jd-ring-info .jd-ring-pct { font-size: 1.5rem; font-weight: 700; color: var(--heading-color); }
.jd-ring-info .jd-ring-label { font-size: .78rem; color: var(--text-muted); }

/* Cards */
.jd-card {
    background: var(--card-bg); border: 1px solid var(--border-color);
    border-radius: 14px; overflow: hidden;
}
.jd-card-head {
    padding: 1rem 1.25rem; border-bottom: 1px solid var(--border-color);
    display: flex; align-items: center; justify-content: space-between; gap: .5rem;
}
.jd-card-head h3 {
    font-size: .95rem; font-weight: 600; color: var(--heading-color);
    display: flex; align-items: center; gap: .4rem; margin: 0;
}
.jd-card-head h3 i { color: var(--primary-color); font-size: 1.15rem; }
.jd-card-body { padding: 1.25rem; }

/* Skill Pills */
.jd-skill-list { display: flex; flex-wrap: wrap; gap: .5rem; }
.jd-skill {
    display: inline-flex; align-items: center; gap: .35rem;
    padding: .45rem .85rem; border-radius: 10px; font-size: .82rem; font-weight: 500;
    border: 1px solid; transition: all .15s;
}
.jd-skill-qualified { background: rgba(34,197,94,.08); color: #16a34a; border-color: rgba(34,197,94,.3); }
.jd-skill-qualified i { color: #16a34a; }
.jd-skill-improve { background: rgba(245,158,11,.08); color: #d97706; border-color: rgba(245,158,11,.3); }
.jd-skill-improve i { color: #d97706; }
.jd-skill-missing { background: rgba(239,68,68,.06); color: #dc2626; border-color: rgba(239,68,68,.2); }
.jd-skill-missing i { color: #dc2626; }
.jd-skill-neutral { background: var(--hover-bg); color: var(--heading-color); border-color: var(--border-color); }
.jd-skill-type {
    font-size: .65rem; padding: .1rem .35rem; border-radius: 4px; font-weight: 600;
    text-transform: uppercase; letter-spacing: .3px; margin-left: .15rem;
}
.jd-type-must { background: rgba(239,68,68,.12); color: #ef4444; }
.jd-type-important { background: rgba(245,158,11,.12); color: #d97706; }
.jd-type-nice { background: rgba(59,130,246,.12); color: #3b82f6; }

/* Status Badge */
.jd-status {
    font-size: .7rem; font-weight: 600; padding: .15rem .45rem;
    border-radius: 6px; text-transform: uppercase; letter-spacing: .3px;
}
.jd-status-pass { background: rgba(34,197,94,.12); color: #16a34a; }
.jd-status-fail { background: rgba(239,68,68,.1); color: #dc2626; }

/* Assessment Banner */
.jd-assess-banner {
    display: flex; align-items: center; gap: 1rem; padding: 1rem 1.25rem;
    background: linear-gradient(135deg, rgba(79,70,229,.06), rgba(139,92,246,.06));
    border-radius: 12px; border: 1px solid rgba(79,70,229,.15); margin-top: 1rem;
}
.jd-assess-banner i { font-size: 1.8rem; color: var(--primary-color); flex-shrink: 0; }
.jd-assess-banner .jd-assess-text { flex: 1; }
.jd-assess-banner .jd-assess-text h4 { font-size: .88rem; color: var(--heading-color); margin: 0 0 .15rem; }
.jd-assess-banner .jd-assess-text p { font-size: .8rem; color: var(--text-muted); margin: 0; }

/* Prose */
.jd-prose { font-size: .9rem; line-height: 1.7; color: var(--text-muted); }
.jd-prose p { margin-bottom: .8rem; }
.jd-prose ul { padding-left: 1.2rem; margin-bottom: .8rem; }
.jd-prose ul li { margin-bottom: .4rem; }

/* Sidebar */
.jd-sidebar { display: flex; flex-direction: column; gap: 1.25rem; }
@media(min-width:1024px){ .jd-sidebar { position: sticky; top: 1.5rem; align-self: start; } }
.jd-side-card {
    background: var(--card-bg); border: 1px solid var(--border-color);
    border-radius: 14px; overflow: hidden;
}
.jd-side-head {
    padding: .85rem 1.15rem; border-bottom: 1px solid var(--border-color);
    font-size: .88rem; font-weight: 600; color: var(--heading-color);
    display: flex; align-items: center; gap: .4rem;
}
.jd-side-head i { color: var(--primary-color); font-size: 1.1rem; }
.jd-side-body { padding: 1.15rem; }

/* Sidebar Tags */
.jd-stag-list { display: flex; flex-wrap: wrap; gap: .35rem; }
.jd-stag {
    display: inline-flex; align-items: center; gap: .25rem;
    padding: .3rem .6rem; border-radius: 8px; font-size: .75rem; font-weight: 500;
}
.jd-stag-match { background: rgba(34,197,94,.1); color: #16a34a; }
.jd-stag-match i { font-size: .7rem; }
.jd-stag-gap { background: var(--hover-bg); color: var(--text-muted); }

/* Similar Jobs */
.jd-sim-item {
    display: flex; align-items: center; gap: .75rem; padding: .75rem;
    border-radius: 10px; transition: all .15s; text-decoration: none;
    border: 1px solid transparent; margin-bottom: .5rem;
}
.jd-sim-item:last-child { margin-bottom: 0; }
.jd-sim-item:hover { background: var(--hover-bg); border-color: var(--border-color); }
.jd-sim-info { flex: 1; min-width: 0; }
.jd-sim-info h4 { font-size: .85rem; font-weight: 600; color: var(--heading-color); margin: 0 0 .2rem; }
.jd-sim-meta { font-size: .75rem; color: var(--text-muted); display: flex; gap: .6rem; flex-wrap: wrap; }
.jd-sim-meta span { display: flex; align-items: center; gap: .2rem; }
.jd-sim-arrow { color: var(--text-muted); font-size: 1.1rem; transition: .15s; }
.jd-sim-item:hover .jd-sim-arrow { color: var(--primary-color); transform: translateX(3px); }

/* Modal */
.jd-modal {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,.45);
    z-index: 1000; align-items: flex-start; justify-content: center;
    padding: 1rem; overflow-y: auto; backdrop-filter: blur(2px);
}
.jd-modal-box {
    background: var(--card-bg); border-radius: 16px; width: 100%; max-width: 540px;
    margin-top: 3vh; box-shadow: 0 20px 60px rgba(0,0,0,.2);
    animation: jdModalIn .25s ease;
}
@keyframes jdModalIn { from { opacity:0; transform:translateY(-10px) scale(.97); } to { opacity:1; transform:none; } }
.jd-modal-head {
    display: flex; justify-content: space-between; align-items: center;
    padding: 1.15rem 1.25rem; border-bottom: 1px solid var(--border-color);
}
.jd-modal-head h2 { font-size: 1.05rem; font-weight: 600; color: var(--heading-color); margin: 0; }
.jd-modal-close {
    width: 32px; height: 32px; border-radius: 8px; border: 1px solid var(--border-color);
    background: var(--card-bg); cursor: pointer; display: flex; align-items: center; justify-content: center;
    color: var(--text-muted); transition: .15s;
}
.jd-modal-close:hover { background: var(--hover-bg); color: var(--heading-color); }
.jd-modal-body { padding: 1.25rem; }
.jd-modal-foot {
    display: flex; justify-content: flex-end; gap: .5rem;
    padding: 1rem 1.25rem; border-top: 1px solid var(--border-color); background: var(--hover-bg);
}

/* Form */
.jd-form-group { margin-bottom: 1.15rem; }
.jd-form-group label { display: block; font-size: .85rem; font-weight: 600; color: var(--heading-color); margin-bottom: .4rem; }
.jd-form-group textarea {
    width: 100%; padding: .75rem; border: 1px solid var(--border-color);
    border-radius: 10px; background: var(--card-bg); color: var(--heading-color);
    font-family: inherit; font-size: .88rem; resize: vertical; min-height: 100px;
    transition: border-color .15s;
}
.jd-form-group textarea:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(79,70,229,.1); }
.jd-form-hint { font-size: .75rem; color: var(--text-muted); margin-top: .25rem; }

/* Resume Selector */
.jd-resume-list { display: flex; flex-direction: column; gap: .4rem; max-height: 180px; overflow-y: auto; }
.jd-resume-opt {
    display: flex; align-items: center; gap: .65rem; padding: .65rem .85rem;
    border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer;
    transition: all .15s; background: var(--card-bg); position: relative;
}
.jd-resume-opt:hover { border-color: var(--primary-color); background: var(--hover-bg); }
.jd-resume-opt input[type="radio"] { position: absolute; opacity: 0; width: 0; height: 0; }
.jd-resume-opt:has(input:checked) { border-color: var(--primary-color); background: rgba(79,70,229,.04); }
.jd-resume-opt:has(input:checked) .jd-resume-check { color: var(--primary-color); opacity: 1; }
.jd-resume-icon { font-size: 1.3rem; color: var(--primary-color); flex-shrink: 0; }
.jd-resume-meta { flex: 1; min-width: 0; }
.jd-resume-meta strong { display: block; font-size: .85rem; color: var(--heading-color); }
.jd-resume-meta small { font-size: .73rem; color: var(--text-muted); }
.jd-resume-check { font-size: 1.15rem; color: var(--border-color); opacity: .4; transition: .15s; }
.jd-no-resume {
    display: flex; align-items: center; gap: .75rem; padding: 1rem;
    border: 2px dashed var(--border-color); border-radius: 10px;
    background: var(--hover-bg); color: var(--text-muted); font-size: .85rem;
}
.jd-no-resume i { font-size: 1.3rem; color: var(--primary-color); }

/* Match Summary */
.jd-summary {
    background: var(--hover-bg); border-radius: 10px; padding: .85rem 1rem;
    margin-top: .5rem; border: 1px solid var(--border-color);
}
.jd-summary h4 { font-size: .85rem; font-weight: 600; color: var(--heading-color); margin: 0 0 .6rem; }
.jd-summary-row { display: flex; align-items: center; gap: .4rem; font-size: .82rem; color: var(--text-muted); margin-bottom: .4rem; }
.jd-summary-row:last-child { margin-bottom: 0; }
.jd-summary-row i { font-size: .95rem; }
.jd-summary-row i.green { color: #22c55e; }
.jd-summary-row i.amber { color: #f59e0b; }
.jd-summary-row i.red { color: #ef4444; }

/* Share */
.jd-share-link { display: flex; gap: .5rem; margin-bottom: 1rem; }
.jd-share-link input {
    flex: 1; padding: .6rem .75rem; border: 1px solid var(--border-color);
    border-radius: 8px; background: var(--card-bg); color: var(--heading-color); font-size: .82rem;
}
.jd-share-btns { display: grid; grid-template-columns: 1fr 1fr; gap: .5rem; }
.jd-share-btn {
    display: flex; align-items: center; justify-content: center; gap: .4rem;
    padding: .65rem; border-radius: 10px; font-size: .82rem; font-weight: 500;
    text-decoration: none; transition: .15s; border: 1px solid var(--border-color);
    background: var(--card-bg); color: var(--heading-color);
}
.jd-share-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.1); }
.jd-share-btn.linkedin { background: #0077b5; color: #fff; border-color: #0077b5; }
.jd-share-btn.twitter { background: #1da1f2; color: #fff; border-color: #1da1f2; }
.jd-share-btn.email { grid-column: span 2; background: var(--hover-bg); }

/* Notifications */
.jd-notif {
    display: flex; align-items: center; gap: .5rem; padding: .75rem 1rem;
    border-radius: 10px; margin-bottom: .75rem; font-size: .85rem;
    border: 1px solid var(--border-color); background: var(--card-bg);
}
.jd-notif.success { border-left: 4px solid #22c55e; }
.jd-notif.success i { color: #22c55e; }
.jd-notif.error { border-left: 4px solid #ef4444; }
.jd-notif.error i { color: #ef4444; }
.jd-notif.warning { border-left: 4px solid #f59e0b; }
.jd-notif.warning i { color: #f59e0b; }
.jd-notif span { flex: 1; color: var(--heading-color); }
.jd-notif-close { background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 1rem; padding: .2rem; }

/* Responsive */
@media(max-width:640px){
    .jd-hero { padding: 1rem; }
    .jd-hero-title { font-size: 1.15rem; }
    .jd-actions { flex-direction: column; }
    .jd-actions .jd-btn { width: 100%; justify-content: center; }
    .jd-modal-box { margin-top: 1rem; }
}
@media(min-width:768px){
    .jd-hero { padding: 2rem; }
    .jd-hero-title { font-size: 1.5rem; }
    .jd-logo { width: 64px; height: 64px; }
}
</style>

<!-- Breadcrumb -->
<div class="breadcrumb">
    <div class="breadcrumb-item">
        <a href="{% url 'dashboard:home' %}" class="breadcrumb-link">Home</a>
        <i class='bx bx-chevron-right'></i>
    </div>
    <div class="breadcrumb-item">
        <a href="{% url 'jobs:job_listings' %}" class="breadcrumb-link">Job Matches</a>
        <i class='bx bx-chevron-right'></i>
    </div>
    <div class="breadcrumb-item"><span>{{ job.title }}</span></div>
</div>

<!-- Page Header -->
<div class="page-content-header">
    <h1 class="page-title">{{ job.title }}</h1>
    <p class="page-subtitle">{{ job.company }} &bull; {{ job.location }}</p>
</div>

<!-- Messages -->
{% if messages %}
{% for message in messages %}
<div class="jd-notif {{ message.tags }}">
    <i class='bx {% if message.tags == "success" %}bx-check-circle{% elif message.tags == "error" %}bx-error{% else %}bx-info-circle{% endif %}'></i>
    <span>{{ message }}</span>
    <button class="jd-notif-close" onclick="this.parentNode.remove()"><i class='bx bx-x'></i></button>
</div>
{% endfor %}
{% endif %}

<!-- HERO CARD -->
<div class="jd-hero">
    <div class="jd-hero-top">
        {% if job.company_logo %}
        <div class="jd-logo"><img src="{{ job.company_logo.url }}" alt="{{ job.company }}"></div>
        {% else %}
        <div class="jd-logo"><i class='bx bx-building-house'></i></div>
        {% endif %}
        <div class="jd-hero-info">
            <h2 class="jd-hero-title">{{ job.title }}</h2>
            <div class="jd-hero-company">{{ job.company }}</div>
            <div class="jd-tags">
                <span class="jd-tag"><i class='bx bx-map'></i> {{ job.location }}</span>
                <span class="jd-tag"><i class='bx bx-time'></i> {{ job.job_type }}</span>
                {% if job.salary %}<span class="jd-tag"><i class='bx bx-dollar-circle'></i> {{ job.salary }}</span>{% endif %}
                {% if job.experience %}<span class="jd-tag"><i class='bx bx-briefcase'></i> {{ job.experience }}+ yrs</span>{% endif %}
                <span class="jd-tag"><i class='bx bx-calendar'></i> {{ job.posted_at|timesince }} ago</span>
            </div>
        </div>
    </div>

    <div class="jd-actions">
        {% if not already_applied %}
        <button id="jdApplyBtn" class="jd-btn jd-btn-primary"><i class='bx bx-send'></i> Apply Now</button>
        {% else %}
        <span class="jd-btn jd-btn-success"><i class='bx bx-check'></i> Applied</span>
        {% endif %}

        <a href="{% url 'resume_builder:resume_analyzer' job.id %}" class="jd-btn">
            <i class='bx bx-analyse'></i> Analyze Resume
        </a>
        <a href="{% url 'resume_builder:tailor_for_job' job.id %}" class="jd-btn">
            <i class='bx bx-bot'></i> AI Tailor Resume
        </a>

        <button id="jdBookmarkBtn" class="jd-btn {% if is_bookmarked %}jd-btn-primary{% endif %}" data-job-id="{{ job.id }}">
            <i class='bx {% if is_bookmarked %}bxs-bookmark{% else %}bx-bookmark{% endif %}'></i>
            {% if is_bookmarked %}Saved{% else %}Save{% endif %}
        </button>
        <button class="jd-btn" id="jdShareBtn"><i class='bx bx-share-alt'></i> Share</button>
    </div>
</div>

<!-- TWO-COLUMN GRID -->
<div class="jd-grid">
    <!-- Main Column -->
    <div>
        <!-- Skills & Your Fit -->
        {% if skill_requirements or job.skills %}
        <div class="jd-card" style="margin-bottom:1.25rem;">
            <div class="jd-card-head">
                <h3><i class='bx bx-target-lock'></i> Skills & Your Fit</h3>
                <span class="jd-status {% if match_score >= 70 %}jd-status-pass{% else %}jd-status-fail{% endif %}">
                    {{ match_score }}% Match
                </span>
            </div>
            <div class="jd-card-body">
                {% if skill_requirements %}
                <div class="jd-skill-list">
                    {% for s in verified_skills %}
                    <span class="jd-skill jd-skill-qualified">
                        <i class='bx bx-check-circle'></i> {{ s.skill.name }}
                        {% if s.skill_type == 'must_have' %}<span class="jd-skill-type jd-type-must">Must Have</span>{% endif %}
                    </span>
                    {% endfor %}

                    {% for s in partial_skills %}
                    <span class="jd-skill jd-skill-improve">
                        <i class='bx bx-up-arrow-alt'></i> {{ s.skill.name }}
                        {% if s.skill_type == 'must_have' %}<span class="jd-skill-type jd-type-must">Must Have</span>
                        {% elif s.skill_type == 'important' %}<span class="jd-skill-type jd-type-important">Important</span>{% endif %}
                    </span>
                    {% endfor %}

                    {% for s in missing_skills %}
                    <span class="jd-skill jd-skill-missing">
                        <i class='bx bx-x'></i> {{ s.skill.name }}
                        {% if s.is_mandatory %}<span class="jd-skill-type jd-type-must">Must Have</span>{% endif %}
                    </span>
                    {% endfor %}
                </div>

                <!-- Legend -->
                <div style="display:flex; gap:1rem; flex-wrap:wrap; margin-top:1rem; font-size:.75rem; color:var(--text-muted);">
                    <span style="display:flex;align-items:center;gap:.25rem;"><i class='bx bx-check-circle' style="color:#16a34a;"></i> Qualified</span>
                    <span style="display:flex;align-items:center;gap:.25rem;"><i class='bx bx-up-arrow-alt' style="color:#d97706;"></i> Needs Improvement</span>
                    <span style="display:flex;align-items:center;gap:.25rem;"><i class='bx bx-x' style="color:#dc2626;"></i> Not Verified</span>
                </div>

                {% elif job.skills %}
                <div class="jd-skill-list">
                    {% for skill_data in job.skills %}
                    <span class="jd-skill jd-skill-neutral">
                        {% if skill_data.name %}{{ skill_data.name }}{% else %}{{ skill_data }}{% endif %}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}

                {% if partial_skills or missing_skills %}
                <div class="jd-assess-banner">
                    <i class='bx bx-brain'></i>
                    <div class="jd-assess-text">
                        <h4>Verify your skills to boost your match</h4>
                        <p>Take quick assessments to prove your proficiency and stand out to recruiters.</p>
                    </div>
                    <a href="{% url 'assessments:job_skill_gap_analysis' job.id %}" class="jd-btn jd-btn-primary jd-btn-sm">
                        <i class='bx bx-play'></i> Start
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Job Description -->
        <div class="jd-card" style="margin-bottom:1.25rem;">
            <div class="jd-card-head"><h3><i class='bx bx-detail'></i> Job Description</h3></div>
            <div class="jd-card-body jd-prose">{{ job.description|linebreaks }}</div>
        </div>

        <!-- Requirements -->
        {% if job.requirements %}
        <div class="jd-card" style="margin-bottom:1.25rem;">
            <div class="jd-card-head"><h3><i class='bx bx-list-check'></i> Requirements</h3></div>
            <div class="jd-card-body jd-prose">{{ job.requirements|linebreaks }}</div>
        </div>
        {% endif %}

        <!-- About Company -->
        <div class="jd-card" style="margin-bottom:1.25rem;">
            <div class="jd-card-head"><h3><i class='bx bx-building'></i> About {{ job.company }}</h3></div>
            <div class="jd-card-body jd-prose">
                {% if company_description %}{{ company_description|linebreaks }}{% else %}<p>No company description available.</p>{% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="jd-sidebar">
        <!-- Match Overview -->
        <div class="jd-side-card">
            <div class="jd-side-head"><i class='bx bx-analyse'></i> Your Match</div>
            <div class="jd-side-body">
                <div class="jd-match-ring">
                    <svg class="jd-ring-svg" viewBox="0 0 80 80">
                        <circle class="jd-ring-bg" cx="40" cy="40" r="34"/>
                        <circle class="jd-ring-fill {% if match_score >= 80 %}excellent{% elif match_score >= 60 %}good{% elif match_score >= 40 %}moderate{% else %}low{% endif %}"
                                cx="40" cy="40" r="34"
                                stroke-dasharray="213.6"
                                transform="rotate(-90 40 40)"
                                style="stroke-dashoffset: calc(213.6 - (213.6 * {{ match_score }} / 100))"/>
                        <text class="jd-ring-text" x="40" y="40">{{ match_score }}%</text>
                    </svg>
                    <div class="jd-ring-info">
                        <div class="jd-ring-pct">{% if match_score >= 80 %}Excellent{% elif match_score >= 60 %}Good{% elif match_score >= 40 %}Fair{% else %}Low{% endif %}</div>
                        <div class="jd-ring-label">{{ skills_qualified }} of {{ total_skills_required }} skills matched</div>
                    </div>
                </div>

                {% if matching_skills %}
                <div style="margin-top:1rem;">
                    <div style="font-size:.78rem;font-weight:600;color:var(--text-muted);margin-bottom:.4rem;text-transform:uppercase;letter-spacing:.3px;">Qualified Skills</div>
                    <div class="jd-stag-list">
                        {% for name in matching_skills %}
                        <span class="jd-stag jd-stag-match"><i class='bx bx-check'></i> {{ name }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if skills_to_develop %}
                <div style="margin-top:1rem;">
                    <div style="font-size:.78rem;font-weight:600;color:var(--text-muted);margin-bottom:.4rem;text-transform:uppercase;letter-spacing:.3px;">Needs Work</div>
                    <div class="jd-stag-list">
                        {% for skill in skills_to_develop %}
                        <span class="jd-stag jd-stag-gap">{{ skill.name }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <div style="margin-top:1.15rem; padding-top:1rem; border-top:1px solid var(--border-color);">
                    <a href="{% url 'assessments:job_skill_gap_analysis' job.id %}" class="jd-btn jd-btn-primary" style="width:100%;justify-content:center;">
                        <i class='bx bx-bar-chart'></i> Full Skill Analysis
                    </a>
                </div>
            </div>
        </div>

        {% if similar_jobs %}
        <div class="jd-side-card">
            <div class="jd-side-head"><i class='bx bx-list-ul'></i> Similar Jobs</div>
            <div class="jd-side-body" style="padding:.75rem;">
                {% for sj in similar_jobs %}
                <a href="{% url 'jobs:job_detail' sj.id %}" class="jd-sim-item">
                    <div class="jd-sim-info">
                        <h4>{{ sj.title }}</h4>
                        <div class="jd-sim-meta">
                            <span><i class='bx bx-buildings'></i> {{ sj.company }}</span>
                            <span><i class='bx bx-map'></i> {{ sj.location }}</span>
                        </div>
                    </div>
                    <i class='bx bx-chevron-right jd-sim-arrow'></i>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- APPLICATION MODAL -->
<div id="jdApplyModal" class="jd-modal">
    <div class="jd-modal-box">
        <div class="jd-modal-head">
            <h2>Apply for {{ job.title }}</h2>
            <button class="jd-modal-close" data-close><i class='bx bx-x'></i></button>
        </div>
        <div class="jd-modal-body">
            <form action="{% url 'jobs:apply_for_job' job.id %}" method="post" id="jdApplyForm">
                {% csrf_token %}

                <div class="jd-form-group">
                    <label>Cover Letter</label>
                    <textarea name="cover_letter" placeholder="Tell the employer why you're a great fit..."></textarea>
                    <div class="jd-form-hint">A strong cover letter personalised to the role really helps.</div>
                </div>

                <div class="jd-form-group">
                    <label>Select Resume</label>
                    {% if user_resumes or tailored_resumes %}
                    <div class="jd-resume-list">
                        {% for tr in tailored_resumes %}
                        <label class="jd-resume-opt" style="border-color:var(--primary-color);background:rgba(79,70,229,.03);">
                            <input type="radio" name="tailored_resume_id" value="{{ tr.id }}" {% if forloop.first and not user_resumes %}checked{% endif %} onchange="document.querySelectorAll('input[name=resume_id]').forEach(r=>r.checked=false)">
                            <i class='bx bx-bot jd-resume-icon' style="color:#7c3aed;"></i>
                            <div class="jd-resume-meta">
                                <strong>AI Tailored for {{ tr.job.title|truncatewords:5 }}</strong>
                                <small>{{ tr.match_score_after }}% match &middot; {{ tr.updated_at|timesince }} ago</small>
                            </div>
                            <i class='bx bx-check-circle jd-resume-check'></i>
                        </label>
                        {% endfor %}
                        {% for resume in user_resumes %}
                        <label class="jd-resume-opt">
                            <input type="radio" name="resume_id" value="{{ resume.id }}" {% if forloop.first and not tailored_resumes %}checked{% endif %} onchange="document.querySelectorAll('input[name=tailored_resume_id]').forEach(r=>r.checked=false)">
                            <i class='bx bx-file jd-resume-icon'></i>
                            <div class="jd-resume-meta">
                                <strong>{{ resume.title }}</strong>
                                <small>Updated {{ resume.updated_at|timesince }} ago</small>
                            </div>
                            <i class='bx bx-check-circle jd-resume-check'></i>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="jd-form-hint">
                        Pick a resume from your account.
                        <a href="{% url 'resume_builder:resume_builder' %}" target="_blank">Create new</a>
                        {% if not tailored_resumes %}
                        &middot; <a href="{% url 'resume_builder:tailor_for_job' job.id %}" target="_blank">AI Tailor for this job</a>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="jd-no-resume">
                        <i class='bx bx-info-circle'></i>
                        <div>
                            <p style="margin:0 0 .4rem;">No resumes yet.</p>
                            <a href="{% url 'resume_builder:resume_builder' %}" class="jd-btn jd-btn-sm" target="_blank">
                                <i class='bx bx-plus'></i> Create Resume
                            </a>
                            <a href="{% url 'resume_builder:tailor_for_job' job.id %}" class="jd-btn jd-btn-sm" target="_blank" style="margin-left:.5rem;">
                                <i class='bx bx-bot'></i> AI Tailor
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="jd-summary">
                    <h4>Quick Summary</h4>
                    <div class="jd-summary-row"><i class='bx bx-check-circle green'></i> Profile matches <strong>{{ match_score }}%</strong> of requirements</div>
                    <div class="jd-summary-row"><i class='bx bx-check-circle green'></i> <strong>{{ matching_skills|length }}</strong> skills qualified</div>
                    {% if skills_to_develop %}
                    <div class="jd-summary-row"><i class='bx bx-info-circle amber'></i> <strong>{{ skills_to_develop|length }}</strong> skills need work</div>
                    {% endif %}
                </div>
            </form>
        </div>
        <div class="jd-modal-foot">
            <button class="jd-btn" data-close>Cancel</button>
            <button type="submit" form="jdApplyForm" class="jd-btn jd-btn-primary" {% if not user_resumes and not tailored_resumes %}disabled title="Create a resume first"{% endif %}>
                <i class='bx bx-send'></i> Submit Application
            </button>
        </div>
    </div>
</div>

<!-- SHARE MODAL -->
<div id="jdShareModal" class="jd-modal">
    <div class="jd-modal-box" style="max-width:420px;">
        <div class="jd-modal-head">
            <h2>Share This Job</h2>
            <button class="jd-modal-close" data-close><i class='bx bx-x'></i></button>
        </div>
        <div class="jd-modal-body">
            <div class="jd-share-link">
                <input type="text" id="jdShareLink" value="{{ request.build_absolute_uri }}" readonly>
                <button class="jd-btn jd-btn-sm" id="jdCopyLink"><i class='bx bx-copy'></i> Copy</button>
            </div>
            <div class="jd-share-btns">
                <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri|urlencode }}" target="_blank" class="jd-share-btn linkedin">
                    <i class='bx bxl-linkedin'></i> LinkedIn
                </a>
                <a href="https://twitter.com/intent/tweet?text={{ job.title|urlencode }}%20at%20{{ job.company|urlencode }}&url={{ request.build_absolute_uri|urlencode }}" target="_blank" class="jd-share-btn twitter">
                    <i class='bx bxl-twitter'></i> Twitter
                </a>
                <a href="mailto:?subject=Job:%20{{ job.title|urlencode }}&body={{ request.build_absolute_uri|urlencode }}" class="jd-share-btn email">
                    <i class='bx bx-envelope'></i> Email
                </a>
            </div>
        </div>
    </div>
</div>

<!-- JAVASCRIPT -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    function openModal(el) { el.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
    function closeModal(el) { el.style.display = 'none'; document.body.style.overflow = ''; }

    const applyModal = document.getElementById('jdApplyModal');
    const shareModal = document.getElementById('jdShareModal');

    document.getElementById('jdApplyBtn')?.addEventListener('click', () => openModal(applyModal));
    document.getElementById('jdShareBtn')?.addEventListener('click', () => openModal(shareModal));

    document.querySelectorAll('[data-close]').forEach(b => {
        b.addEventListener('click', () => { closeModal(applyModal); closeModal(shareModal); });
    });
    [applyModal, shareModal].forEach(m => {
        m?.addEventListener('click', e => { if (e.target === m) closeModal(m); });
    });

    document.getElementById('jdCopyLink')?.addEventListener('click', function() {
        const inp = document.getElementById('jdShareLink');
        inp.select(); document.execCommand('copy');
        this.innerHTML = '<i class="bx bx-check"></i> Copied!';
        setTimeout(() => { this.innerHTML = '<i class="bx bx-copy"></i> Copy'; }, 2000);
    });

    const bmBtn = document.getElementById('jdBookmarkBtn');
    bmBtn?.addEventListener('click', function() {
        const jobId = this.dataset.jobId;
        const isBookmarked = this.classList.contains('jd-btn-primary');
        fetch('/jobs/bookmark/' + jobId + '/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ action: isBookmarked ? 'unbookmark' : 'bookmark' })
        })
        .then(r => r.json())
        .then(d => {
            if (d.status === 'success') {
                this.classList.toggle('jd-btn-primary');
                const icon = this.querySelector('i');
                if (isBookmarked) { icon.className = 'bx bx-bookmark'; this.lastChild.textContent = ' Save'; }
                else { icon.className = 'bx bxs-bookmark'; this.lastChild.textContent = ' Saved'; }
            }
        }).catch(() => {});
    });

    document.getElementById('jdApplyForm')?.addEventListener('submit', function(e) {
        const btn = document.querySelector('[form="jdApplyForm"][type="submit"]');
        btn.disabled = true;
        btn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Submitting...';
    });

    function getCookie(name) {
        const cookies = document.cookie.split(';');
        for (let c of cookies) {
            c = c.trim();
            if (c.startsWith(name + '=')) return decodeURIComponent(c.substring(name.length + 1));
        }
        return null;
    }
});

/* Reload page when user navigates back (bfcache) so dynamic state is fresh */
window.addEventListener('pageshow', function(e) {
    if (e.persisted) window.location.reload();
});
</script>
{% endblock %}
